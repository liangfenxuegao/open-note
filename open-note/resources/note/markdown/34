# å¼€æºç¬”è®°-è®¸å¯

**ç‰ˆæœ¬ï¼š1.1**

**å‘å¸ƒäº2020å¹´4æœˆ**

**ä½¿ç”¨ã€å¤åˆ¶å’Œåˆ†å‘çš„å­æ¡æ¬¾ï¼š**

*æ³¨é‡Šï¼šä½ å¯ä»¥ä¸ºä½œå“æ·»åŠ å­æ¡æ¬¾ã€‚è¯¦è§çˆ¶æ¡æ¬¾ç¬¬å››æ¡ã€‚*

**ä½¿ç”¨ã€å¤åˆ¶å’Œåˆ†å‘çš„çˆ¶æ¡æ¬¾ï¼š**

1. æ ¹æ®æœ¬è®¸å¯çš„æ¡æ¬¾å’Œæ¡ä»¶ï¼Œæ¯ä½è´¡çŒ®è€…åœ¨æ­¤æˆäºˆæ‚¨æ°¸ä¹…ã€å…¨ä¸–ç•Œã€éæ’ä»–æ€§ã€å…è´¹ã€å…ç‰ˆç¨ã€ä¸å¯æ’¤é”€çš„ç‰ˆæƒè®¸å¯ï¼Œç”¨ä»¥å¤åˆ¶ã€è¡ç”Ÿã€å…¬å¼€å±•ç¤ºã€å…¬å¼€è¡¨æ¼”ã€è½¬æˆè®¸å¯è¯ï¼Œå¹¶ä»¥æºå½¢å¼æˆ–ç›®æ ‡å½¢å¼åˆ†å‘ä½œå“å’Œæ­¤ç±»è¡ç”Ÿä½œå“ã€‚
2. ä½¿ç”¨ã€å¤åˆ¶å’Œåˆ†å‘å¼€æºç¬”è®°è®¸å¯å‘è¡Œçš„ä½œå“æ—¶ï¼Œå¿…é¡»æºå¸¦å¼€æºç¬”è®°è®¸å¯ã€‚å…è®¸ä¸ºé“¾æ¥æ–¹å¼æºå¸¦ã€‚
3. ä¸€æ—¦æ‚¨åœ¨å•†ä¸šæ€§è´¨ä½œå“ä¸­ä½¿ç”¨äº†å¼€æºç¬”è®°è®¸å¯å‘è¡Œçš„ä½œå“ï¼Œæ‚¨å¿…é¡»è¡¨ç¤ºæ„Ÿè°¢ï¼Œå°¤å…¶æ˜¯å¯¹è¯¥ä½œå“ä¸»è¦è´¡çŒ®è€…çš„æ„Ÿè°¢ã€‚å½“å¼€æºç¬”è®°è®¸å¯å‘è¡Œçš„ä½œå“ä¸ºä½ äº§ç”Ÿè‰¯å¥½æ•ˆç›Šæ—¶ï¼Œé¼“åŠ±æ‚¨ä¸ºç”¨åˆ°çš„ä½œå“è´¡çŒ®è€…ä»¬ã€å¼€æºç¬”è®°ç»„ç»‡æèµ ï¼Œä½†è¿™ç»éå¼ºåˆ¶æ€§çš„ã€‚
4. æ‚¨å¯ä»¥ä¸ºä½œå“æ·»åŠ å­è®¸å¯æ¡æ¬¾ï¼Œä¸”å­æ¡æ¬¾å¿…é¡»å†™åœ¨çˆ¶æ¡æ¬¾å‰ã€‚æ³¨æ„æ‚¨ä¸å¯ä¿®æ”¹çˆ¶æ¡æ¬¾ï¼Œå¦åˆ™æœ¬è®¸å¯è‡ªåŠ¨ä½œåºŸï¼Œæ‚¨å°†ä¸èƒ½ä½¿ç”¨ä»»ä½•ç”±å¼€æºç¬”è®°è®¸å¯å‘è¡Œçš„ä½œå“ã€‚å­æ¡æ¬¾ä¸å¯ä¸çˆ¶æ¡æ¬¾å†²çªã€‚
5. æ‚¨å¯åœ¨éçº¦æŸæ¡æ–‡ä¸­æ·»åŠ ä½œå“è´¡çŒ®è€…ã€å¤‡æ³¨ã€ä½¿ç”¨è¯´æ˜ä¹¦ã€å¼•ç”¨èµ„æ–™ç­‰æ–‡æœ¬ï¼Œä½†ä¸å¯å‡ºç°ä»¥å¼€æºç¬”è®°è®¸å¯ä¸ºåä¹‰çš„çº¦æŸæ€§æ¡æ¬¾ï¼Œå®ƒä»¬ä¸å±äºå¼€æºç¬”è®°è®¸å¯ï¼Œå¼€æºç¬”è®°è®¸å¯ä¸å¯¹è¿™äº›å†…å®¹è´Ÿè´£ï¼Œå¯¹äºå±äºå¼€æºç¬”è®°çš„çº¦æŸæ¡æ¬¾åº”å½“å†™åœ¨å­æ¡æ¬¾åŒºã€‚
6. å½“æ‚¨ä½¿ç”¨äº†å…¶å®ƒè®¸å‘è¡Œçš„ä½œå“ï¼Œè¯·ç¡®ä¿å…¶å¯¹å…¶å®ƒè®¸å¯ï¼Œå°¤å…¶æ˜¯å¯¹æœ¬è®¸å¯å‹å¥½ï¼Œä¸ä¸æœ¬è®¸å¯æ¡æ¬¾å†²çªã€‚åŠ å…¥çš„è®¸å¯ä¸åº”å½“æ˜¯æ±¡æŸ“æ€§çš„ï¼Œä¾‹å¦‚GPLã€‚ä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶æ—¶æ‚¨ä¸åº”å½“åŠ å…¥å…¶å®ƒè®¸å¯ï¼Œæˆ–ä¸å¯¹ä½¿ç”¨åˆ°è¿™ç±»è®¸å¯çš„ä½œå“é™„ä¸Šå¼€æºç¬”è®°è®¸å¯ã€‚

**éçº¦æŸæ¡æ–‡ï¼š**

*æ³¨é‡Šï¼šä½ å¯ä»¥ä¸ºä½œå“æ·»åŠ éçº¦æŸæ¡æ–‡ã€‚è¯¦è§çˆ¶æ¡æ¬¾ç¬¬äº”æ¡ã€‚*

1. æœ¬ç¬”è®°ä¾æ®å°šç¡…è°·çš„ã€Šå°šç¡…è°·SpringBootæ•´åˆæ•™ç¨‹(springbootæ¡†æ¶å®æˆ˜)ã€‹ç”±ä¸¤ä»½é›ªç³•åˆ›å»ºé¦–ç‰ˆï¼Œç‰ˆå·1.0.0ã€‚è¯¥æ•™ç¨‹åœ¨å“”å“©å“”å“©çš„è§†é¢‘è¿æ¥ï¼šhttps://www.bilibili.com/video/BV1KW411F7oX

2. å»ºè®®å­¦ä¹ å‰æœ‰SpringBootåŸºç¡€ã€‚

3. æœ¬ç¬”è®°çš„å¼€å‘ç¯å¢ƒï¼šIntelliJ IDEAå·¥å…·ï¼ŒWindows10ç³»ç»Ÿã€‚

4. æœ¬æ–‡å¤åˆ¶äº†éƒ¨åˆ†ä½¿ç”¨Apache2.0è®¸å¯çš„å†…å®¹ï¼Œç‰¹å°†è®¸å¯åˆ—äºæ­¤ï¼š

   ```
   Copyright 2002-2015 the original author or authors.
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at
        https://www.apache.org/licenses/LICENSE-2.0
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
   ```
   
5. éƒ¨åˆ†å¤åˆ¶äºå…¶å®ƒä½ç½®çš„èµ„æ–™è‹¥æ²¡æœ‰åœ¨æ­£æ–‡ç»™å‡ºè¿æ¥ï¼Œåˆ™æ˜¯åœ¨æœ¬æ–‡æœ€åçš„â€œå‚è€ƒæ–‡çŒ®â€ä¸­è´´å‡ºã€‚

# ä¸€ã€ç¼“å­˜

## 1.1 JSR107ç®€ä»‹

Java Cachingå®šä¹‰äº†äº”ä¸ªæ ¸å¿ƒæ¥å£ï¼Œåˆ†åˆ«æ˜¯CachingProviderã€CacheManagerã€Cacheã€Entryã€Expiryã€‚

- CachingProviderå®šä¹‰äº†åˆ›å»ºã€é…ç½®ã€è·å–ã€ç®¡ç†å’Œæ§åˆ¶å¤šä¸ªCacheManagerã€‚åº”ç”¨å¯åœ¨è¿è¡ŒæœŸé—´è®¿é—®å¤šä¸ªCachingProviderã€‚
- CacheMangerå®šä¹‰äº†åˆ›å»ºã€é…ç½®ã€è·å–ã€ç®¡ç†å’Œæ§åˆ¶å¤šä¸ªå”¯ä¸€å‘½åçš„Cacheï¼Œè¿™äº›Cacheæ‘å­å•Šä¸CacheManagerçš„ä¸Šä¸‹æ–‡ä¸­ã€‚ä¸€ä¸ªCacheManagerä»…è¢«ä¸€ä¸ªCachingProvideræ‰€æ‹¥æœ‰ã€‚
- Cacheæ˜¯ç±»ä¼¼äºMapçš„æ•°æ®ç»“æ„å¹¶ä¸´æ—¶å‚¨å­˜ä»¥Keyä¸ºç´¢å¼•çš„å€¼ã€‚ä¸€ä¸ªCacheä»…è¢«ä¸€ä¸ªCacheManageræ‰€æ‹¥æœ‰ã€‚
- Entryæ˜¯å‚¨å­˜åœ¨Cacheä¸­çš„é”®å€¼å¯¹ã€‚
- Expiryæ¯ä¸ªå‚¨å­˜åœ¨Cacheä¸­çš„æ¡ç›®éƒ½æœ‰æœ‰æ•ˆæœŸï¼Œè¶…å‡ºè¯¥æ—¶é—´å°†ä¸ºè¿‡æœŸçŠ¶æ€ã€‚è¿‡æœŸåæ¡ç›®å°†ä¸å¯è®¿é—®ã€æ›´æ–°å’Œåˆ é™¤ã€‚ç¼“å­˜æœ‰æ•ˆæœŸå¯é€šè¿‡ExpiryPolicyè®¾ç½®ã€‚

å›¾ç¤ºï¼š

<img src="SpringBootAdvanced.assets\image-20200324215126551.png" alt="image-20200324215126551" style="zoom: 67%;" />

è¦ä½¿ç”¨JSP107éœ€è¦å¯¼å…¥javax.cache.cache-apiåŒ…ã€‚

## 1.2 Springç¼“å­˜æŠ½è±¡ç®€ä»‹

Springä»3.1å¼€å§‹å®šä¹‰äº†org.springframework.cache.Cacheå’Œorg.springframework.cache.CacheManageræ¥å£æ¥ç»Ÿä¸€ä¸åŒçš„ç¼“å­˜æŠ€æœ¯ï¼Œå¹¶æ”¯æŒä½¿ç”¨JCacheï¼ˆJSR-107ï¼‰æ³¨è§£æ¥ç®€åŒ–å¼€å‘ã€‚

- Cacheæ¥å£ä¸ºç¼“å­˜çš„ç»„ä»¶è§„èŒƒå®šä¹‰ï¼ŒåŒ…å«ç¼“å­˜çš„å„ç§æ“ä½œé›†åˆã€‚
- Cacheæ¥å£ä¸‹Springæä¾›äº†å„ç§xxxCacheçš„å®ç°ï¼Œå¦‚RedisCacheã€EhCacheCacheã€ConcurrentMapCacheç­‰ã€‚
- æ¯æ¬¡è°ƒç”¨éœ€è¦ç¼“å­˜åŠŸèƒ½çš„æ–¹æ³•æ—¶ï¼ŒSpringä¼šæ£€æŸ¥å‚æ•°æŒ‡å®šçš„ç›®æ ‡æ–¹æ³•æ˜¯å¦å·²ç»è¢«è°ƒç”¨è¿‡ï¼Œå¦‚æœæœ‰å°±ç›´æ¥ä»ç¼“å­˜ä¸­è·å–æ–¹æ³•è°ƒç”¨åçš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰å°±è°ƒç”¨æ–¹æ³•å¹¶ç¼“å­˜ç»“æœåè¿”å›ç»™ç”¨æˆ·ï¼Œå†ä¸‹æ¬¡è°ƒç”¨åˆç›´æ¥ä»ç¼“å­˜ä¸­è·å–ã€‚
- ä½¿ç”¨Springç¼“å­˜æŠ½è±¡æ—¶æˆ‘ä»¬éœ€è¦å…³æ³¨ä»¥ä¸‹ä¸¤ç‚¹ã€‚
  - ç¡®å®šæ–¹æ³•éœ€è¦è¢«ç¼“å­˜ä»¥åŠä»–ä»¬çš„ç¼“å­˜ç­–ç•¥ã€‚
  - ä»ç¼“å­˜ä¸­è¯»å–ä¹‹å‰ç¼“å­˜å­˜å‚¨çš„æ•°æ®ã€‚

å‡ ä¸ªé‡è¦æ¦‚å¿µå’Œç¼“å­˜æ³¨è§£ï¼š

| æ¦‚å¿µ           | æè¿°                                                         |
| -------------- | ------------------------------------------------------------ |
| Cache          | ç¼“å­˜æ¥å£ï¼Œå®šä¹‰ç¼“å­˜æ“ä½œã€‚å®ç°æœ‰ï¼šRedisCacheã€EhCacheCacheã€ConcurrentMapCacheç­‰ã€‚ |
| CacheManager   | ç¼“å­˜ç®¡ç†å™¨ï¼Œç®¡ç†å„ç§ç¼“å­˜ï¼ˆCacheï¼‰ç»„ä»¶ã€‚                      |
| @Cacheable     | ä¸»è¦é’ˆå¯¹æ–¹æ³•é…ç½®ï¼Œèƒ½å¤Ÿæ ¹æ®æ–¹æ³•çš„è¯·æ±‚å‚æ•°å¯¹å…¶ç»“æœè¿›è¡Œç¼“å­˜ã€‚   |
| @CacheEvic     | æ¸…ç©ºç¼“å­˜ã€‚                                                   |
| @CachePut      | ä¿è¯æ–¹æ³•è¢«è°ƒç”¨ï¼Œåˆå¸Œæœ›ç»“æœè¢«ç¼“å­˜ã€‚                           |
| @EnableCaching | å¼€å¯åŸºäºæ³¨è§£çš„ç¼“å­˜ã€‚                                         |
| keyGenerator   | ç¼“å­˜æ•°æ®æ—¶keyç”Ÿæˆç­–ç•¥                                        |
| serialize      | ç¼“å­˜æ•°æ®æ—¶valueåºåˆ—åŒ–ç­–ç•¥                                    |

å›¾ç¤ºï¼š

![image-20200326205217800](SpringBootAdvanced.assets\image-20200326205217800.png)

## 1.3 åŸºæœ¬ç¯å¢ƒæ­å»º

**åˆ›å»ºä¸ªæ–°é¡¹ç›®ï¼š**

![image-20200326155324087](SpringBootAdvanced.assets\image-20200326155324087.png)

**é€‰æ‹©éœ€è¦çš„åœºæ™¯ï¼š**

<img src="SpringBootAdvanced.assets\image-20200326155834576.png" alt="image-20200326155834576" style="zoom:80%;" />

**ç”Ÿæˆdepartmentå’Œemployeeä¸¤å¼ è¡¨ï¼š**

è¿è¡Œä¸‹é¢çš„.sqlæ–‡ä»¶ï¼Œä¼šåœ¨æ•°æ®åº“ä¸­ç”Ÿæˆdepartmentå’Œemployeeä¸¤å¼ è¡¨ï¼š

```mysql
/*
Target Server Type    : MYSQL
Target Server Version : 50528
File Encoding         : 65001

Date: 2018-04-27 14:54:04
*/

SET FOREIGN_KEY_CHECKS=0;

-- ----------------------------
-- Table structure for department
-- ----------------------------
DROP TABLE IF EXISTS `department`;
CREATE TABLE `department` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `departmentName` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Table structure for employee
-- ----------------------------
DROP TABLE IF EXISTS `employee`;
CREATE TABLE `employee` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `lastName` varchar(255) DEFAULT NULL,
  `email` varchar(255) DEFAULT NULL,
  `gender` int(2) DEFAULT NULL,
  `d_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

å¹¶å‘employeeè¡¨æ·»åŠ æ•°æ®(d_idæš‚æ—¶ä¸å¡«)ï¼š

![image-20200326185708809](SpringBootAdvanced.assets\image-20200326185708809.png)

**åˆ›å»ºJavaBeanå°è£…æ•°æ®ï¼š**

```java
package xuegao.learnSpringBoot.cache.bean;

public class Department {
	
	private Integer id;
	private String departmentName;
	
	public Department() {
		super();
	}

	public Department(Integer id, String departmentName) {
		super();
		this.id = id;
		this.departmentName = departmentName;
	}

	@Override
	public String toString() {
		return "Department [id=" + id + ", departmentName=" + departmentName + "]";
	}

	public Integer getId() {
		return id;
	}
	public void setId(Integer id) {
		this.id = id;
	}
	public String getDepartmentName() {
		return departmentName;
	}
	public void setDepartmentName(String departmentName) {
		this.departmentName = departmentName;
	}
}
```

```java
package xuegao.learnSpringBoot.cache.bean;

public class Employee {
   
   private Integer id;
   private String lastName;
   private String email;
   private Integer gender; //æ€§åˆ« 1ç”·  0å¥³
   private Integer dId;

   public Employee() {
      super();
   }

   public Employee(Integer id, String lastName, String email, Integer gender, Integer dId) {
      super();
      this.id = id;
      this.lastName = lastName;
      this.email = email;
      this.gender = gender;
      this.dId = dId;
   }

   @Override
   public String toString() {
      return "Employee [id=" + id + ", lastName=" + lastName + ", email=" + email + ", gender=" + gender + ", dId="
            + dId + "]";
   }

   public Integer getId() {
      return id;
   }
   public void setId(Integer id) {
      this.id = id;
   }
   public String getLastName() {
      return lastName;
   }
   public void setLastName(String lastName) {
      this.lastName = lastName;
   }
   public String getEmail() {
      return email;
   }
   public void setEmail(String email) {
      this.email = email;
   }
   public Integer getGender() {
      return gender;
   }
   public void setGender(Integer gender) {
      this.gender = gender;
   }
   public Integer getdId() {
      return dId;
   }
   public void setdId(Integer dId) {
      this.dId = dId;
   }
}
```

**æ•´åˆMyBatisæ¥æ“ä½œæ•°æ®åº“ï¼š**

é…ç½®æ•°æ®æºä¿¡æ¯ï¼ˆåœ¨SpringBoot Profileä¸­é…ç½®ï¼‰ï¼š

```properties
#é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯
    spring.datasource.url=jdbc:mysql://localhost:3306/spring_cache?serverTimezone=UTC
    spring.datasource.username=root
    spring.datasource.password=523142
    #driver-class-nameå¯çœç•¥ä¸å†™ï¼Œä¼šæ ¹æ®urlè‡ªåŠ¨åˆ¤æ–­éœ€è¦çš„é©±åŠ¨
        #spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
```

åˆ›å»ºEmployeeå’ŒDepartmentçš„Mapperæ¥å£ï¼š

```java
package xuegao.learnSpringBoot.cache.mapper;

import org.apache.ibatis.annotations.*;
import org.springframework.stereotype.Repository;
import xuegao.learnSpringBoot.cache.bean.Employee;

//å·²åœ¨ä¸»é…ç½®ç±»ä¸­ç”¨@MapperScanå°†æ¥å£æ‰«æåˆ°å®¹å™¨ä¸­
@Repository("employeeMapper")
public interface EmployeeMapper {

    @Select("SELECT * FROM employee WHERE id=#{id}")
    public Employee getEmployeeById(Integer id);

    @Update("UPDATE employee SET lastName=#{lastName},email=#{email},gender=#{gender},d_id=#{dId} WHERE id=#{id}")
    public void updateEmployee(Employee employee);

    @Options(useGeneratedKeys = true,keyProperty = "id")//å–å‡ºè‡ªå¢ä¸»é”®ï¼Œå¹¶ç»‘å®šåˆ°åˆ°employee.id
    @Insert("INSERT INTO employee(lastName,email,gender,d_id) VALUES (#{lastName},#{email},#{gender},#{dId})")//ç”±äºæ•°æ®åº“ä¸­å°†employeeè¡¨ä¸­çš„idè®¾ä¸ºè‡ªå¢ï¼Œæ‰€ä»¥æ— éœ€æä¾›idå€¼
    public void insertEmployee(Employee employee);

    @Delete("DELETE FROM employee WHERE id=#{id}")
    public void deleteEmployeeById(Integer id);
}
```

```java
package xuegao.learnSpringBoot.cache.mapper;

import org.apache.ibatis.annotations.*;
import org.springframework.stereotype.Repository;
import xuegao.learnSpringBoot.cache.bean.Department;

@Repository("departmentMapper")
public interface DepartmentMapper {
    @Select("select * from department where id=#{id}")
    public Department getDepartmentById(Integer id);

    @Delete("delete from department where id=#{id}")
    public void deleteDepartmentById(Integer id);

    @Options(useGeneratedKeys = true,keyProperty = "id")//å–å‡ºè‡ªå¢ä¸»é”®ï¼Œå¹¶ç»‘å®šåˆ°åˆ°Department.id
    @Insert("insert into department(departmentName) values(#{departmentName})")//ç”±äºæ•°æ®åº“ä¸­å°†departmentè¡¨ä¸­çš„idè®¾ä¸ºè‡ªå¢ï¼Œæ‰€ä»¥åªéœ€æä¾›éƒ¨é—¨å
    public void insertDepartment(Department department);

    @Update("update department set departmentName=#{departmentName} where id=#{id}")
    public void updateDepartment(Department department);
}
```

ä½¿ç”¨@MapperScanæŒ‡å®šéœ€è¦æ‰«æçš„Mapperæ¥å£æ‰€åœ¨çš„åŒ…ï¼ˆæ ‡æ³¨äºä¸»é…ç½®ç±»ï¼‰ï¼š

```java
@MapperScan(value = {"xuegao.learnSpringBoot.cache.mapper"})
@SpringBootApplication
public class CacheApplication {
    public static void main(String[] args) {
        SpringApplication.run(CacheApplication.class, args);
    }
}
```

æµ‹è¯•ä¸‹EmployeeMapperæ¥å£çš„getEmployeeByIdæ–¹æ³•(åœ¨å•å…ƒæµ‹è¯•ä¸­)ï¼š

```java
package xuegao.learnSpringBoot.cache;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import xuegao.learnSpringBoot.cache.bean.Employee;
import xuegao.learnSpringBoot.cache.mapper.EmployeeMapper;

import javax.annotation.Resource;

@SpringBootTest
class CacheApplicationTests {
    @Resource(name = "employeeMapper")
    EmployeeMapper employeeMapper;

    @Test
    void contextLoads() {
        Employee employee = employeeMapper.getEmployeeById(1);
        System.out.println(employee);
    }

}
```

æ§åˆ¶å°è¾“å‡ºï¼š

![image-20200326195913176](SpringBootAdvanced.assets\image-20200326195913176.png)

åˆ›å»ºEmployeeServiceï¼š

```java
package xuegao.learnSpringBoot.cache.service;

import org.springframework.stereotype.Service;
import xuegao.learnSpringBoot.cache.bean.Employee;
import xuegao.learnSpringBoot.cache.mapper.EmployeeMapper;

import javax.annotation.Resource;

@Service("employeeService")
public class EmployeeService {
    @Resource(name = "employeeMapper")
    EmployeeMapper employeeMapper;

    public Employee getEmployee(Integer id){
        Employee employee = employeeMapper.getEmployeeById(id);
        System.out.println("ç¼–å·ä¸º"+id+"çš„å‘˜å·¥ä¿¡æ¯ä¸ºï¼š"+employee);
        return employee;
    }

}
```

åˆ›å»ºEmployeeControllerï¼š

```java
package xuegao.learnSpringBoot.cache.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import xuegao.learnSpringBoot.cache.bean.Employee;
import xuegao.learnSpringBoot.cache.service.EmployeeService;

import javax.annotation.Resource;

@RestController
public class EmployeeController {
    @Resource(name = "employeeService")
    EmployeeService employeeService;

    @GetMapping("employee/{id}")
    public Employee getEmployee(@PathVariable("id") Integer id){
        return employeeService.getEmployee(id);
    }
}
```

å‘employeeè¡¨æ·»åŠ 2å·å‘˜å·¥ï¼Œæ³¨æ„æ·»åŠ äº†d_idçš„å€¼ï¼š

![image-20200326200437857](SpringBootAdvanced.assets\image-20200326200437857.png)

å¯åŠ¨é¡¹ç›®ï¼ŒæŸ¥è¯¢2å·å‘˜å·¥ï¼š

![image-20200326200745536](SpringBootAdvanced.assets\image-20200326200745536.png)

ä¼šå‘ç°dIdçš„å€¼ä¸ºnullï¼Œæ€ä¹ˆå›äº‹å‘¢ï¼Ÿè§‚å¯Ÿæ•°æ®åº“ä¸­employeeæ—¶å¯ä»¥å‘ç°,è¯¥è¡¨æ²¡æœ‰dIdï¼Œè€Œæ˜¯d_idï¼Œæ‰€ä»¥æ˜ å°„ä¸åˆ°Employeeæ¨¡å‹ä¸­ã€‚æ‰€ä»¥å»SpringBootå…¨å±€é…ç½®æ–‡ä»¶ä¸­å¼€å¯MyBatisçš„å…¨å±€é©¼å³°å‘½åæ˜ å°„ï¼š

```properties
#å¼€å¯MyBatisçš„å…¨å±€é©¼å³°å‘½åæ˜ å°„
mybatis.configuration.map-underscore-to-camel-case=true
```

é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œåˆ·æ–°é¡µé¢dIdå°±æœ‰å€¼å•¦ï¼š

![image-20200326201909532](SpringBootAdvanced.assets\image-20200326201909532.png)

## 1.4 @Cacheableåˆä½“éªŒ

æœªä½¿ç”¨ç¼“å­˜æ—¶æ¯æ¬¡å‘èµ·æŸ¥è¯¢éƒ½è¦å†æ¬¡å‘é€SQLå‘½ä»¤ï¼Œå¯ä»¥å¼€å¯æ—¥å¿—æŸ¥çœ‹ä¸€ä¸‹ï¼ˆåœ¨application.propertiesä¸­ï¼‰ï¼š

```properties
#å¼€å¯xuegao.learnSpringBoot.cache.mapperä¸‹çš„æ—¥å¿—
logging.level.xuegao.learnSpringBoot.cache.mapper=debug
```

é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œç„¶åå¤šåˆ·æ–°å‡ æ¬¡æµè§ˆå™¨é¡µé¢ï¼ˆç›¸å½“äºå¤šæ¬¡å‘é€æŸ¥è¯¢è¯·æ±‚ï¼‰ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ç¡®å®å¤šæ¬¡å‘é€äº†SQLè¯­å¥ï¼š

![image-20200326233023447](SpringBootAdvanced.assets\image-20200326233023447.png)

åœ¨ä¸»é…ç½®ç±»ä¸Šæ ‡æ³¨@EnableCachingèƒ½å¼€å¯åŸºäºæ³¨è§£çš„ç¼“å­˜æœºåˆ¶ï¼š

```java
@EnableCaching//å¼€å¯åŸºäºæ³¨è§£çš„ç¼“å­˜æœºåˆ¶
@MapperScan(value = {"xuegao.learnSpringBoot.cache.mapper"})
@SpringBootApplication
public class CacheApplication {
```

ä½¿ç”¨@Cacheableæ³¨è§£çš„æ–¹æ³•ï¼Œå…¶è¿è¡Œç»“æœå°†è¢«ç¼“å­˜ï¼š

```java
@Service("employeeService")
public class EmployeeService {

    @Resource(name = "employeeMapper")
    EmployeeMapper employeeMapper;

    /*
    @Cacheableç”¨äºå°†æ–¹æ³•çš„è¿è¡Œç»“æœç¼“å­˜ä¹‹ã€‚
    CacheManagerç®¡ç†å¤šä¸ªCacheç»„ä»¶ï¼Œå¯¹ç¼“å­˜çœŸæ­£çš„å¢åˆ æ”¹æŸ¥æ“ä½œåœ¨Cacheä¸­ï¼Œæ¯ä¸ªç¼“å­˜ç»„ä»¶éƒ½æœ‰è‡ªå·±å”¯ä¸€çš„åå­—ã€‚
    @Cacheableä¸‹çš„å±æ€§ï¼š
        cacheNamesæˆ–valueï¼šæŒ‡å®šç¼“å­˜ç»„ä»¶çš„åç§°ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªã€‚
        keyï¼š
            ç¼“å­˜æ•°æ®ä¼šå¯¹åº”ç”Ÿæˆkeyï¼Œé»˜è®¤ä¸ºæ–¹æ³•æ‰€æœ‰å‚æ•°å€¼è¿›è¡Œç»„åˆï¼Œ
            ä¾‹å¦‚ä¸‹é¢æ–¹æ³•ä¸­ä¼ å…¥id=1çš„è¯ï¼Œkeyå°±ä¸º1ã€‚keyæ”¯æŒSpELè¡¨è¾¾å¼ç¼–å†™ã€‚
            å¦å¤–#idã€#a0ã€#p0ã€#root.args[0]éƒ½ä¼šå–åˆ°åŒä¸ªå€¼ã€‚
        keyGeneratorï¼škeyç”Ÿæˆå™¨ï¼Œå¯ä»¥è‡ªè¡ŒæŒ‡å®škeyç”Ÿæˆå™¨çš„ç»„ä»¶idã€‚å’Œkeyæ˜¯äºŒé€‰ä¸€çš„å…³ç³»ã€‚
        cacheManagerï¼šæŒ‡å®šç¼“å­˜ç®¡ç†å™¨ã€‚
        cacheResolverï¼šæŒ‡å®šè·å–è§£æå™¨ã€‚å’ŒcacheManageræ˜¯äºŒé€‰ä¸€çš„å…³ç³»ã€‚
        conditionï¼šæ»¡è¶³æ¡ä»¶æ—¶ä¼šç¼“å­˜ã€‚
        unlessï¼šæ»¡è¶³æ¡ä»¶æ—¶ä¸ç¼“å­˜ã€‚SpELå¼"result == null"è¡¨ç¤ºæ–¹æ³•æ‰§è¡Œåçš„è¿”å›å€¼ä¸ºç©ºæ—¶ä¸ç¼“å­˜ç»“æœã€‚
        syncï¼šæ˜¯å¦ä½¿ç”¨å¼‚æ­¥æ¨¡å¼ã€‚è¦æ³¨æ„çš„æ˜¯å¯ç”¨å¼‚æ­¥æ¨¡å¼åå°†ä¸æ”¯æŒunlesså±æ€§ã€‚
    */
    //@Cacheable(cacheNames = {"employee","temp"},key = "#id",condition = "#id>0",unless = "#result == null")
    @Cacheable(cacheNames = {"employee"},keyGenerator = "myKeyGenerator")
    public Employee getEmployee(Integer id){
        Employee employee = employeeMapper.getEmployeeById(id);
        System.out.println("ç¼–å·ä¸º"+id+"çš„å‘˜å·¥ä¿¡æ¯ä¸ºï¼š"+employee);
        return employee;
    }
}
```

é‡æ–°å¯åŠ¨é¡¹ç›®ï¼Œå‘é€æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯è¯·æ±‚ï¼Œå¤šåˆ·æ–°å‡ æ¬¡ï¼š

![image-20200327193047737](SpringBootAdvanced.assets\image-20200327193047737.png)

ä¼šå‘ç°æ§åˆ¶å°åªæ‰“å°äº†ä¸€æ¬¡SQLæŸ¥è¯¢è¯­å¥ï¼Œè¯´æ˜ç¼“å­˜æˆåŠŸï¼š

![image-20200327193217247](SpringBootAdvanced.assets\image-20200327193217247.png)

@Cacheableã€@CachePutã€@CacheEvict çš„ä¸»è¦å‚æ•°ï¼š

| å‚æ•°                              | æè¿°                                                         | ç¤ºä¾‹                                                         |
| --------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| value                             | ç¼“å­˜çš„åç§°ï¼Œåœ¨ spring  é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè‡³å°‘æŒ‡å®šä¸€ä¸ª          | ä¾‹å¦‚ï¼š     @Cacheable(value=â€mycacheâ€) æˆ–è€…      @Cacheable(value={â€cache1â€,â€cache2â€} |
| key                               | ç¼“å­˜çš„  keyï¼Œå¯ä»¥ä¸ºç©ºï¼Œå¦‚æœæŒ‡å®šè¦æŒ‰ç…§  SpEL è¡¨è¾¾å¼ç¼–å†™ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™é»˜è®¤æŒ‰ç…§æ–¹æ³•çš„æ‰€æœ‰å‚æ•°è¿›è¡Œç»„åˆ | ä¾‹å¦‚ï¼š @Cacheable(value=â€testcacheâ€,key=â€#userNameâ€)         |
| condition                         | ç¼“å­˜çš„æ¡ä»¶ï¼Œå¯ä»¥ä¸ºç©ºï¼Œä½¿ç”¨  SpEL ç¼–å†™ï¼Œè¿”å›  true æˆ–è€… falseï¼Œåªæœ‰ä¸º  true æ‰è¿›è¡Œç¼“å­˜/æ¸…é™¤ç¼“å­˜ï¼Œåœ¨è°ƒç”¨æ–¹æ³•ä¹‹å‰ä¹‹åéƒ½èƒ½åˆ¤æ–­ | ä¾‹å¦‚ï¼š     @Cacheable(value=â€testcacheâ€, condition=â€#userName.length()>2â€) |
| allEntries  (@CacheEvict  )       | æ˜¯å¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å†…å®¹ï¼Œç¼ºçœä¸º  falseï¼Œå¦‚æœæŒ‡å®šä¸º trueï¼Œåˆ™æ–¹æ³•è°ƒç”¨åå°†ç«‹å³æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ | ä¾‹å¦‚ï¼š @CachEvict(value=â€testcacheâ€,allEntries=true)         |
| beforeInvocation  (@CacheEvict)   | æ˜¯å¦åœ¨æ–¹æ³•æ‰§è¡Œå‰å°±æ¸…ç©ºï¼Œç¼ºçœä¸º  falseï¼Œå¦‚æœæŒ‡å®šä¸º trueï¼Œåˆ™åœ¨æ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œçš„æ—¶å€™å°±æ¸…ç©ºç¼“å­˜ï¼Œç¼ºçœæƒ…å†µä¸‹ï¼Œå¦‚æœæ–¹æ³•æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ä¸ä¼šæ¸…ç©ºç¼“å­˜ | ä¾‹å¦‚ï¼š@CachEvict(value=â€testcacheâ€ï¼ŒbeforeInvocation=true)   |
| unless  (@CachePut)  (@Cacheable) | ç”¨äºå¦å†³ç¼“å­˜çš„ï¼Œä¸åƒconditionï¼Œè¯¥è¡¨è¾¾å¼åªåœ¨æ–¹æ³•æ‰§è¡Œä¹‹ååˆ¤æ–­ï¼Œæ­¤æ—¶å¯ä»¥æ‹¿åˆ°è¿”å›å€¼resultè¿›è¡Œåˆ¤æ–­ã€‚æ¡ä»¶ä¸ºtrueä¸ä¼šç¼“å­˜ï¼Œfasleæ‰ç¼“å­˜ | ä¾‹å¦‚ï¼š @Cacheable(value=â€testcacheâ€,unless=â€#result  == nullâ€) |

Cache SpEL available metadataï¼ˆç¼“å­˜SpELå¯ç”¨å…ƒæ•°æ®ï¼‰ï¼š

| **åå­—**      | **ä½ç½®**           | **æè¿°**                                                     | **ç¤ºä¾‹**             |
| ------------- | ------------------ | :----------------------------------------------------------- | -------------------- |
| methodName    | root object        | å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•å                                           | #root.methodName     |
| method        | root object        | å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•                                             | #root.method.name    |
| target        | root object        | å½“å‰è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡                                         | #root.target         |
| targetClass   | root object        | å½“å‰è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡ç±»                                       | #root.targetClass    |
| args          | root object        | å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°åˆ—è¡¨                                   | #root.args[0]        |
| caches        | root object        | å½“å‰æ–¹æ³•è°ƒç”¨ä½¿ç”¨çš„ç¼“å­˜åˆ—è¡¨ï¼ˆå¦‚@Cacheable(value={"cache1",  "cache2"})ï¼‰ï¼Œåˆ™æœ‰ä¸¤ä¸ªcache | #root.caches[0].name |
| argument name | evaluation context | æ–¹æ³•å‚æ•°çš„åå­—. å¯ä»¥ç›´æ¥ #å‚æ•°å ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ #p0æˆ–#a0 çš„å½¢å¼ï¼Œ0ä»£è¡¨å‚æ•°çš„ç´¢å¼•ï¼› | #iban ã€ #a0 ã€ #p0  |
| result        | evaluation context | æ–¹æ³•æ‰§è¡Œåçš„è¿”å›å€¼ï¼ˆä»…å½“æ–¹æ³•æ‰§è¡Œä¹‹åçš„åˆ¤æ–­æœ‰æ•ˆï¼Œå¦‚â€˜unlessâ€™ï¼Œâ€™cache putâ€™çš„è¡¨è¾¾å¼ â€™cache evictâ€™çš„è¡¨è¾¾å¼beforeInvocation=falseï¼‰ | #result              |

## 1.5 ç¼“å­˜å·¥ä½œåŸç†å’Œ@Cacheableè¿è¡Œæµç¨‹

**ç¼“å­˜å·¥ä½œåŸç†ï¼š**

1. è‡ªåŠ¨é…ç½®ç±»ï¼šorg.springframework.boot.autoconfigure.cache.CacheAutoConfigurationã€‚

2. ç¼“å­˜çš„é…ç½®ç±»ï¼š

   ```
   org.springframework.boot.autoconfigure.cache.GenericCacheConfiguration
   org.springframework.boot.autoconfigure.cache.JCacheCacheConfiguration
   org.springframework.boot.autoconfigure.cache.EhCacheCacheConfiguration
   org.springframework.boot.autoconfigure.cache.HazelcastCacheConfiguration
   org.springframework.boot.autoconfigure.cache.InfinispanCacheConfiguration
   org.springframework.boot.autoconfigure.cache.CouchbaseCacheConfiguration
   org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration
   org.springframework.boot.autoconfigure.cache.CaffeineCacheConfiguration
   org.springframework.boot.autoconfigure.cache.SimpleCacheConfiguration
   org.springframework.boot.autoconfigure.cache.NoOpCacheConfiguration
   ```

3. é»˜è®¤ç”Ÿæ•ˆçš„é…ç½®ç±»ï¼š

   åœ¨application.propertiesä¸­æ·»åŠ è¯¥é…ç½®ï¼š

   ```properties
   #å¼€å¯å…¨å±€debugçº§æ—¥å¿—
   debug=true
   ```

   åœ¨Consoleä¸­èƒ½æ‰¾åˆ°åªæœ‰SimpleCacheConfigurationç”Ÿæ•ˆã€‚æŸ¥çœ‹è¯¥ç±»æ„æˆï¼š

   ```java
   /**
    * Simplest cache configuration, usually used as a fallback.
    *
    * @author Stephane Nicoll
    */
   @Configuration(proxyBeanMethods = false)
   @ConditionalOnMissingBean(CacheManager.class)
   @Conditional(CacheCondition.class)
   class SimpleCacheConfiguration {
   
       //å‘å®¹å™¨æ³¨å†Œäº†ä¸ªConcurrentMapCacheManagerç±»çš„CacheManager
   	@Bean
   	ConcurrentMapCacheManager cacheManager(CacheProperties cacheProperties,
   			CacheManagerCustomizers cacheManagerCustomizers) {
   		ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager();
   		List<String> cacheNames = cacheProperties.getCacheNames();
   		if (!cacheNames.isEmpty()) {
   			cacheManager.setCacheNames(cacheNames);
   		}
   		return cacheManagerCustomizers.customize(cacheManager);
   	}
   
   }
   ```

4. å‘å‘å®¹å™¨æ³¨å†Œäº†ä¸ªConcurrentMapCacheManagerç±»çš„CacheManagerã€‚

5. å¯ä»¥è·å–å’Œåˆ›å»ºConcurrentMapCacheç±»çš„ç¼“å­˜ç»„ä»¶ ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†æ•°æ®ä¿å­˜åœ¨ConcurrentMapä¸­ã€‚

**è¿è¡Œæµç¨‹ï¼š**

1. æ–¹æ³•è¿è¡Œä¹‹å‰å…ˆå»æŸ¥è¯¢Cacheï¼ˆç¼“å­˜ç»„ä»¶ï¼‰ï¼ŒæŒ‰ç…§cahceNamesæŒ‡å®šçš„åç§°è·å–ï¼ˆCacheManagerå…ˆè·å–ç›¸åº”çš„ç¼“å­˜ï¼‰ã€‚é¦–æ¬¡è·å–ç¼“å­˜è‹¥æ²¡æœ‰Cacheç»„ä»¶åˆ™ä¼šè‡ªåŠ¨åˆ›å»ºCacheã€‚

2. ä½¿ç”¨keyå»CacheæŸ¥æ‰¾å¯¹åº”çš„ç¼“å­˜å†…å®¹ï¼Œé»˜è®¤ä¸ºæ–¹æ³•çš„å‚æ•°å€¼ã€‚keyæœ‰ç”Ÿæˆç­–ç•¥ï¼Œé»˜è®¤ä½¿ç”¨keyGeneratorç”Ÿæˆï¼ˆé»˜è®¤ç”±SimpleKeyGeneratorç±»å®ç°ï¼‰ã€‚

   ![image-20200327221537765](SpringBootAdvanced.assets\image-20200327221537765.png)

   SimpleKeyGeneratoré»˜è®¤çš„keyç”Ÿæˆç­–ç•¥ï¼š

   - æ— å‚æ•°æ—¶key = new SimpleKey()
   - å•å‚æ•°æ—¶key = å‚æ•°å€¼
   - å¤šå‚æ•°æ—¶key = new SimpleKey(params)

3. æ²¡æœ‰æŸ¥åˆ°ç›¸åº”ç¼“å­˜æ•°æ®æ—¶å°†è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å‘å‡ºSQLæŸ¥è¯¢å‘½ä»¤ã€‚

4. å°†æŸ¥è¯¢åˆ°çš„ç»“æœæ”¾è¿›ç¼“å­˜é‡Œã€‚ä¸‹å›¾æ˜¯org.springframework.cache.concurrent.ConcurrentMapCacheç±»é‡Œçš„æ–¹æ³•ï¼š

   ![image-20200327222454873](SpringBootAdvanced.assets\image-20200327222454873.png)

5. æ€»ç»“ä¸€ä¸‹å°±æ˜¯è¢«@Cacheableæ ‡æ³¨çš„æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œä¹‹å‰ä¼šå…ˆæ£€æŸ¥ç¼“å­˜ä¸­æœ‰æ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼Œé»˜è®¤å°†æ–¹æ³•çš„å‚æ•°å€¼åšä¸ºkeyå»æŸ¥è¯¢ï¼Œè‹¥æ— æ•°æ®å°±å°†è¿è¡ŒæŸ¥è¯¢æ–¹æ³•å¹¶å°†ç»“æœæ”¾å…¥ç¼“å­˜ï¼Œä»¥åå†æ¬¡æŸ¥è¯¢è¯¥keyå°±ç›´æ¥ä½¿ç”¨ç¼“å­˜ä¸­å¯¹åº”çš„æ•°æ®ã€‚

## 1.6 @Cacheableå…¶å®ƒå±æ€§

keyGeneratorï¼škeyç”Ÿæˆå™¨ï¼Œå¯ä»¥è‡ªè¡ŒæŒ‡å®škeyç”Ÿæˆå™¨çš„ç»„ä»¶idã€‚å’Œkeyæ˜¯äºŒé€‰ä¸€çš„å…³ç³»ã€‚

ä¸‹é¢åˆ›å»ºCacheé…ç½®ç±»æ¥æ‰‹å†™keyç”Ÿæˆå™¨ï¼š

```java
package xuegao.learnSpringBoot.cache.config;

import org.springframework.cache.interceptor.KeyGenerator;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.lang.reflect.Method;
import java.util.Arrays;

@Configuration
public class MyCacheConfig {

    @Bean("myKeyGenerator")//æ·»åŠ åˆ°IOCå®¹å™¨å¹¶å‘½åä¸ºmyKeyGeneratorï¼Œä¸å†™æ—¶é»˜è®¤ä¸ºæ–¹æ³•å
    public KeyGenerator keyGenerator(){
        return new KeyGenerator(){
            @Override
            public Object generate(Object target, Method method, Object... params) {
                //è‡ªå®šä¹‰æ‹¼ä¸²è§„åˆ™
                return method.getName()+Arrays.asList(params).toString();
            }
        };
    }
}
```

åœ¨éœ€è¦ç¼“å­˜çš„æ–¹æ³•ä¸Šä½¿ç”¨@Cacheableçš„keyGeneratorå±æ€§æŒ‡å®šä½¿ç”¨myKeyGeneratorï¼š

```java
@Cacheable(cacheNames = {"employee"},keyGenerator = "myKeyGenerator")
public Employee getEmployee(Integer id){
    Employee employee = employeeMapper.getEmployeeById(id);
    System.out.println("ç¼–å·ä¸º"+id+"çš„å‘˜å·¥ä¿¡æ¯ä¸ºï¼š"+employee);
    return employee;
}
```

é€šè¿‡Debugå¯ä»¥å‘ç°æ‹¼ä¸²æˆåŠŸï¼š

![image-20200328212410747](SpringBootAdvanced.assets\image-20200328212410747.png)

## 1.7 @CachePut

åœ¨EmployeeServiceç±»ä¸‹åˆ›å»ºupdateEmployeeæ–¹æ³•ï¼š

```java
/*
@CachePutï¼šä¿è¯æ–¹æ³•è¢«è°ƒç”¨ï¼Œåˆå¸Œæœ›ç»“æœè¢«ç¼“å­˜ã€‚
@CachePutè¿è¡Œæœºåˆ¶ï¼šå…ˆè°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼Œå†å°†ç›®æ ‡æ–¹æ³•çš„ç»“æœç¼“å­˜ã€‚
@CachePutä¸‹çš„å±æ€§ï¼š
    cacheNamesæˆ–valueï¼šè¿™é‡Œè®¾ä¸ºemployeeï¼Œå³å’Œå‰é¢çš„getEmployeeæ–¹æ³•å…±äº«ç¼“å­˜ã€‚
*/
@CachePut(cacheNames = {"employee"})
public Employee updateEmployee(Employee employee){
    employeeMapper.updateEmployee(employee);
    System.out.println("æ›´æ–°çš„å‘˜å·¥ä¿¡æ¯ä¸ºï¼š"+employee);
    return employee;
}
```

åœ¨EmployeeControllerç±»ä¸‹åˆ›å»ºupdateEmployeeæ–¹æ³•ï¼š

```java
@PostMapping("employeeUpdate")
public Employee updateEmployee(Employee employee){
    return employeeService.updateEmployee(employee);
}
```

åœ¨src/main/resources/staticç›®å½•ä¸‹åˆ›å»ºindex.htmlï¼š

```html
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>é¦–é¡µ</title>
</head>
<body>
    <form method="post" action="/employeeUpdate">
        ç¼–å·ï¼š<input name="id" type="number"><br>
        å§“æ°ï¼š<input name="lastName" type="text"><br>
        é‚®ç®±ï¼š<input name="email" type="email"><br>
        æ€§åˆ«ï¼š<input name="gender" type="number"><br>
        éƒ¨é—¨ï¼š<input name="dId" type="number"><br>
        <input type="submit" value="æäº¤">
    </form>
</body>
</html>
```

è¿™æ—¶å€™å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼Œå…ˆæŸ¥è¯¢employee id = 3çš„æƒ…å†µï¼Œæ˜¾ç„¶æ­¤æ—¶id = 3çš„å¯¹åº”æ•°æ®å°±ç¼“å­˜äº†ï¼Œå¤šåˆ·æ–°å‡ æ¬¡ä¹Ÿä¸ä¼šå†æ¬¡å‘é€SQLæŸ¥è¯¢è¯­å¥ï¼š

![image-20200329001628985](SpringBootAdvanced.assets\image-20200329001628985.png)

é‚£ä¹ˆæ­¤æ—¶æ›´æ–°ä¸‰å·å‘˜å·¥ï¼š

![image-20200329001955208](SpringBootAdvanced.assets\image-20200329001955208.png)

å†æŸ¥è¯¢employee id = 3çš„æƒ…å†µæ—¶ï¼Œå‘ç°æƒ…å†µä¸å¯¹äº†ï¼Œæ€ä¹ˆè¿˜æ˜¯ä¹‹å‰ç¼“å­˜çš„æ•°æ®ï¼Ÿ

==åŸå› åœ¨äºkeyï¼Œæ•°æ®æ˜¯é€šè¿‡é”®å€¼å¯¹çš„æ–¹å¼å­˜å…¥ç¼“å­˜çš„ï¼Œè€Œç›®å‰getEmployeeå’ŒupdateEmployeeä½¿ç”¨çš„keyæ˜¯ä¸ä¸€æ ·çš„ï¼Œå½“ç„¶äº’ç›¸ä¸å—å½±å“ã€‚==ç›®å‰updateEmployeeæ–¹æ³•ç¼“å­˜çš„keyä¸ºemployeeå¯¹è±¡ï¼Œå€¼ä¹Ÿæ˜¯employeeå¯¹è±¡ã€‚è€ŒgetEmployeeæ–¹æ³•ä¸ŠèŠ‚è®¾ä¸ºäº†keyGenerator = "myKeyGenerator"ï¼Œä¹Ÿå°±æ˜¯ç”±myKeyGeneratoræ¥ç”Ÿæˆkeyã€‚

æ‰€ä»¥è¦ä½¿ä¸¤è€…çš„keyç›¸ç­‰ï¼š

```java
@Cacheable(cacheNames = {"employee"},key = "#id")
public Employee getEmployee(Integer id){
    Employee employee = employeeMapper.getEmployeeById(id);
    System.out.println("ç¼–å·ä¸º"+id+"çš„å‘˜å·¥ä¿¡æ¯ä¸ºï¼š"+employee);
    return employee;
}

/*
keyï¼š
	ä¸ºäº†å’ŒgetEmployeeä½¿ç”¨åŒä¸ªkeyï¼Œå¯ç”¨#employee.idï¼ˆä»å…¥å‚ä¸­å–å€¼ï¼‰ã€
    #result.idï¼ˆä»è¿”å›å€¼ä¸­å–ï¼Œ@Cacheableæ³¨è§£ä¸é€‚ç”¨ï¼Œå› ä¸ºå…¶åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰å°±è¦ç”¨keyåœ¨ç¼“å­˜ä¸­æŸ¥æ•°æ®ï¼‰
*/
@CachePut(cacheNames = {"employee"},key = "#employee.id")
public Employee updateEmployee(Employee employee){
    employeeMapper.updateEmployee(employee);
    System.out.println("æ›´æ–°çš„å‘˜å·¥ä¿¡æ¯ä¸ºï¼š"+employee);
    return employee;
}
```

ç„¶åé‡å¯é¡¹ç›®ï¼ŒæŸ¥è¯¢ä¸‰å·å‘˜å·¥ï¼Œæ›´æ–°ä¸‰å·å‘˜å·¥ï¼Œå†æŸ¥è¯¢ä¸‰å·å‘˜å·¥ï¼Œåº”å½“ä¼šä½¿ç”¨æ›´æ–°åçš„ç¼“å­˜ï¼Œå¹¶ä¸”å†æŸ¥è¯¢æ—¶æ— éœ€å‘é€SQLè¯­å¥ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜å–å€¼ã€‚

## 1.8 @CacheEvict

åœ¨EmployeeServiceç±»ä¸­æ·»åŠ deleteEmployeeæ–¹æ³•ï¼Œè¿™é‡Œåªæµ‹è¯•å…¶æ¸…é™¤ç¼“å­˜çš„èƒ½åŠ›ï¼Œæ‰€ä»¥å¹¶ä¸å®é™…åˆ é™¤æ•°æ®åº“é‡Œçš„ç›¸åº”æ•°æ®ï¼š

```java
/*
@CacheEvictï¼šæ¸…é™¤ç¼“å­˜
*/
@CacheEvict(cacheNames = {"employee"},key = "#id")
public void deleteEmployee(Integer id){
    System.out.println("æ¸…é™¤äº†"+id+"å·å‘˜å·¥çš„ç¼“å­˜");
    //employeeMapper.deleteEmployeeById(id);
}
```

åœ¨EmployeeControllerç±»ä¸­è°ƒç”¨è¯¥æ–¹æ³•ï¼š

```java
@PostMapping("deleteEmployee")
public String deleteEmployee(@RequestParam("id") Integer id){
    employeeService.deleteEmployee(id);
    return "åˆ é™¤æˆåŠŸ";
}
```

ä¸ºindex.htmlæ·»åŠ è¯¥è¡¨å•ï¼š

```html
<h2>åˆ é™¤æŒ‡å®šå‘˜å·¥ï¼š</h2>
<form method="post" action="/deleteEmployee">
    ç¼–å·ï¼š<input name="id" type="number">
    <input type="submit" value="åˆ é™¤">
</form>
```

é‡å¯é¡¹ç›®ï¼Œå…ˆæŸ¥è¯¢ä¸‰å·å‘˜å·¥çš„æ•°æ®ï¼š

![image-20200329202847375](SpringBootAdvanced.assets\image-20200329202847375.png)

æŸ¥çœ‹æ§åˆ¶å°ï¼Œèƒ½çœ‹åˆ°å‘å‡ºäº†SQLè¯­å¥ï¼š

![image-20200329202933105](SpringBootAdvanced.assets\image-20200329202933105.png)

å†æ¬¡æŸ¥è¯¢æ—¶åº”å½“ä¸ä¼šå†æ¬¡å‘å‡ºSQLè¯­å¥ï¼Œé‚£ä¹ˆæ¥åˆ°é¦–é¡µæ¸…é™¤ä¸‰å·çš„å‘˜å·¥çš„ç¼“å­˜ï¼š

![image-20200329203048834](SpringBootAdvanced.assets\image-20200329203048834.png)

ç„¶åå†æŸ¥è¯¢ä¸‰å·å‘˜å·¥ä¿¡æ¯ï¼Œçœ‹æ§åˆ¶å°è¾“å‡ºï¼Œæ˜¾ç„¶å†æ¬¡å‘é€äº†æŸ¥è¯¢è¯­å¥ï¼Œæ‰€ä»¥ç¼“å­˜æ¸…é™¤æˆåŠŸï¼š

![image-20200329203154682](SpringBootAdvanced.assets\image-20200329203154682.png)

ä¸Šé¢æ˜¯æ¸…é™¤æŒ‡å®škeyçš„ç¼“å­˜ï¼Œè€Œ@CacheEvictæœ‰ä¸ªåä¸ºallEntriesçš„å±æ€§ï¼Œå…¶é»˜è®¤ä¸ºfalseï¼Œä¸ºtrueæ—¶æ¸…é™¤cacheNameså±æ€§æŒ‡å®šçš„ç¼“å­˜ç»„ä»¶çš„æ‰€æœ‰æ¡ç›®ã€‚é‚£ä¹ˆåœ¨EmployeeServiceç±»çš„deleteEmployeeæ–¹æ³•ä¸Šï¼Œå°†@CacheEvictçš„allEntrieså±æ€§è®¾ä¸ºtrueï¼š

```java
@CacheEvict(cacheNames = {"employee"},allEntries = true)
public void deleteEmployee(Integer id){
    System.out.println("æ¸…é™¤äº†"+id+"å·å‘˜å·¥çš„ç¼“å­˜");
    //employeeMapper.deleteEmployeeById(id);
}
```

ç†è®ºä¸Šè¿™æ ·ä¼šæ¸…é™¤employeeç¼“å­˜ç»„ä»¶çš„æ‰€æœ‰æ•°æ®ï¼Œæ‰€ä»¥ä¸‹é¢å…ˆæŸ¥3ã€4å·å‘˜å·¥ï¼š

![image-20200329220029366](SpringBootAdvanced.assets\image-20200329220029366.png)

ç„¶åå†åˆ é™¤ä¸‰å·å‘˜å·¥ï¼ˆå®é™…ä¸Šæ¸…é™¤äº†æ‰€æœ‰å‘˜å·¥ç¼“å­˜ï¼‰ï¼š

![image-20200329220057939](SpringBootAdvanced.assets\image-20200329220057939.png)

å†æŸ¥è¯¢å››å·å‘˜å·¥ï¼Œå‘ç°SQLè¯­å¥å†æ¬¡å‘é€ï¼ŒallEntriesæµ‹è¯•æˆåŠŸï¼š

![image-20200329220224789](SpringBootAdvanced.assets\image-20200329220224789.png)

æœ€åæ¥è®²ä¸‹@CacheEvictçš„beforeInvocationå±æ€§ï¼Œä¸ºtrueæ—¶åœ¨æ–¹æ³•æ‰§è¡Œå‰æ¸…é™¤ç¼“å­˜ï¼Œé»˜è®¤ä¸ºfalseï¼Œå³æ–¹æ³•æ‰§è¡Œä¹‹åæ¸…é™¤ç¼“å­˜ã€‚è®¾ä¸ºtrueçš„å¥½å¤„æ˜¯å½“æ–¹æ³•ä½“å‡ºé”™æ—¶ï¼Œä¾ç„¶èƒ½å®Œæˆæ¸…é™¤ç¼“å­˜çš„ä»»åŠ¡ã€‚

```java
@CacheEvict(cacheNames = {"employee"},key = "#id",beforeInvocation = true)
```

## 1.9 @Cachingå’Œ@CacheConfig

å…ˆå»xuegao.learnSpringBoot.cache.mapper.EmployeeMapperå®šä¹‰getEmployeeByLastNameæ–¹æ³•ï¼š

```java
@Select("SELECT * FROM employee WHERE lastName = #{lastName}")
Employee getEmployeeByLastName(String lastName);
```

åœ¨xuegao.learnSpringBoot.cache.service.EmployeeServiceä¸­æ·»åŠ getEmployeeByLastNameæ–¹æ³•ï¼š

```java
/*@Cachingå¯ä»¥åŒæ—¶ä½¿ç”¨å¤šç±»æ³¨è§£ï¼ŒåŒ…æ‹¬@Cacheableã€@CachePutã€@CacheEvict*/
@Caching(
        cacheable = {
                @Cacheable(cacheNames = {"employee"},key = "#lastName")
        },
        put = {
                @CachePut(cacheNames = {"employee"},key = "#result.id"),
                @CachePut(cacheNames = {"employee"},key = "#result.email")
        }
)
public Employee getEmployeeByLastName(String lastName){
    return employeeMapper.getEmployeeByLastName(lastName);
}
```

ä»org.springframework.cache.annotation.Cachingæºç å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸ªç»„åˆæ³¨è§£ï¼š

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Documented
public @interface Caching {
   Cacheable[] cacheable() default {};
   CachePut[] put() default {};
   CacheEvict[] evict() default {};
}
```

åœ¨xuegao.learnSpringBoot.cache.controller.EmployeeControllerä¸­åˆ›å»ºgetEmployeeByLastNameæ–¹æ³•ï¼š

```java
@GetMapping("getEmployeeByLastName")
public Employee getEmployeeByLastName(@RequestParam("lastName") String lastName){
    return employeeService.getEmployeeByLastName(lastName);
}
```

å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨å§“æ°æŸ¥è¯¢å¯¹åº”å‘˜å·¥ä¿¡æ¯ï¼š

![image-20200331211007392](SpringBootAdvanced.assets\image-20200331211007392.png)

æ­¤æ—¶å¯ä»¥æµ‹è¯•ç”¨idæŸ¥è¯¢å‘˜å·¥ä¿¡æ¯ï¼Œçœ‹çœ‹å¯¹åº”å‘˜å·¥çš„æ•°æ®æ˜¯å¦è¢«ç¼“å­˜ï¼š

```
http://localhost:8080/employee/4
```

ç»“æœåº”è¯¥æ˜¯ä¼šè¢«ç¼“å­˜ï¼Œä¸å†å‘é€SQLè¯­å¥ã€‚ä½†ä½¿ç”¨getEmployeeByLastNameå»æŸ¥çš„è¯ä¾ç„¶è¦å‘é€SQLè¯­å¥ï¼Œå› ä¸ºå…¶ä½¿ç”¨äº†@CachePutæ³¨è§£ã€‚

æœ¬èŠ‚åŠå‰é¢å‡ èŠ‚ä¸­å¤§é‡ä½¿ç”¨äº†cacheNames = {"employee"}å±æ€§ï¼Œå…¶å®ä¸å¿…ä¸ºæ¯ä¸ªæ ‡ç­¾æ·»åŠ è¯¥æ³¨è§£ï¼Œä½¿ç”¨@CacheConfigå¯ä»¥è§£å†³è¯¥é—®é¢˜ï¼Œè¯¥æ³¨è§£æœ‰å¦‚ä¸‹å±æ€§ï¼š

```java
package org.springframework.cache.annotation;

@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface CacheConfig {
   String[] cacheNames() default {};
   String keyGenerator() default "";
   String cacheManager() default "";
   String cacheResolver() default "";
}
```

ä¸ºEmployeeServiceæ‰“ä¸Šæ³¨è§£ï¼Œé…ç½®@CacheConfigçš„cacheNameså±æ€§åï¼Œæ–¹æ³•ä¸Šçš„æ³¨è§£å°±ä¸ç”¨é€ä¸€é…ç½®cacheNameså±æ€§äº†ï¼š

```java
/*
* @CacheConfigï¼š
*   @CacheConfigä¼šæŠ½å–ç¼“å­˜çš„å…¬å…±é…ç½®ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å®ƒå¯¹æ•´ä¸ªç±»ä¸‹çš„Cacheç±»æ³¨è§£è¿›è¡Œå±æ€§é…ç½®ã€‚
*   ä¾‹å¦‚è¿™é‡Œä½¿ç”¨cacheNameså°±èƒ½å¯¹@Cacheableã€@CachePutã€@CacheEvicté‡Œçš„cacheNamesè¿›è¡Œç»Ÿä¸€é…ç½®ã€‚
* */
@CacheConfig(cacheNames = "employee")
@Service("employeeService")
public class EmployeeService {
```

ç„¶åé‡æ–°æµ‹è¯•å„ä¸ªæ–¹æ³•ï¼Œçœ‹çœ‹ç¼“å­˜å·¥ä½œæ˜¯å¦æ­£å¸¸å³å¯ã€‚

## 1.10 æ­å»ºRedisç¯å¢ƒåŠæµ‹è¯•

SpringBooté»˜è®¤ä½¿ç”¨çš„æ˜¯ConcurrentMapCacheManageråˆ›å»ºConcurrentMapCacheï¼Œè€ŒConcurrentMapCacheå°†æ•°æ®ä¿å­˜åœ¨ConcurrentMap<Object, Object>ç±»å‹çš„ç©ºé—´ä¸­ã€‚

å®é™…å¼€å‘ä¸­å¾€å¾€ä½¿ç”¨ç¼“å­˜ä¸­é—´ä»¶ï¼Œä¾‹å¦‚redisã€memcachedã€ehcacheã€‚

**Redisç®€ä»‹ï¼š**

REmote DIctionary Server(Redis) æ˜¯ä¸€ä¸ªç”±Salvatore Sanfilippoå†™çš„key-valueå­˜å‚¨ç³»ç»Ÿã€‚

Redisæ˜¯ä¸€ä¸ªå¼€æºçš„ä½¿ç”¨ANSI Cè¯­è¨€ç¼–å†™ã€éµå®ˆBSDåè®®ã€æ”¯æŒç½‘ç»œã€å¯åŸºäºå†…å­˜äº¦å¯æŒä¹…åŒ–çš„æ—¥å¿—å‹ã€Key-Valueæ•°æ®åº“ï¼Œå¹¶æä¾›å¤šç§è¯­è¨€çš„APIã€‚

å®ƒé€šå¸¸è¢«ç§°ä¸ºæ•°æ®ç»“æ„æœåŠ¡å™¨ï¼Œå› ä¸ºå€¼ï¼ˆvalueï¼‰å¯ä»¥æ˜¯ å­—ç¬¦ä¸²(String), å“ˆå¸Œ(Hash), åˆ—è¡¨(list), é›†åˆ(sets) å’Œ æœ‰åºé›†åˆ(sorted sets)ç­‰ç±»å‹ã€‚

**æ­å»ºæ­¥éª¤ï¼š**

1. è¿æ¥ä¸ŠLinuxï¼Œç¡®ä¿ä»¥å®‰è£…Dockerï¼Œä½¿ç”¨docker pull rediså‘½ä»¤æ‹‰å»Redisçš„é•œåƒï¼š

   ```sh
   docker pull redis
   ```

2. ä½¿ç”¨docker runå‘½ä»¤å¯åŠ¨Redisï¼š

   ```shell
   #-dè¡¨ç¤ºåå°è¿è¡Œï¼Œ-pç”¨äºå°†ä¸»æœºç«¯å£æ˜ å°„åˆ°å®¹å™¨å†…éƒ¨çš„ç«¯å£ï¼Œ-nameç”¨äºä¸ºè¯¥å®¹å™¨å–å
   docker run -d -p 6379:6379 --name myRedis redis
   ```

3. è¿æ¥Redisï¼š

   æ•™ç¨‹é‡Œä½¿ç”¨çš„æ˜¯Redis Desktop Managerä½†æˆ‘ä½¿ç”¨çš„æ˜¯AnotherRedisDesktopManagerã€‚ä¸¤è€…åœ¨GitHubä¸Šéƒ½æœ‰ï¼Œå…¶ä¸­Redis Desktop Manageråªæä¾›æºç ï¼Œè€Œå®˜ç½‘åˆ™åªæä¾›è®¢é˜…ç‰ˆã€‚é™¤éä½ æƒ³è‡ªå·±ç¼–è¯‘æˆ–ä»˜è´¹è®¢é˜…ï¼Œå¦åˆ™å»ºè®®ä½ æ‰¾ä¸€ä¸‹ç½‘ä¸Šç°æˆç¼–è¯‘å¥½çš„å®‰è£…åŒ…ï¼ŒGitHubä¸Šä¹Ÿæœ‰ï¼Œè¿™é‡Œè´´ä¸ªé€‚ç”¨äºWindowsçš„https://github.com/lework/RedisDesktopManager-Windows

   æˆ‘å‘¢æ˜¯é€‰æ‹©äº†AnotherRedisDesktopManagerï¼ˆæˆ‘åé¢ç”¨ç€å‡ºç°äº†é—®é¢˜ï¼Œå®ƒä¸æ”¯æŒJDKåºåˆ—åŒ–å‡ºæ¥çš„keyï¼Œæ‰€ä»¥è¿˜æ˜¯å»ºè®®ä¸‹è½½Redis Desktop Managerï¼ŒğŸ˜”æ˜æ˜ç•Œé¢ç¾è§‚æŒºå–œæ¬¢çš„ï¼‰ï¼Œä½ æƒ³ç”¨è¿™ä¸ªçš„è¯ç›´æ¥åœ¨GitHubæœå°±è¡Œï¼Œæœ‰ç°æˆçš„å®‰è£…åŒ…ã€‚æ— è„‘å®‰è£…å¥½åæ‰“å¼€è½¯ä»¶ï¼Œç‚¹å‡»æ–°å»ºè¿æ¥å³å¯ ï¼ŒHostæ˜¯å¡«IPçš„ï¼Œè‹¥ä½ å®‰è£…åœ¨æœ¬åœ°å°±ç”¨localhostï¼Œç”¨è™šæ‹Ÿæœºã€äº‘ä¸»æœºä¹‹ç±»çš„å°±å¡«å¯¹åº”çš„IPï¼Œè¿˜æ²¡æœ‰è®¾å¯†ç ï¼Œæ‰€ä»¥ä¸ç”¨å¡«Authï¼š

   ![image-20200401204901701](SpringBootAdvanced.assets\image-20200401204901701.png)

   æ€ä¹ˆè®¾ç½®å¯†ç å‘¢ï¼Ÿè¿æ¥ä¸ŠRedisæœåŠ¡åï¼Œä½ å¯ä»¥åœ¨æœ¬è½¯ä»¶ä¸­æ‰“å¼€Redisæ§åˆ¶å°ï¼ŒæŒ‰é’®å¦‚ä¸‹ï¼š

   ![image-20200401210441319](SpringBootAdvanced.assets\image-20200401210441319.png)

   æ‰“å¼€æ•ˆæœå¦‚ä¸‹ï¼š

   ![image-20200401210546048](SpringBootAdvanced.assets\image-20200401210546048.png)

   è®¾ç½®å¯†ç çš„æ–¹æ³•ï¼š

   ```shell
   #ä½¿ç”¨è¯¥å‘½ä»¤è®¾ç½®å¯†ç ï¼Œæ³¨æ„ä½¿ç”¨CONFIG set requirepass "password"åéœ€è¦é‡æ–°ç™»å½•è¯¥redisã€‚
   CONFIG set requirepass "password"
   
   #ä½¿ç”¨è¯¥å‘½ä»¤æŸ¥çœ‹å·²è®¾ç½®çš„å¯†ç 
   CONFIG get requirepass
   ```

4. æµ‹è¯•ä¸€äº›åŸºæœ¬çš„Rediså‘½ä»¤ï¼š

   å¦‚æœä½ è‹±æ–‡å¥½å¯ä»¥ç›´æ¥å»çœ‹å®˜ç½‘æ–‡æ¡£ï¼Œè¿™é‡Œè´´å‡ºä¸­æ–‡å¤åˆ»ç‰ˆçš„ç½‘å€www.redis.cnï¼ˆæˆ‘æ„Ÿè§‰ç½‘é€Ÿæ¯”å®˜ç½‘å¿«ï¼Œæ‰€ä»¥è‹±æ–‡å¥½ä¹Ÿæ¨èä½¿ç”¨è¿™ä¸ªğŸ˜‚ï¼‰ï¼Œç‚¹å‡»å‘½ä»¤ï¼š

   ![image-20200401212206625](SpringBootAdvanced.assets\image-20200401212206625.png)

   è¿›å…¥å‘½ä»¤åé€‰æ‹©Stringsï¼Œæµ‹è¯•ä¸‹è¿™é‡Œçš„å‘½ä»¤ï¼š![image-20200401212355303](SpringBootAdvanced.assets\image-20200401212355303.png)

   ä¸ºkeyè¿½åŠ ä¸ªå€¼ï¼š

   ```shell
   APPEND key HelloRedis
   ```

   åˆ·æ–°ä¸€ä¸‹ï¼Œå°±èƒ½çœ‹åˆ°keyå’Œå…¶å¯¹åº”çš„å€¼äº†ï¼ˆé»˜è®¤ä¿å­˜åœ¨DB0ï¼‰ï¼š

   ![image-20200401215628844](SpringBootAdvanced.assets\image-20200401215628844.png)

   ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤å¯ä»¥ä¸€ç›´è¿½åŠ å€¼ï¼Œä¾‹å¦‚å†æ¥ä¸ªAPPEND key ä½ å¥½Redisï¼š

   ![image-20200401220015993](SpringBootAdvanced.assets\image-20200401220015993.png)

   ä½¿ç”¨GET keyå‘½ä»¤å–å‡ºkeyï¼Œå…¶æ§åˆ¶å°è¾“å‡ºï¼š

   ![image-20200401220300992](SpringBootAdvanced.assets\image-20200401220300992.png)

   å†æ¥æµ‹è¯•ä¸‹Listsç›¸å…³å‘½ä»¤ã€‚

   æµ‹è¯•LPUSHå‘½ä»¤ï¼š

   ```shell
   #LPUSH key value ... å‘½ä»¤ç”¨äºå°†æ‰€æœ‰æŒ‡å®šçš„å€¼å­˜å…¥keyåˆ—è¡¨çš„å¤´éƒ¨ï¼Œåƒæ ˆä¸€æ ·
   LPUSH mylist 1 2 3 4 5
   ```

   æŸ¥çœ‹é”®mylistï¼š

   ![image-20200401221626676](SpringBootAdvanced.assets\image-20200401221626676.png)

   æµ‹è¯•LPOPå‘½ä»¤ï¼š

   ```shell
   #ç§»é™¤å¹¶ä¸”è¿”å›keyå¯¹åº”çš„listçš„é¦–ä¸ªå…ƒç´ ã€‚
   LPOP mylist
   ```

   æ§åˆ¶å°è¾“å‡ºï¼š

   ```shell
   > LPOP mylist
   5
   ```

   æµ‹è¯•RPOPå‘½ä»¤ï¼š

   ```shell
   #ç§»é™¤å¹¶è¿”å›å­˜äºkeyçš„listçš„æœ€åä¸€ä¸ªå…ƒç´ 
   RPOP mylist
   ```

   æ§åˆ¶å°è¾“å‡ºï¼š

   ```shell
   > rpop mylist
   1
   ```

   æµ‹è¯•SADDå‘½ä»¤ï¼š

   ```shell
   #å°†å…ƒç´ æ·»åŠ åˆ°é›†åˆä¸­ï¼Œå°±æ˜¯æ•°å­¦æ„ä¹‰ä¸Šçš„é›†åˆï¼šæ— åºã€å€¼ä¸é‡å¤ã€‚
   SADD myset å¼ ä¸‰ æå››
   ```

   å†æ¬¡å‘mysetæ·»åŠ â€œå¼ ä¸‰â€æ—¶ï¼Œå‘ç°è¿”å›0ï¼Œè¿™æ˜¯å› ä¸ºé›†åˆä¸­å·²æœ‰è¯¥å€¼

   ```shell
   > SADD myset å¼ ä¸‰
   0
   ```

   å¯ç”¨SMEMBERSå‘½ä»¤è¿”å›é›†åˆä¸­æ‰€æœ‰çš„å…ƒç´ ï¼š

   ```shell
   > SMEMBERS myset
   å¼ ä¸‰
   æå››
   ```

   å¯ç”¨SISMEMBERåˆ¤æ–­ç»™å®šå€¼æ˜¯å¦ä¸ºè¯¥é›†åˆçš„æˆå‘˜ï¼Œ0ä¸ºfalseï¼Œ1ä¸ºtrueï¼š

   ```shell
   > SISMEMBER myset é›ªç³•
   0
   > SISMEMBER myset å¼ ä¸‰
   1
   ```

## 1.11 RedisTemplateåŠåºåˆ—åŒ–æœºåˆ¶

**å®‰è£…Redisçš„å¯åŠ¨å™¨ï¼š**

1. ä¸ºé¡¹ç›®å¼•å…¥rediså¯åŠ¨å™¨ï¼š

   ```xml
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-data-redis</artifactId>
   </dependency>
   ```

2. åœ¨SpringBoot Profileä¸­é…ç½®Redisï¼š

   ```properties
   #é…ç½®Redis
       spring.redis.host=RedisæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€
       spring.redis.password=ä½ é…ç½®çš„å¯†ç 
   ```

3. æŸ¥çœ‹org.springframework.boot.autoconfigure.data.redis.RedisAutoConfigurationï¼š

   ```java
   @Configuration(proxyBeanMethods = false)
   @ConditionalOnClass(RedisOperations.class)
   @EnableConfigurationProperties(RedisProperties.class)
   @Import({ LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class })
   public class RedisAutoConfiguration {
   
      @Bean
      @ConditionalOnMissingBean(name = "redisTemplate")
      public RedisTemplate<Object, Object> redisTemplate(RedisConnectionFactory redisConnectionFactory)
            throws UnknownHostException {
         RedisTemplate<Object, Object> template = new RedisTemplate<>();
         template.setConnectionFactory(redisConnectionFactory);
         return template;
      }
   
      @Bean
      @ConditionalOnMissingBean
      public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory)
            throws UnknownHostException {
         StringRedisTemplate template = new StringRedisTemplate();
         template.setConnectionFactory(redisConnectionFactory);
         return template;
      }
   
   }
   ```

**æµ‹è¯•RedisåŸºæœ¬æ“ä½œï¼š**

Rediså¸¸è§çš„æ•°æ®ç±»å‹ï¼šStringã€Listã€Setã€Hashã€ZSetï¼ˆæœ‰åºé›†åˆï¼‰ã€‚

è¿™äº›ç±»å‹å¯¹åº”çš„æ“ä½œæ–¹æ³•ï¼ˆstringRedisTemplateå¯ä»¥æ”¹ä¸ºredisTemplateï¼Œåªä¸è¿‡åˆ†åˆ«æ˜¯æ“ä½œå­—ç¬¦ä¸²å’Œå¯¹è±¡çš„ï¼‰ï¼š
    stringRedisTemplate.opsForValue();
    stringRedisTemplate.opsForList();
    stringRedisTemplate.opsForSet();
    stringRedisTemplate.opsForHash();
    stringRedisTemplate.opsForZSet();

åœ¨xuegao.learnSpringBoot.cache.CacheApplicationTestsä¸­æµ‹è¯•stringRedisTemplate.opsForValue()ï¼š

```java
@SpringBootTest
class CacheApplicationTests {
    @Autowired
    StringRedisTemplate stringRedisTemplate;//æ“ä½œâ€œé”®å€¼â€éƒ½æ˜¯å­—ç¬¦ä¸²çš„
    @Autowired
    RedisTemplate redisTemplate;//æ“ä½œâ€œé”®å€¼â€éƒ½æ˜¯å¯¹è±¡çš„
    
    @Test
    void testRedisBasicOperation(){
        stringRedisTemplate.opsForValue().append("message","hello");//å‘Redisæ·»åŠ æ•°æ®
    }
}
```

è¿è¡ŒtestRedisBasicOperationï¼ŒæŸ¥çœ‹æ•ˆæœï¼š

![image-20200402161036436](SpringBootAdvanced.assets\image-20200402161036436.png)

ä½¿ç”¨stringRedisTemplate.opsForValue().get()è·å–æ•°æ®ï¼Œåº”å½“èƒ½åœ¨Consoleçœ‹åˆ°messageçš„å€¼ï¼š

```java
@Test
void testRedisBasicOperation(){
    //stringRedisTemplate.opsForValue().append("message","hello");//å‘Redisè¿½åŠ æ•°æ®
    //è¯»å–messageçš„æ•°æ®ï¼Œæ˜¾ç¤ºåˆ°æ§åˆ¶å°
    String message = stringRedisTemplate.opsForValue().get("message");
    System.out.println(message);
}
```



æµ‹è¯•leftPushï¼š

```java
@Test
void testRedisBasicOperation(){
    //æµ‹è¯•leftPush
    stringRedisTemplate.opsForList().leftPush("myList","1");
    stringRedisTemplate.opsForList().leftPush("myList","2");
}
```

æ•ˆæœï¼š

![image-20200402162036659](SpringBootAdvanced.assets\image-20200402162036659.png)

ä½¿ç”¨employeeMapperæŸ¥è¯¢ä¸‰å·å‘˜å·¥ï¼Œç”¨redisTemplate.opsForValue().set("employee_4",employee)å°†å¯¹è±¡æ·»åŠ åˆ°employee_4ä¸­ï¼š

```java
@SpringBootTest
class CacheApplicationTests {
    @Resource(name = "employeeMapper")
    EmployeeMapper employeeMapper;
    @Autowired
    StringRedisTemplate stringRedisTemplate;//æ“ä½œâ€œé”®å€¼â€éƒ½æ˜¯å­—ç¬¦ä¸²çš„
    @Autowired
    RedisTemplate redisTemplate;//æ“ä½œâ€œé”®å€¼â€éƒ½æ˜¯å¯¹è±¡çš„

    /*æµ‹è¯•ä¿å­˜å¯¹è±¡*/
    @Test
    void testSaveObject(){
        Employee employee = employeeMapper.getEmployeeById(4);
        //ä¿å­˜å¯¹è±¡æ—¶é»˜è®¤ä½¿ç”¨JDKåºåˆ—åŒ–æœºåˆ¶ï¼Œåºåˆ—åŒ–åçš„æ•°æ®ä¿å­˜åˆ°Redisä¸­
        redisTemplate.opsForValue().set("employee_4",employee);
    }
}
```

æ­¤æ—¶è¿è¡Œè¯¥æµ‹è¯•ä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿˜æ²¡æœ‰åºåˆ—åŒ–Employeeç±»ï¼š

![image-20200402165747582](SpringBootAdvanced.assets\image-20200402165747582.png)

å®ç°åºåˆ—åŒ–ï¼š

```java
package xuegao.learnSpringBoot.cache.bean;

import java.io.Serializable;

public class Employee implements Serializable {
```

é‡æ–°è¿è¡Œæµ‹è¯•ï¼ŒæŸ¥çœ‹employee_4ï¼š

- æˆ‘ç”¨çš„Another Redis DeskTop Managerè¿™é‡Œå‡ºç°äº†é—®é¢˜ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒJDKåºåˆ—åŒ–çš„keyï¼š

![image-20200402172405441](SpringBootAdvanced.assets\image-20200402172405441.png)

- ç”¨Redis DeskTop Managerï¼Œå¹¶æ²¡æœ‰é—®é¢˜ï¼š

  ![image-20200402172636152](SpringBootAdvanced.assets\image-20200402172636152.png)

å¯ä»¥çœ‹åˆ°è¿™æ ·çš„æ•°æ®å¾ˆéš¾çœ‹ï¼Œä¸ç›´è§‚ã€‚è¿™æ˜¯å› ä¸ºä¿å­˜å¯¹è±¡æ—¶é»˜è®¤ä½¿ç”¨JDKåºåˆ—åŒ–æœºåˆ¶ã€‚å¦‚æœæƒ³ç”¨JSONæ ¼å¼ä¿å­˜æ•°æ®æ€ä¹ˆåŠï¼Ÿæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€æ˜¯è‡ªè¡Œå°†å¯¹è±¡è½¬ä¸ºJSONæ ¼å¼ï¼ŒäºŒæ˜¯ç”¨RedisTemplateæä¾›çš„åºåˆ—åŒ–å™¨ã€‚==æ³¨æ„ï¼Œä½¿ç”¨JSONæ ¼å¼ä¼šæŸå¤±æ•ˆç‡ï¼Œä½†èƒ½èŠ‚çº¦å­˜å‚¨ç©ºé—´ä¸”ä»¤æ•°æ®ç›´è§‚ï¼Œå³æ—¶é—´æ¢ç©ºé—´ã€‚==

org.springframework.boot.autoconfigure.data.redis.RedisAutoConfigurationä¸­æœ‰å‘IOCå®¹å™¨æ·»åŠ redisTemplateå¯¹è±¡çš„æ–¹æ³•ï¼Œå°†å…¶å¤åˆ¶è¿‡æ¥ï¼Œæ”¾åˆ°xuegao.learnSpringBoot.cache.config.MyRedisConfigä¸­ï¼Œç¨ä½œä¿®æ”¹ï¼š

```java
@Configuration
public class MyRedisConfig {
    //è‡ªè¡Œå‘IOCå®¹å™¨æ·»åŠ åä¸ºredisTemplateEmployeeçš„Bean
    @Bean
    public RedisTemplate<Object, Employee> redisTemplateEmployee(RedisConnectionFactory redisConnectionFactory)
            throws UnknownHostException {
        RedisTemplate<Object, Employee> template = new RedisTemplate<>();
        template.setConnectionFactory(redisConnectionFactory);
        //ä½¿ç”¨Jackson2JsonRedisSerializerä½œä¸ºåºåˆ—åŒ–å™¨ï¼Œè¿™é‡Œå°†Employeeç±»çš„åºåˆ—åŒ–è®¾ä¸ºJSONæ ¼å¼
        Jackson2JsonRedisSerializer<Employee> serializer = new Jackson2JsonRedisSerializer<Employee>(Employee.class);
        template.setDefaultSerializer(serializer);
        
        return template;
    }

}
```

åœ¨xuegao.learnSpringBoot.cache.CacheApplicationTestsä¸­æµ‹è¯•ï¼š

```java
@Autowired
RedisTemplate<Object, Employee> redisTemplateEmployee;

/*æµ‹è¯•ä¿å­˜å¯¹è±¡*/
@Test
void testSaveObject(){
    /*
    ä»¥JSONæ ¼å¼çš„ä¿å­˜æ•°æ®ï¼š
        æ–¹æ³•ä¸€ã€è‡ªè¡Œå°†å¯¹è±¡è½¬ä¸ºJSONæ ¼å¼
        æ–¹æ³•äºŒã€RedisTemplateæä¾›äº†åºåˆ—åŒ–å™¨
    */
    //ä½¿ç”¨Jackson2JsonRedisSerializer<Employee>åºåˆ—åŒ–employeeå¯¹è±¡ï¼Œè‹¥æœ‰éœ€è¦å¯æ”¹ä¸ºæ”¹æˆObjectï¼Œä»è€Œå¯¹æ‰€æœ‰ç±»å‹ç”Ÿæ•ˆ
    Employee employee = employeeMapper.getEmployeeById(5);
    redisTemplateEmployee.opsForValue().set("employee_5",employee);
}
```

æ•ˆæœï¼š

![image-20200402183206929](SpringBootAdvanced.assets\image-20200402183206929.png)

å‰é¢çš„åªèƒ½å¯¹Employeeç±»å‹çš„å¯¹è±¡åšåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè‹¥è¦å¯¹æ‰€æœ‰ç±»å‹åšè¿™ç§æ“ä½œï¼Œå¯ä»¥å°†æ³›å‹è¯¥ä¸ºObjectï¼Œä¾‹å¦‚åœ¨MyRedisConfigä¸­æ·»åŠ è¯¥æ–¹æ³•ï¼š

```java
//è‡ªè¡Œå‘IOCå®¹å™¨æ·»åŠ åä¸ºredisTemplateObjectçš„Bean
@Bean
public RedisTemplate<Object, Object> redisTemplateObject(RedisConnectionFactory redisConnectionFactory)
        throws UnknownHostException {
    RedisTemplate<Object, Object> template = new RedisTemplate<>();
    template.setConnectionFactory(redisConnectionFactory);
    //ä½¿ç”¨Jackson2JsonRedisSerializerä½œä¸ºåºåˆ—åŒ–å™¨ï¼Œè¿™é‡Œå°†æ‰€æœ‰ç±»çš„åºåˆ—åŒ–è®¾ä¸ºJSONæ ¼å¼
    Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<Object>(Object.class);
    template.setDefaultSerializer(serializer);

    return template;
}
```

å•å…ƒæµ‹è¯•ï¼š

```java
/*æµ‹è¯•æ“ä½œä»»æ„å¯¹è±¡*/
@Test
void testOperationObject(){
    Department department = departmentMapper.getDepartmentById(2);
    redisTemplateObject.opsForValue().set("department_2",department);//åºåˆ—åŒ–å­˜å…¥ç¼“å­˜
    Object department_2 = redisTemplateObject.opsForValue().get("department_2");//ä»ç¼“å­˜ä¸­ååºåˆ—åŒ–è¯»å–
    System.out.println("department_2ï¼š" + department_2);
}
```

## 1.12è‡ªå®šä¹‰CacheManager

**å‰è¨€ï¼š**

ç”±CacheManagerç®¡ç†Cacheç»„ä»¶ï¼Œå†ç”±Cacheç»„ä»¶æ¥å®é™…ç»™ç¼“å­˜ä¸­å­˜å–æ•°æ®ã€‚å¯¼å…¥Redisçš„starteråï¼Œå°†ä½¿ç”¨RedisCacheManageræ¥åˆ›å»ºRedisCacheï¼Œç”±RedisCacheé€šè¿‡Redisè½¯ä»¶æ¥ç¼“å­˜æ•°æ®ã€‚

**æµ‹è¯•ï¼š**

å‰é¢çš„å‡ èŠ‚ä¸­ï¼Œå‘é¡¹ç›®å¯¼å…¥äº†Rediså¯åŠ¨å™¨ï¼Œé‚£ä¹ˆSimpleCacheConfigurationè¿˜æ˜¯ç”Ÿæ•ˆçš„å—ï¼Ÿé¦–å…ˆå»SpringBoot Profileä¸­å¼€å¯å…¨å±€debugçº§æ—¥å¿—ï¼š

```properties
#å¼€å¯å…¨å±€debugçº§æ—¥å¿—
debug=true
```

å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨FindåŠŸèƒ½æŸ¥æ‰¾ï¼ˆå¿«æ·é”®Ctrl+Fï¼Œæ²¡ç”¨çš„è¯å»è®¾ç½®é‡Œé…ç½®Keymapï¼‰ï¼Œçœ‹èµ·æ¥æ˜¯æœªåŒ¹é…çš„ï¼š

![image-20200403193224998](SpringBootAdvanced.assets\image-20200403193224998.png)

äº‹å®ä¸Šå¯¼å…¥Rediså¯åŠ¨å™¨åç”¨çš„æ˜¯RedisCacheConfigurationï¼Œå®ƒæ˜¯åŒ¹é…çš„ï¼š

![image-20200403193506743](SpringBootAdvanced.assets\image-20200403193506743.png)

æŸ¥çœ‹org.springframework.boot.autoconfigure.cache.RedisCacheConfigurationçš„æºç ï¼Œå¯ä»¥å¾—å‡ºå¼•å…¥Rediså¯åŠ¨å™¨åï¼Œå®¹å™¨ä¿å­˜çš„æ˜¯RedisCacheManagerï¼š

```java
@Configuration(proxyBeanMethods = false)
@ConditionalOnClass(RedisConnectionFactory.class)
@AutoConfigureAfter(RedisAutoConfiguration.class)
@ConditionalOnBean(RedisConnectionFactory.class)
@ConditionalOnMissingBean(CacheManager.class)
@Conditional(CacheCondition.class)
class RedisCacheConfiguration {

   @Bean
   RedisCacheManager cacheManager(CacheProperties cacheProperties, CacheManagerCustomizers cacheManagerCustomizers,
         ObjectProvider<org.springframework.data.redis.cache.RedisCacheConfiguration> redisCacheConfiguration,
         ObjectProvider<RedisCacheManagerBuilderCustomizer> redisCacheManagerBuilderCustomizers,
         RedisConnectionFactory redisConnectionFactory, ResourceLoader resourceLoader) {
```

org.springframework.data.redis.cache.RedisCacheManagerä¼šåˆ›å»ºRedisCacheæ¥ä½œä¸ºç¼“å­˜ç»„ä»¶ï¼ŒRedisCacheé€šè¿‡æ“ä½œRedisç¼“å­˜æ•°æ®ã€‚

```java
/**
 * Configuration hook for creating {@link RedisCache} with given name and {@code cacheConfig}.
 *
 * @param name must not be {@literal null}.
 * @param cacheConfig can be {@literal null}.
 * @return never {@literal null}.
 */
protected RedisCache createRedisCache(String name, @Nullable RedisCacheConfiguration cacheConfig) {
   return new RedisCache(name, cacheWriter, cacheConfig != null ? cacheConfig : defaultCacheConfig);
}
```

è¿™æ„å‘³ç€é¡¹ç›®å·²å¯ç”¨Redisï¼Œç›¸å…³é…ç½®éƒ½é…ç½®å¥½äº†ï¼Œæ•°æ®ä¼šç¼“å­˜åˆ°Redisä¸­ï¼Œé‚£ä¹ˆæŸ¥è¯¢ä¸ªå‘˜å·¥è¯•è¯•ï¼š

![image-20200403201723122](SpringBootAdvanced.assets\image-20200403201723122.png)

æŸ¥çœ‹Redisä¸­æ˜¯å¦æœ‰å¯¹åº”é”®å€¼ï¼Œå¯ä»¥æ³¨æ„åˆ°è¿™åˆä¸æ˜¯JSONæ ¼å¼äº†ï¼š

![image-20200403202043429](SpringBootAdvanced.assets\image-20200403202043429.png)

è¿™æ˜¯å› ä¸ºRedisCacheManageré»˜è®¤ä¿å­˜çš„é”®å€¼å¯¹éƒ½æ˜¯Objectç±»å‹ï¼Œå¹¶ä½¿ç”¨åºåˆ—åŒ–ä¿å­˜ã€‚

**ä¿å­˜ä¸ºJSONæ ¼å¼ï¼š**

å¦‚ä½•ä¿å­˜ä¸ºJSONæ ¼å¼ï¼Ÿéœ€è¦è‡ªå®šä¹‰CacheManagerã€‚SpringBoot 2å’Œ1ç‰ˆæœ¬å‘ç”Ÿè¾ƒå¤§å˜åŒ–ï¼Œè¿™é‡Œè´´ä¸ªæ–°ç‰ˆæœ¬çš„è§£å†³æ–¹æ³•https://blog.csdn.net/qinying233/article/details/104689709ã€‚è¿˜æœ‰å®˜æ–¹æ–‡æ¡£å¯¹æ­¤ä¹Ÿæœ‰è¯´æ˜https://docs.spring.io/spring-data/redis/docs/2.2.5.RELEASE/reference/html/#redis:support:cache-abstractionã€‚

æ ¸å¿ƒå°±æ˜¯ä¼ å…¥RedisConnectionFactoryï¼Œè¿”å›RedisCacheManagerã€‚ä¸‹é¢æ˜¯ä¸¤ä¸ªå¯ç”¨çš„ä»£ç ï¼Œæ”¾å…¥åˆ°é…ç½®ç±»ä¸­å°±å¥½ï¼Œæˆ‘æ”¾åœ¨äº†MyRedisConfigä¸­ï¼š

```java
/*è‡ªå®šä¹‰CacheManager*/
@Bean
public RedisCacheManager cacheManager(RedisConnectionFactory connectionFactory) {
    RedisCacheConfiguration cacheConfiguration = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(15))// è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
            .disableCachingNullValues()// ç¦ç”¨ç¼“å­˜ç©ºå€¼ï¼Œä¸ç¼“å­˜nullæ ¡éªŒ
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new
                    GenericJackson2JsonRedisSerializer()));// è®¾ç½®CacheManagerçš„å€¼åºåˆ—åŒ–æ–¹å¼ä¸ºJSONåºåˆ—åŒ–ï¼Œå¯åŠ å…¥@Classå±æ€§
    // ä½¿ç”¨RedisCacheConfigurationåˆ›å»ºRedisCacheManager
    RedisCacheManager redisCacheManager = RedisCacheManager.builder(connectionFactory).cacheDefaults(cacheConfiguration ).build();
    return redisCacheManager;
}
```

```java
@Bean
public CacheManager cacheManager(RedisConnectionFactory redisConnectionFactory) {
	//åˆå§‹åŒ–RedisCacheWriterï¼ŒRedisCacheWriteræä¾›äº†å¯¹Redisçš„setã€setnxã€getç­‰å‘½ä»¤çš„è®¿é—®æƒé™ï¼Œå¯ä»¥ç”±å¤šä¸ªç¼“å­˜å®ç°å…±äº«ï¼Œå¹¶è´Ÿè´£å†™/è¯»æ¥è‡ªRedisçš„äºŒè¿›åˆ¶æ•°æ®ã€‚
	RedisCacheWriter redisCacheWriter = RedisCacheWriter.nonLockingRedisCacheWriter(redisConnectionFactory);
	//è®¾ç½®CacheManagerçš„å€¼åºåˆ—åŒ–æ–¹å¼ä¸ºjsonåºåˆ—åŒ–
	RedisSerializer<Object> jsonSerializer = new GenericJackson2JsonRedisSerializer();
	RedisSerializationContext.SerializationPair<Object> pair = RedisSerializationContext.SerializationPair.fromSerializer(jsonSerializer);
	RedisCacheConfiguration defaultCacheConfig = RedisCacheConfiguration.defaultCacheConfig().serializeValuesWith(pair);

	defaultCacheConfig.entryTtl(Duration.ofSeconds(30));//è®¾ç½®é»˜è®¤è¶…è¿‡æœŸæ—¶é—´æ˜¯30ç§’
	return new RedisCacheManager(redisCacheWriter, defaultCacheConfig);//åˆå§‹åŒ–RedisCacheManager
}
```

å€¼å¾—æ³¨æ„çš„æ˜¯å¦‚æœè‹¥å®šä¹‰äº†ä¸¤ä¸ªä»¥ä¸Šçš„CacheManagerçš„æ—¶å€™Spring Bootå¯åŠ¨æ—¶ä¼šæŠ¥é”™ï¼Œå› ä¸ºSpringæ— æ³•å¾—çŸ¥å®ƒåœ¨é»˜è®¤çš„æ—¶å€™è¦ä½¿ç”¨å“ªä¸ªCacheManagerã€‚è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸ªåŸºæœ¬çš„CacheManageræˆ–è€…ç”¨@Primaryæ³¨è§£æŒ‡å®šè¦ä½¿ç”¨çš„CacheManagerã€‚

é‡å¯é¡¹ç›®ï¼ŒæŸ¥è¯¢å‘˜å·¥ä¿¡æ¯ï¼ˆæ³¨æ„æ¸…é™¤RedisåŸæœ‰çš„ç¼“å­˜ï¼Œå¦åˆ™ä¼šç›´æ¥è¯»å–åŸå…ˆåå…­è¿›åˆ¶å€¼çš„ç¼“å­˜ï¼Œä¼šæŠ¥é”™è¯´æ— æ³•è½¬ä¸ºJSONæ ¼å¼ï¼‰ï¼ŒæŸ¥çœ‹é”®å€¼ï¼š

![image-20200404000909101](SpringBootAdvanced.assets\image-20200404000909101.png)

æ²¡å¾—é—®é¢˜ï¼ŒæˆåŠŸå˜ä¸ºJSONæ ¼å¼ã€‚è™½ç„¶è¿™ä¹ˆè´¹åŠ²çš„å§æ•°æ®å®šä¹‰ä¸ºJSONæ ¼å¼ï¼Œä½†æ˜¯åºåˆ—åŒ–æ ¼å¼ä¿å­˜åå¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œæ‰€ä»¥ä¸€èˆ¬æ— éœ€è¿™ä¹ˆæŠ˜è…¾ã€‚ä½†è¯åˆè¯´å›æ¥ï¼Œå¯¹äºRedisæ¥è¯´ï¼Œæ— è®ºæ˜¯JSONåºåˆ—åŒ–è¿˜æ˜¯JDKåºåˆ—åŒ–ï¼ŒRedisæ¥å—çš„éƒ½æ˜¯å­—ç¬¦ä¸²æ–‡æœ¬ï¼Œè€ŒJDKçš„åºåˆ—åŒ–æ–¹å¼å­—ç¬¦ä¸²ä¼šæ¯”JSONåºåˆ—åŒ–æ–‡æœ¬å¤§5å€ã€‚ç»¼ä¸Šè¿™æ˜¯ä¸ªæ—¶ç©ºå–èˆé—®é¢˜ï¼Œæ ¹æ®åœºæ™¯éœ€æ±‚ï¼Œä»è€…è§ä»ï¼Œæ™ºè€…è§æ™ºã€‚

org.springframework.boot.autoconfigure.cache.CacheManagerCustomizerså¯ä»¥ç”¨æ¥å®šåˆ¶éƒ¨åˆ†ç¼“å­˜è§„åˆ™ã€‚

åœ¨å­˜å…¥Redisæ—¶ï¼Œä¸éš¾å‘ç°è¿™æ˜¯ç”±cacheNames::keyç»„åˆè€Œæˆï¼Œå…·ä½“å¯ä»¥çœ‹ä¹‹å‰åˆ›å»ºçš„EmployeeServiceç±»é‡Œçš„æ–¹æ³•ï¼š

```java
@Cacheable(cacheNames = {"employee"},key = "#id")
public Employee getEmployee(Integer id){
    Employee employee = employeeMapper.getEmployeeById(id);
    System.out.println("ç¼–å·ä¸º"+id+"çš„å‘˜å·¥ä¿¡æ¯ä¸ºï¼š"+employee);
    return employee;
}
```

è¿™æ˜¯ä¸ºäº†é˜²æ­¢keyä¹‹é—´é‡å¤ï¼Œå¦‚æœåªç”¨keyçš„è¯é‡åçš„æ¦‚ç‡æ˜¾ç„¶å¾ˆå¤§ã€‚

 **æµ‹è¯•éƒ¨é—¨ï¼š**

å…ˆå»æ•°æ®åº“ä¸­çš„éƒ¨é—¨è¡¨æ·»åŠ ä¿¡æ¯ï¼š

![image-20200404115702817](SpringBootAdvanced.assets\image-20200404115702817.png)

åˆ›å»ºxuegao.learnSpringBoot.cache.service.DepartmentServiceï¼Œæä¾›ä¾IDæŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯çš„æ–¹æ³•ï¼š

```java
@CacheConfig(cacheNames = "department")
@Service("departmentService")
public class DepartmentService {
    
    @Resource(name = "departmentMapper")
    DepartmentMapper departmentMapper;

    @Cacheable(key = "#id")
    public Department getDepartmentById(Integer id){
        return departmentMapper.getDepartmentById(id);
    }
}
```

åˆ›å»ºDepartmentControllerï¼š

```java
@RestController
public class DepartmentController {

    @Resource(name = "departmentService")
    DepartmentService departmentService;

    @GetMapping("getDepartmentById")
    public Department getDepartmentById(@RequestParam("id") Integer id){
        return departmentService.getDepartmentById(id);
    }
}
```

http://localhost:8080/getDepartmentById?id=1å‘å‡ºæŸ¥è¯¢ï¼Œçœ‹çœ‹Redisé‡Œæœ‰æ²¡æœ‰ç¼“å­˜ï¼š

![image-20200404135907789](SpringBootAdvanced.assets\image-20200404135907789.png)

å¤šåˆ·æ–°å‡ æ¬¡ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œæ•™ç¨‹ä¸­ç”±äºä½¿ç”¨çš„æ˜¯SpringBoot 1ç³»ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¼šååºåˆ—åŒ–å¤±è´¥ï¼Œä½†2ç³»ç‰ˆæœ¬å¯ä»¥ç›´æ¥ä½¿ç”¨RedisConnectionFactoryç»Ÿä¸€è½¬åŒ–ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒä¸åŒç±»å‹çš„ååºåˆ—åŒ–é—®é¢˜äº†ã€‚

**é€šè¿‡CacheManagerå¾—åˆ°ç¼“å­˜ï¼Œç„¶åè¿›è¡ŒAPIè°ƒç”¨ï¼š**

ä¸åŒäºæ•™ç¨‹ï¼Œæˆ‘æ˜¯åœ¨å•å…ƒæµ‹è¯•xuegao.learnSpringBoot.cache.CacheApplicationTestsä¸­åšçš„ï¼Œå®é™…ä¸Šå¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹ï¼š

```java
@Resource(name = "departmentMapper")
DepartmentMapper departmentMapper;
@Autowired//å› ä¸ºåªæœ‰ä¸€ä¸ªRedisCacheManagerç±»å‹çš„Beanï¼Œæ‰€ä»¥å¯ä»¥ç”¨è‡ªåŠ¨æ³¨å…¥
RedisCacheManager cacheManager;

/*æµ‹è¯•é€šè¿‡CacheManagerå¾—åˆ°ç¼“å­˜ï¼Œç„¶åè¿›è¡ŒAPIè°ƒç”¨*/
@Test
void testCacheManager(){
    //é€šè¿‡CacheManagerå¾—åˆ°ç¼“å­˜
    Cache departmentCache = cacheManager.getCache("department");
    //è°ƒç”¨APIå†™å…¥æ•°æ®
    departmentCache.put("department_4",departmentMapper.getDepartmentById(4));
    //è¯»å–department_4å¹¶å°†ä¿¡æ¯æ˜ å°„åˆ°Departmentæ¨¡å‹
    Department department = departmentCache.get("department_4", Department::new);
    //æ‰“å°ä¿¡æ¯åˆ°æ§åˆ¶å°
    System.out.println(department);
}
```

è¿è¡Œè¯¥æµ‹è¯•ï¼ŒæŸ¥çœ‹Redisç¼“å­˜ï¼š

![image-20200404155353770](SpringBootAdvanced.assets\image-20200404155353770.png)

æ§åˆ¶å°è¾“å‡ºï¼š

![image-20200404155317417](SpringBootAdvanced.assets\image-20200404155317417.png)

è¿™æ ·å°±æµ‹è¯•é€šè¿‡äº†ã€‚

# äºŒã€æ¶ˆæ¯

## 2.1 JMSå’ŒAMQPç®€ä»‹

**æ¦‚è¿°ï¼š**

1.å¤§å¤šåº”ç”¨ä¸­ï¼Œå¯é€šè¿‡æ¶ˆæ¯æœåŠ¡ä¸­é—´ä»¶æ¥æå‡ç³»ç»Ÿå¼‚æ­¥é€šä¿¡ã€æ‰©å±•è§£è€¦èƒ½åŠ›ã€‚

2.æ¶ˆæ¯æœåŠ¡ä¸­ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼š

- æ¶ˆæ¯ä»£ç†ï¼ˆmessage brokerï¼‰å’Œç›®çš„åœ°ï¼ˆdestinationï¼‰ã€‚
- å½“æ¶ˆæ¯å‘é€è€…å‘é€æ¶ˆæ¯ä»¥åï¼Œå°†ç”±æ¶ˆæ¯ä»£ç†æ¥ç®¡ï¼Œæ¶ˆæ¯ä»£ç†ä¿è¯æ¶ˆæ¯ä¼ é€’åˆ°æŒ‡å®šç›®çš„åœ°ã€‚

3.æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦æœ‰ä¸¤ç§å½¢å¼çš„ç›®çš„åœ°ï¼š

- é˜Ÿåˆ—ï¼ˆqueueï¼‰ï¼šç‚¹å¯¹ç‚¹æ¶ˆæ¯é€šä¿¡ï¼ˆpoint-to-pointï¼‰ã€‚
- ä¸»é¢˜ï¼ˆtopicï¼‰ï¼šå‘å¸ƒï¼ˆpublishï¼‰/è®¢é˜…ï¼ˆsubscribeï¼‰æ¶ˆæ¯é€šä¿¡ã€‚

4.ç‚¹å¯¹ç‚¹å¼ï¼š

- æ¶ˆæ¯å‘é€è€…å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä»£ç†å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆæ¯æ¥æ”¶è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å†…å®¹ï¼Œæ¶ˆæ¯è¯»å–åè¢«ç§»å‡ºé˜Ÿåˆ—ã€‚
- æ¶ˆæ¯åªæœ‰å”¯ä¸€çš„å‘é€è€…å’Œæ¥å—è€…ï¼Œä½†å¹¶ä¸æ˜¯è¯´åªèƒ½æœ‰ä¸€ä¸ªæ¥æ”¶è€…ã€‚ï¼ˆæ³¨æ„æ¥å—å’Œæ¥æ”¶çš„åŒºåˆ«ï¼‰

5.å‘å¸ƒè®¢é˜…å¼ï¼š

- å‘é€è€…ï¼ˆå‘å¸ƒè€…ï¼‰å‘é€æ¶ˆæ¯åˆ°ä¸»é¢˜ï¼Œå¤šä¸ªæ¥æ”¶è€…ï¼ˆè®¢é˜…è€…ï¼‰ç›‘å¬ï¼ˆè®¢é˜…ï¼‰è¿™ä¸ªä¸»é¢˜ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨æ¶ˆæ¯åˆ°è¾¾æ—¶åŒæ—¶æ”¶åˆ°æ¶ˆæ¯ã€‚

6.JMSï¼ˆJava Message Serviceï¼‰JAVAæ¶ˆæ¯æœåŠ¡ï¼š

- åŸºäºJVMæ¶ˆæ¯ä»£ç†çš„è§„èŒƒã€‚ActiveMQã€HornetMQæ˜¯JMSå®ç°ã€‚

7.AMQPï¼ˆAdvanced Message Queuing Protocolï¼‰ï¼š

- é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ¶ˆæ¯ä»£ç†çš„è§„èŒƒï¼Œå…¼å®¹JMSã€‚
- RabbitMQæ˜¯AMQPçš„å®ç°ã€‚

8.Springæ”¯æŒï¼š

- spring-jmsæä¾›äº†å¯¹JMSçš„æ”¯æŒã€‚
- spring-rabbitæä¾›äº†å¯¹AMQPçš„æ”¯æŒã€‚
- éœ€è¦ConnectionFactoryçš„å®ç°æ¥è¿æ¥æ¶ˆæ¯ä»£ç†ã€‚
- æä¾›JmsTemplateã€RabbitTemplateæ¥å‘é€æ¶ˆæ¯ã€‚
- @JmsListenerï¼ˆJMSï¼‰ã€@RabbitListenerï¼ˆAMQPï¼‰æ³¨è§£åœ¨æ–¹æ³•ä¸Šç›‘å¬æ¶ˆæ¯ä»£ç†å‘å¸ƒçš„æ¶ˆæ¯ã€‚
- @EnableJmsã€@EnableRabbitå¼€å¯æ”¯æŒã€‚

9.Spring Bootè‡ªåŠ¨é…ç½®ï¼š

- JmsAutoConfigurationã€‚
- RabbitAutoConfigurationã€‚

**JMSå¯¹æ¯”AMQPï¼š**

|              | JMS                                                          | AMQP                                                         |
| ------------ | :----------------------------------------------------------- | ------------------------------------------------------------ |
| å®šä¹‰         | Java  API                                                    | ç½‘ç»œçº¿çº§åè®®                                                 |
| è·¨è¯­è¨€       | å¦                                                           | æ˜¯                                                           |
| è·¨å¹³å°       | å¦                                                           | æ˜¯                                                           |
| Model        | æä¾›ä¸¤ç§æ¶ˆæ¯æ¨¡å‹ï¼šç‚¹å¯¹ç‚¹ã€å‘å¸ƒ/è®¢é˜…ã€‚                        | æä¾›äº†äº”ç§æ¶ˆæ¯æ¨¡å‹ï¼šdirect  exchangeï¼ˆç‚¹å¯¹ç‚¹ï¼‰ã€fanoutã€exchangeã€topic  changeã€headers  exchangeã€system  exchange ã€‚æœ¬è´¨æ¥è®²ï¼Œåå››ç§å’ŒJMSçš„â€œå‘å¸ƒ/è®¢é˜…â€æ¨¡å‹æ²¡æœ‰å¤ªå¤§å·®åˆ«ï¼Œä»…æ˜¯åœ¨è·¯ç”±æœºåˆ¶ä¸Šåšäº†æ›´è¯¦ç»†çš„åˆ’åˆ†ã€‚ |
| æ”¯æŒæ¶ˆæ¯ç±»å‹ | å¤šç§æ¶ˆæ¯ç±»å‹ï¼š  TextMessageã€ MapMessageã€BytesMessageã€ StreamMessageã€ObjectMessageã€Messageï¼ˆåªæœ‰æ¶ˆæ¯å¤´å’Œå±æ€§ï¼‰ã€‚ | åªæœ‰byte[]ã€‚å½“å®é™…åº”ç”¨ï¼Œæœ‰å¤æ‚çš„æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥å°†æ¶ˆæ¯åºåˆ—åŒ–åå‘é€ã€‚ |
| ç»¼åˆè¯„ä»·     | JMS  å®šä¹‰äº†JAVA  APIå±‚é¢çš„æ ‡å‡†ï¼›åœ¨javaä½“ç³»ä¸­ï¼Œå¤šä¸ªclientå‡å¯ä»¥é€šè¿‡JMSè¿›è¡Œäº¤äº’ï¼Œä¸éœ€è¦åº”ç”¨ä¿®æ”¹ä»£ç ï¼Œä½†æ˜¯å…¶å¯¹è·¨å¹³å°çš„æ”¯æŒè¾ƒå·®ã€‚ | AMQPå®šä¹‰äº†wire-levelå±‚çš„åè®®æ ‡å‡†ï¼›å¤©ç„¶å…·æœ‰è·¨å¹³å°ã€è·¨è¯­è¨€ç‰¹æ€§ã€‚ |

**åœºæ™¯ï¼š**

å¼‚æ­¥å¤„ç†ï¼š

![image-20200404173307226](SpringBootAdvanced.assets\image-20200404173307226.png)

åº”ç”¨è§£è€¦ï¼š

![image-20200404173341368](SpringBootAdvanced.assets\image-20200404173341368.png)

![image-20200404173346212](SpringBootAdvanced.assets\image-20200404173346212.png)

æµé‡å‰Šå³°ï¼š

![image-20200404173427358](SpringBootAdvanced.assets\image-20200404173427358.png)

## 2.2 RabbitMQåŸºæœ¬æ¦‚å¿µ

**RabbitMQç®€ä»‹ï¼š**

RabbitMQæ˜¯ç”±erlangå¼€å‘çš„AMQP(Advanved Message Queue Protocol)çš„å¼€æºå®ç°ã€‚

**æ ¸å¿ƒæ¦‚å¿µï¼š**

1. Meaage

   æ¶ˆæ¯ï¼Œæ¶ˆæ¯æ˜¯ä¸å…·åçš„ï¼Œå®ƒç”±æ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ç»„æˆã€‚æ¶ˆæ¯ä½“æ˜¯ä¸é€æ˜çš„ï¼Œè€Œæ¶ˆæ¯å¤´åˆ™ç”±ä¸€ç³»åˆ—çš„å¯é€‰å±æ€§ç»„æˆï¼Œè¿™äº›å±æ€§åŒ…æ‹¬routing-keyï¼ˆè·¯ç”±é”®ï¼‰ã€priorityï¼ˆç›¸å¯¹äºå…¶ä»–æ¶ˆæ¯çš„ä¼˜å…ˆæƒï¼‰ã€delivery-modeï¼ˆæŒ‡å‡ºè¯¥æ¶ˆæ¯å¯èƒ½éœ€è¦æŒä¹…æ€§å­˜å‚¨ï¼‰ç­‰ã€‚

2. Publisher

   æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼Œä¹Ÿæ˜¯å‘äº¤æ¢å™¨å‘å¸ƒæ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚

3. Exchange

   äº¤æ¢å™¨ï¼Œç”¨æ¥æ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯å¹¶å°†è¿™äº›æ¶ˆæ¯è·¯ç”±ç»™æœåŠ¡å™¨ä¸­çš„é˜Ÿåˆ—ã€‚

   Exchangeæœ‰4ç§ç±»å‹ï¼šdirect(é»˜è®¤)ã€fanoutã€topicã€å’Œheadersï¼Œä¸åŒç±»å‹çš„Exchangeè½¬å‘æ¶ˆæ¯çš„ç­–ç•¥æœ‰æ‰€åŒºåˆ«ã€‚

4. Queue

   æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜æ¶ˆæ¯ç›´åˆ°å‘é€ç»™æ¶ˆè´¹è€…ã€‚å®ƒæ˜¯æ¶ˆæ¯çš„å®¹å™¨ï¼Œä¹Ÿæ˜¯æ¶ˆæ¯çš„ç»ˆç‚¹ã€‚ä¸€ä¸ªæ¶ˆæ¯å¯æŠ•å…¥ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚æ¶ˆæ¯ä¸€ç›´åœ¨é˜Ÿåˆ—é‡Œé¢ï¼Œç­‰å¾…æ¶ˆè´¹è€…è¿æ¥åˆ°è¿™ä¸ªé˜Ÿåˆ—å°†å…¶å–èµ°ã€‚

5. Binding

   ç»‘å®šï¼Œç”¨äºæ¶ˆæ¯é˜Ÿåˆ—å’Œäº¤æ¢å™¨ä¹‹é—´çš„å…³è”ã€‚ç»‘å®šå°±æ˜¯åŸºäºè·¯ç”±é”®å°†äº¤æ¢å™¨å’Œæ¶ˆæ¯é˜Ÿåˆ—è¿æ¥èµ·æ¥çš„è·¯ç”±è§„åˆ™ï¼Œæ‰€ä»¥å¯ä»¥å°†äº¤æ¢å™¨ç†è§£æˆç”±ç»‘å®šæ„æˆçš„è·¯ç”±è¡¨ã€‚

   Exchange å’ŒQueueçš„ç»‘å®šå¯ä»¥æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚

6. Connection

   ç½‘ç»œè¿æ¥ï¼Œæ¯”å¦‚TCPè¿æ¥ã€‚

7. Channel

   ä¿¡é“ï¼Œå¤šè·¯å¤ç”¨è¿æ¥ä¸­çš„ä¸€æ¡ç‹¬ç«‹çš„åŒå‘æ•°æ®æµé€šé“ã€‚ä¿¡é“æ˜¯å»ºç«‹åœ¨çœŸå®çš„TCPè¿æ¥å†…çš„è™šæ‹Ÿè¿æ¥ï¼ŒAMQP å‘½ä»¤éƒ½æ˜¯é€šè¿‡ä¿¡é“å‘å‡ºå»çš„ï¼Œä¸ç®¡æ˜¯å‘å¸ƒæ¶ˆæ¯ã€è®¢é˜…é˜Ÿåˆ—è¿˜æ˜¯æ¥æ”¶æ¶ˆæ¯ï¼Œè¿™äº›åŠ¨ä½œéƒ½æ˜¯é€šè¿‡ä¿¡é“å®Œæˆã€‚å› ä¸ºå¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´å»ºç«‹å’Œé”€æ¯ TCP éƒ½æ˜¯éå¸¸æ˜‚è´µçš„å¼€é”€ï¼Œæ‰€ä»¥å¼•å…¥äº†ä¿¡é“çš„æ¦‚å¿µï¼Œç”¨ä»¥å¤ç”¨åŒä¸€æ¡ TCP è¿æ¥ã€‚

8. Consumer

   æ¶ˆæ¯çš„æ¶ˆè´¹è€…ï¼Œè¡¨ç¤ºä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å¾—æ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚

9. Virtual Host

   è™šæ‹Ÿä¸»æœºï¼Œè¡¨ç¤ºä¸€æ‰¹äº¤æ¢å™¨ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œç›¸å…³å¯¹è±¡ã€‚è™šæ‹Ÿä¸»æœºæ˜¯å…±äº«ç›¸åŒçš„èº«ä»½è®¤è¯å’ŒåŠ å¯†ç¯å¢ƒçš„ç‹¬ç«‹æœåŠ¡å™¨åŸŸã€‚æ¯ä¸ª vhost æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªmini ç‰ˆçš„ RabbitMQ æœåŠ¡å™¨ï¼Œæ‹¥æœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€äº¤æ¢å™¨ã€ç»‘å®šå’Œæƒé™æœºåˆ¶ã€‚vhost æ˜¯ AMQP æ¦‚å¿µçš„åŸºç¡€ï¼Œå¿…é¡»åœ¨è¿æ¥æ—¶æŒ‡å®šï¼ŒRabbitMQ é»˜è®¤çš„ vhost æ˜¯ / ã€‚

10. Broker

    è¡¨ç¤ºæ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ã€‚

**RabbitMQæ¦‚å¿µå›¾ç¤ºï¼š**

<img src="SpringBootAdvanced.assets\image-20200404195536669.png" alt="image-20200404195536669" style="zoom:80%;" />

## 2.3 RabbitMQè¿è¡Œæœºåˆ¶

**AMQP ä¸­çš„æ¶ˆæ¯è·¯ç”±ï¼š**

AMQP ä¸­æ¶ˆæ¯çš„è·¯ç”±è¿‡ç¨‹å’Œ Java å¼€å‘è€…ç†Ÿæ‚‰çš„ JMS å­˜åœ¨ä¸€äº›å·®åˆ«ï¼ŒAMQP ä¸­å¢åŠ äº† **Exchange** å’Œ **Binding** çš„è§’è‰²ã€‚ç”Ÿäº§è€…æŠŠæ¶ˆæ¯å‘å¸ƒåˆ° Exchange ä¸Šï¼Œæ¶ˆæ¯æœ€ç»ˆåˆ°è¾¾é˜Ÿåˆ—å¹¶è¢«æ¶ˆè´¹è€…æ¥æ”¶ï¼Œè€Œ Binding å†³å®šäº¤æ¢å™¨çš„æ¶ˆæ¯åº”è¯¥å‘é€åˆ°é‚£ä¸ªé˜Ÿåˆ—ã€‚

å›¾ç¤ºï¼š

![image-20200404202921450](SpringBootAdvanced.assets\image-20200404202921450.png)

**Exchange ç±»å‹ï¼š**

Exchangeåˆ†å‘æ¶ˆæ¯æ—¶æ ¹æ®ç±»å‹çš„ä¸åŒåˆ†å‘ç­–ç•¥æœ‰åŒºåˆ«ï¼Œç›®å‰å…±å››ç§ç±»å‹ï¼šdirectï¼ˆç›´è¿ï¼‰ã€fanoutï¼ˆå¹¿æ’­ï¼‰ã€topicï¼ˆæ¨¡ç³Šï¼‰ã€headers ã€‚headers åŒ¹é… AMQP æ¶ˆæ¯çš„ header è€Œä¸æ˜¯è·¯ç”±é”®ï¼Œ headers äº¤æ¢å™¨å’Œ direct äº¤æ¢å™¨å®Œå…¨ä¸€è‡´ï¼Œä½†æ€§èƒ½å·®å¾ˆå¤šï¼Œç›®å‰å‡ ä¹ç”¨ä¸åˆ°äº†ï¼Œæ‰€ä»¥ç›´æ¥çœ‹å¦å¤–ä¸‰ç§ç±»å‹ã€‚

1. Direct Exchangeï¼š

   æ¶ˆæ¯ä¸­çš„è·¯ç”±é”®ï¼ˆrouting keyï¼‰å¦‚æœå’Œ Binding ä¸­çš„ binding keyä¸€è‡´ï¼Œ äº¤æ¢å™¨å°±å°†æ¶ˆæ¯å‘åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­ã€‚è·¯ç”±é”®ä¸é˜Ÿåˆ—åå®Œå…¨åŒ¹é…ï¼Œå¦‚æœä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºè¦æ±‚è·¯ç”±é”®ä¸ºâ€œdogâ€ï¼Œåˆ™åªè½¬å‘ routing key æ ‡è®°ä¸ºâ€œdogâ€çš„æ¶ˆæ¯ï¼Œä¸ä¼šè½¬å‘â€œdog.puppyâ€ï¼Œä¹Ÿä¸ä¼šè½¬å‘â€œdog.guardâ€ç­‰ç­‰ã€‚å®ƒæ˜¯å®Œå…¨åŒ¹é…ã€å•æ’­çš„æ¨¡å¼ã€‚

   ![image-20200404204603661](SpringBootAdvanced.assets\image-20200404204603661.png)

2. Fanout Exchangeï¼š

   æ¯ä¸ªå‘åˆ° fanout ç±»å‹äº¤æ¢å™¨çš„æ¶ˆæ¯éƒ½ä¼šåˆ†åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ä¸Šå»ã€‚fanout äº¤æ¢å™¨ä¸å¤„ç†è·¯ç”±é”®ï¼Œåªæ˜¯ç®€å•çš„å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢å™¨ä¸Šï¼Œæ¯ä¸ªå‘é€åˆ°äº¤æ¢å™¨çš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸è¯¥äº¤æ¢å™¨ç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ä¸Šã€‚å¾ˆåƒå­ç½‘å¹¿æ’­ï¼Œæ¯å°å­ç½‘å†…çš„ä¸»æœºéƒ½è·å¾—äº†ä¸€ä»½å¤åˆ¶çš„æ¶ˆæ¯ã€‚fanout ç±»å‹è½¬å‘æ¶ˆæ¯æ˜¯æœ€å¿«çš„ã€‚

   ![image-20200404204729515](SpringBootAdvanced.assets\image-20200404204729515.png)

3. Topic Exchangeï¼š

   topic äº¤æ¢å™¨é€šè¿‡æ¨¡å¼åŒ¹é…åˆ†é…æ¶ˆæ¯çš„è·¯ç”±é”®å±æ€§ï¼Œå°†è·¯ç”±é”®å’ŒæŸä¸ªæ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼Œæ­¤æ—¶é˜Ÿåˆ—éœ€è¦ç»‘å®šåˆ°ä¸€ä¸ªæ¨¡å¼ä¸Šã€‚å®ƒå°†è·¯ç”±é”®å’Œç»‘å®šé”®çš„å­—ç¬¦ä¸²åˆ‡åˆ†æˆå•è¯ï¼Œè¿™äº›å•è¯ä¹‹é—´ç”¨ç‚¹éš”å¼€ã€‚å®ƒåŒæ ·ä¹Ÿä¼šè¯†åˆ«ä¸¤ä¸ªé€šé…ç¬¦ï¼šç¬¦å·â€œ#â€å’Œç¬¦å·â€œ\*â€ã€‚#åŒ¹é…0ä¸ªæˆ–å¤šä¸ªå•è¯ï¼Œ\*åŒ¹é…ä¸€ä¸ªå•è¯ã€‚

   ![image-20200404204825240](SpringBootAdvanced.assets\image-20200404204825240.png)

## 2.4 RabbitMQå®‰è£…æµ‹è¯•

**å®‰è£…ï¼š**

å»Docker Hubæœç´¢rabbitmqï¼Œåœ¨Tagsä¸­æ‰¾åˆ°æ ‡ç­¾å¸¦managementçš„é•œåƒï¼Œå¸¦managementçš„æä¾›Webæ“ä½œç•Œé¢ï¼š

![image-20200405171703287](SpringBootAdvanced.assets\image-20200405171703287.png)

å¤åˆ¶å‘½ä»¤ï¼šdocker pull rabbitmq:managementã€‚åœ¨Linuxä¸­ä½¿ç”¨è¯¥å‘½ä»¤ã€‚

æ‹‰å–å®Œå®Œé•œåƒåä½¿ç”¨docker run -d -p 5672:5672 -p 15672:15672 --name myRabbitMQ 38e57f281891è¿è¡Œä¹‹ï¼Œå…¶ä¸­5672æ˜¯å®¢æˆ·ç«¯ä¸ä¸»æœºçš„é€šè®¯ç«¯å£ï¼Œè€Œ15672æ˜¯Webç®¡ç†ç•Œé¢çš„è®¿é—®ç«¯å£ï¼š

![image-20200405174201152](SpringBootAdvanced.assets\image-20200405174201152.png)

è¿è¡Œèµ·æ¥åè®¿é—®15672ç«¯å£ï¼Œè´¦å·å¯†ç å‡ä¸ºguestï¼š

![image-20200405175050416](SpringBootAdvanced.assets\image-20200405175050416.png)

ç™»å½•åçš„ç•Œé¢ï¼š

![image-20200405175201914](SpringBootAdvanced.assets\image-20200405175201914.png)

ç‚¹å¼€Adminâ†’Usersâ†’guestï¼š

![image-20200405180623157](SpringBootAdvanced.assets\image-20200405180623157.png)

æ‰¾åˆ°Update this userï¼Œå°±èƒ½æ›´æ–°å…¶å¯†ç äº†ï¼š

![image-20200405180705070](SpringBootAdvanced.assets\image-20200405180705070.png)

**æµ‹è¯•ï¼š**

ä¸‹é¢å°†åŸºäºè¯¥å›¾è¿›è¡Œæµ‹è¯•ï¼š

![image-20200405222215776](SpringBootAdvanced.assets\image-20200405222215776.png)

å…ˆæ·»åŠ Exchangesï¼Œç‚¹å‡»å¯¼èˆªæ çš„Exchangesï¼š

![image-20200405202625244](SpringBootAdvanced.assets\image-20200405202625244.png)

åœ¨ä¸‹æ–¹æ‰¾åˆ°Add a new exchangeï¼ŒTypeé€‰directï¼Œå…¶ä¸­Durabilityå±æ€§ç”¨äºé€‰æ‹©æ˜¯å¦æŒä¹…åŒ–ï¼ŒDurableä¸ºæŒä¹…ï¼ŒTransientä¸ºæš‚æ—¶ï¼Œé€‰ä¸ºæŒä¹…æ—¶é‡å¯RabbitMQä¸ä¼šæ¸…é™¤æœ¬exchangeï¼Œå¦åˆ™ä¼šæ¸…é™¤ï¼š

![image-20200405203149403](SpringBootAdvanced.assets\image-20200405203149403.png)

Add exchangeåå…¶ä¼šå‡ºç°åœ¨All exchangesä¸­ï¼š

![image-20200405203339876](SpringBootAdvanced.assets\image-20200405203339876.png)

å†æ·»åŠ ä¸ªexchange.fanouï¼ŒTypeé€‰fanoutï¼š

![image-20200405204107195](SpringBootAdvanced.assets\image-20200405204107195.png)

ä»¥åŠexchange.topicï¼š

![image-20200405210932456](SpringBootAdvanced.assets\image-20200405210932456.png)

è¿›å…¥Queuesï¼Œæ·»åŠ Queueï¼š

![image-20200405212305074](SpringBootAdvanced.assets\image-20200405212305074.png)

å€¼å¾—æ³¨æ„çš„æ˜¯queueå¤šäº†Typeå±æ€§ï¼Œå¯é€‰Classicå’ŒQuorumï¼ŒQuorumæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä¹Ÿå¾ˆç–‘æƒ‘ï¼Œç™¾åº¦ç¿»è¯‘å‘Šè¯‰æˆ‘è¿™æ˜¯åè¯ï¼Œæ„ä¸ºï¼š(ä¼šè®®çš„)æ³•å®šäººæ•°ã€‚å†æŸ¥äº†è§£åˆ°ï¼šQuorom æœºåˆ¶ï¼Œæ˜¯ä¸€ç§åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸ç”¨çš„ï¼Œç”¨æ¥ä¿è¯æ•°æ®å†—ä½™å’Œæœ€ç»ˆä¸€è‡´æ€§çš„æŠ•ç¥¨ç®—æ³•ï¼Œå…¶ä¸»è¦æ•°å­¦æ€æƒ³æ¥æºäºé¸½å·¢åŸç†ã€‚å…·ä½“å¯çœ‹è¿™ä¸¤ç¯‡åšæ–‡ï¼šhttps://blog.csdn.net/zixiao217/article/details/81633839ã€https://blog.csdn.net/sunykk/article/details/88087213ã€‚

RabbitMQä»3.8.0ç‰ˆæœ¬å¼€å§‹æ”¯æŒQuorum Queueï¼Œå…·ä½“çœ‹è¯¥æ–‡ç« ï¼šhttps://www.oschina.net/news/110317/rabbitmq-3-8-0-releasedã€‚å®˜æ–¹å¯¹æ­¤çš„ä»‹ç»ï¼šhttp://next.rabbitmq.com/quorum-queues.htmlã€‚

ç”±äºçœ‹äº†è¿™ä¸€æ³¢è¿˜æ˜¯äº‘é‡Œé›¾é‡Œçš„ï¼Œæ‰€ä»¥å…ˆç”¨é»˜è®¤çš„classicå§ï¼Œå°†å››ä¸ªé˜Ÿåˆ—æ·»åŠ è¿›å»ï¼š

![image-20200405220309370](SpringBootAdvanced.assets\image-20200405220309370.png)

å›åˆ°Exchangesï¼Œè¿›å…¥exchange.directï¼Œç»‘å®šxuegaoé˜Ÿåˆ—ï¼š

![image-20200405215855352](SpringBootAdvanced.assets\image-20200405215855352.png)

å°†å››ä¸ªé˜Ÿåˆ—éƒ½ç»‘å®šåˆ°exchange.directä¸­ï¼Œæ³¨æ„é˜Ÿåˆ—å’ŒRouting keyæ˜¯ä¸åŒçš„ä¸œè¥¿ï¼Œåªä¸è¿‡è¿™é‡Œä¸é˜Ÿåˆ—åŒåäº†ï¼š

![image-20200405221533752](SpringBootAdvanced.assets\image-20200405221533752.png)

ä»¥åŒæ ·æ“ä½œå°†å››ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°exchange.fanoutä¸­ã€‚

exchange.topicæœ‰æ‰€ä¸åŒï¼Œè·¯ç”±é”®å¯ç”¨é€šé…ç¬¦ï¼Œ#åŒ¹é…0ä¸ªæˆ–å¤šä¸ªå•è¯ï¼Œ\*åŒ¹é…ä¸€ä¸ªå•è¯ï¼š

![image-20200405224217936](SpringBootAdvanced.assets\image-20200405224217936.png)

å›åˆ°exchange.directï¼Œä½¿ç”¨è·¯ç”±é”®xuegaoå‘é€Payloadé‡Œçš„æ¶ˆæ¯ï¼š

![image-20200405234708039](SpringBootAdvanced.assets\image-20200405234708039.png)

ç”±äºexchange.directæ˜¯å®Œå…¨åŒ¹é…çš„Directæ¨¡å¼ï¼Œæ‰€ä»¥åªä¼šæœ‰xuegaoé˜Ÿåˆ—èƒ½æ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œå¯ä»¥è¿›å…¥Queuesé¡µé¢æŸ¥çœ‹xuegaoé˜Ÿåˆ—çš„ä¿¡æ¯ï¼š

![image-20200405235338923](SpringBootAdvanced.assets\image-20200405235338923.png)

exchange.fanoutæ˜¯å¹¿æ’­æ¨¡å¼ï¼Œæ‰€ä»¥æ‰€æœ‰é˜Ÿåˆ—éƒ½åº”å½“ä¼šæœåˆ°è¯¥æ¶ˆæ¯ï¼š

![image-20200405235847416](SpringBootAdvanced.assets\image-20200405235847416.png)

è¿›å…¥Queuesé¡µé¢æŸ¥çœ‹All queueså°±èƒ½çœ‹åˆ°æ‰€æœ‰é˜Ÿåˆ—æ¶ˆæ¯Total+1äº†ï¼š

<img src="SpringBootAdvanced.assets\image-20200406000143981.png" alt="image-20200406000143981" style="zoom:80%;" />

å¯ä»¥ç‚¹å¼€æŸä¸ªé˜Ÿåˆ—Get MessageæŸ¥çœ‹ä¸€ä¸‹ï¼š

![image-20200406000302633](SpringBootAdvanced.assets\image-20200406000302633.png)

å†æ¥æµ‹è¯•exchange.topicï¼š

![image-20200406000630767](SpringBootAdvanced.assets\image-20200406000630767.png)

æŸ¥çœ‹å…¶åŒ¹é…è§„åˆ™å¯ä»¥å‘ç°xuegao.newså››ä¸ªé˜Ÿåˆ—éƒ½èƒ½åŒ¹é…ï¼š

![image-20200405224217936](SpringBootAdvanced.assets\image-20200405224217936.png)

æŸ¥çœ‹Queuesé¡µé¢å¯ä»¥éªŒè¯è¿™ç‚¹ï¼š

<img src="SpringBootAdvanced.assets\image-20200406000938172.png" alt="image-20200406000938172" style="zoom:80%;" />

å†æ¥å‘å¸ƒä¸ªCCTV.newsä¸ºè·¯ç”±é”®çš„æ¶ˆæ¯ï¼š

![image-20200406001418941](SpringBootAdvanced.assets\image-20200406001418941.png)

æ ¹æ®åŒ¹é…è§„åˆ™ï¼Œåº”è¯¥åªæœ‰kaiyuanbiji.newsã€xuegao.newsä¸¤è€…ä¼šè¢«åŒ¹é…ï¼ŒæŸ¥çœ‹ä¸¤è€…çš„Totalï¼Œç¡®å®+1äº†ï¼š

![image-20200406001750396](SpringBootAdvanced.assets\image-20200406001750396.png)

è¿›å…¥æŸ¥çœ‹Messageå†…å®¹ï¼Œä¼šå‘ç°ç‚¹å‡»Get Messageä¼šå¾—åˆ°é‡å¤çš„å†…å®¹ï¼Œè¿™æ˜¯å› ä¸ºAck Modeï¼ˆåº”ç­”æ¨¡å¼ï¼‰è¢«è®¾ä¸ºäº†Nack message requeue trueï¼Œéœ€è¦è®¾ä¸ºAck message requeue falseæ‰èƒ½ä½¿æ¶ˆæ¯è¢«åˆ é™¤æ‰ï¼š

![image-20200406002415350](SpringBootAdvanced.assets\image-20200406002415350.png)

## 2.5 RabbitTemplateå‘é€æ¥æ”¶æ¶ˆæ¯å’Œåºåˆ—åŒ–æœºåˆ¶

æ–°å»ºé¡¹ç›®ï¼š

![image-20200407220627749](SpringBootAdvanced.assets\image-20200407220627749.png)

å¯¼å…¥éœ€è¦çš„ä¾èµ–ï¼š

![image-20200407220847132](SpringBootAdvanced.assets\image-20200407220847132.png)

è¿›å…¥é¡¹ç›®çš„POMæ–‡ä»¶å¯ä»¥çœ‹åˆ°å¯¼å…¥äº†è¿™ä¸¤ä¸ªä¾èµ–ï¼š

```xml
<!--å¯¼å…¥RabbitMQåœºæ™¯æ‰€éœ€è¦çš„ä¾èµ–-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
<!--å¯¼å…¥RabbitMQæµ‹è¯•-->
<dependency>
    <groupId>org.springframework.amqp</groupId>
    <artifactId>spring-rabbit-test</artifactId>
    <scope>test</scope>
</dependency>
```

org.springframework.boot.autoconfigure.amqp.RabbitAutoConfigurationæ˜¯RabbitMQçš„è‡ªåŠ¨é…ç½®ç±»ã€‚å…¶é…ç½®äº†rabbitConnectionFactoryï¼ŒRabbitPropertieså°è£…äº†RabbitMQçš„é…ç½®ï¼ŒRabbitTemplateç”¨äºç»™RabbitMQå‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ŒAmqpAdminæ˜¯RabbitMQç³»ç»Ÿç®¡ç†åŠŸèƒ½ç»„ä»¶ã€‚

æœ‰RabbitPropertiesï¼Œæ‰€ä»¥å¯ä»¥åœ¨SpringBooté…ç½®æ–‡ä»¶ä¸­é…ç½®RabbitMQï¼Œè¿™é‡Œåªé…ç½®äº†ä¸‰ä¸ªå±æ€§ï¼Œå…¶å®è¿˜æœ‰åƒprokã€virtualHostç­‰éå¸¸å¤šå±æ€§ï¼Œä½†ç»å¤§å¤šæ•°éƒ½ä¿æŒé»˜è®¤å³å¯ï¼Œç”šè‡³è¿™é‡Œçš„usernameä¹Ÿå¯ä»¥ä¸é…ï¼Œå› ä¸ºé»˜è®¤å°±æ˜¯guestï¼š

```properties
#é…ç½®RabbitMQ
spring.rabbitmq.host=192.168.0.3
spring.rabbitmq.username=guest
spring.rabbitmq.password=123456
```

æ¥åˆ°SpringBootæµ‹è¯•ç±»ï¼Œä½¿ç”¨RabbitTemplateåšæµ‹è¯•ï¼š

```java
@SpringBootTest
class RabbitmqApplicationTests {

    @Autowired
    RabbitTemplate rabbitTemplate;
    
    @Test
    void contextLoads() {
        //messageéœ€è¦è‡ªè¡Œæ„é€ ï¼Œè‡ªå®šä¹‰æ¶ˆæ¯ä½“å†…å®¹å’Œæ¶ˆæ¯å¤´
        //rabbitTemplate.send(exchange,routeKey,message);

        //objecté»˜è®¤ä½œä¸ºæ¶ˆæ¯ä½“ï¼Œä¼ å…¥è¦å‘é€çš„å¯¹è±¡åä¼šè‡ªåŠ¨åºåˆ—åŒ–å‘é€ç»™RabbitMQ
        //rabbitTemplate.convertAndSend(exchange,routeKey,object)

        //åšä¸ªmapå¯¹è±¡ï¼Œæ”¾äº›æ•°æ®è¿›å»
        Map<String,Object> map = new HashMap<>();
        map.put("message","æ¸…æ˜æ—¶èŠ‚é›¨çº·çº·ï¼Œè·¯ä¸Šè¡Œäººæ¬²æ–­é­‚ã€‚");
        map.put("data", Arrays.asList("ä½ å¥½RabbitMQ",666,true));
        //é€‰æ‹©å•æ’­æ¨¡å¼ï¼ˆexchange.directï¼‰,è·¯ç”±é”®ä¸ºxuegao.newsï¼Œå°†mapå¯¹è±¡åºåˆ—åŒ–åå‘é€å‡ºå»
        rabbitTemplate.convertAndSend("exchange.direct","xuegao.news",map);
    }
}
```

è¿›å…¥RabbitMQçš„ç®¡ç†ç•Œé¢ï¼ŒæŸ¥çœ‹xuegao.newsé˜Ÿåˆ—çš„Messageï¼Œè¿™æ˜¯è¢«é»˜è®¤çš„JDKåºåˆ—åŒ–æœºåˆ¶æ“ä½œåçš„æ•°æ®ï¼š

![image-20200409113701848](SpringBootAdvanced.assets\image-20200409113701848.png)

å°è¯•å–å‡ºæ•°æ®ï¼š

```java
/**æ¥æ”¶æŒ‡å®šé˜Ÿåˆ—çš„æ¶ˆæ¯*/
@Test
void receive(){
    Object object = rabbitTemplate.receiveAndConvert("xuegao.news");
    System.out.println(object.getClass());
    System.out.println(object);
}
```

æ§åˆ¶å°è¾“å‡ºï¼š

![image-20200409122825914](SpringBootAdvanced.assets\image-20200409122825914.png)

æ­¤æ—¶xuegao.newsé˜Ÿåˆ—ä¸å†æ‹¥æœ‰è¯¥æ¶ˆæ¯ï¼Œå› ä¸ºä¹Ÿæ²¡æœ‰å…¶å®ƒæ¶ˆæ¯ï¼Œæ‰€ä»¥ä¸ºç©ºäº†ï¼š

![image-20200409123450223](SpringBootAdvanced.assets\image-20200409123450223.png)

å¦‚æœæƒ³åºåˆ—åŒ–ä¸ºJSONæ ¼å¼ï¼Œéœ€è¦ç”¨åˆ°org.springframework.amqp.support.converter.MessageConverteræ¥å£ï¼Œä¸‹é¢è‡ªå·±å†™é…ç½®ç±»æ¥è‡ªå®šä¹‰å®ç°æ–¹æ³•ï¼š

```java
package xuegao.learnSpringBoot.rabbitmq.config;

import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;
import org.springframework.amqp.support.converter.MessageConverter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MyAmqpConfig {

    @Bean
    public MessageConverter messageConverter(){
        return new Jackson2JsonMessageConverter();
    }
}
```

Jackson2JsonMessageConverterä¸MessageConverterçš„å±‚çº§å…³ç³»ï¼š

![image-20200409131127469](SpringBootAdvanced.assets\image-20200409131127469.png)

å†æ¬¡è¿è¡ŒRabbitmqApplicationTestsç±»ä¸‹çš„contextLoadsæ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯ã€‚ç„¶åæŸ¥çœ‹xuegao.newsé˜Ÿåˆ—çš„Messageï¼š

![image-20200409131943642](SpringBootAdvanced.assets\image-20200409131943642.png)

æ˜¾ç„¶æˆåŠŸåºåˆ—åŒ–ä¸ºJSONæ ¼å¼ï¼Œå¹¶ä¸”å¤šäº†ä¸€äº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬headersé‡Œçš„å†…å®¹ã€ç¼–ç ã€‚é‚£ä¹ˆå†è¿è¡Œreceiveæ–¹æ³•ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œå‘ç°ä¹Ÿæ˜¯èƒ½æ­£å¸¸æŸ¥è¯¢ï¼Œå’Œä¹‹å‰çš„è¾“å‡ºå¹¶æ— å·®åˆ«ã€‚

æ¥ä¸‹æ¥æµ‹è¯•è‡ªå·±çš„å¯¹è±¡èƒ½ä¸èƒ½åºåˆ—åŒ–æˆåŠŸï¼Œåˆ›å»ºxuegao.learnSpringBoot.rabbitmq.bean.Bookæ¨¡å‹ï¼ˆJackJSONä¸éœ€è¦Beanå®ç°serializableï¼‰ï¼š

```java
package xuegao.learnSpringBoot.rabbitmq.bean;

public class Book {
    private String bookName;
    private String author;

    public Book() {
    }

    public Book(String bookName, String author) {
        this.bookName = bookName;
        this.author = author;
    }

    @Override
    public String toString() {
        return "Book{" +
                "bookName='" + bookName + '\'' +
                ", author='" + author + '\'' +
                '}';
    }

    public String getBookName() {
        return bookName;
    }

    public void setBookName(String bookName) {
        this.bookName = bookName;
    }

    public String getAuthor() {
        return author;
    }

    public void setAuthor(String author) {
        this.author = author;
    }
}
```

æµ‹è¯•åºåˆ—åŒ–bookå¯¹è±¡ï¼š

```java
@Test
void testBook(){
    Book book = new Book("é‡æ„ä¹‹ç‹", "ä¸¤ä»½é›ªç³•");
    rabbitTemplate.convertAndSend("exchange.direct","xuegao.news",book);
}
```

è¿è¡Œæ–¹æ³•ï¼Œåœ¨xuegao.newsé˜Ÿåˆ—æŸ¥çœ‹æ¶ˆæ¯ï¼š

![image-20200409135920191](SpringBootAdvanced.assets\image-20200409135920191.png)

è¿è¡ŒRabbitmqApplicationTestsçš„receiveæ–¹æ³•ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œæ˜¯æ­£å¸¸çš„ï¼Œè¯´æ˜å¯ä»¥ç›´æ¥ä½¿ç”¨Objectæ¥æ”¶ä»»æ„å¯¹è±¡ï¼š

![image-20200409140257296](SpringBootAdvanced.assets\image-20200409140257296.png)

æ¥ä¸‹æ¥æµ‹è¯•å¹¿æ’­æ¨¡å¼ï¼š

```java
/*æµ‹è¯•å¹¿æ’­æ¨¡å¼*/
@Test
void testFanout(){
    Book book = new Book("ã€Šä¸€è§‰ç¡é†’åæˆäº†ä¸–ç•Œæœ€èŒã€‹", "å®ˆæ ªå¾…å¦¹");
    rabbitTemplate.convertAndSend("exchange.fanout","",book);
}
```

è¿è¡Œåèƒ½çœ‹åˆ°æ‰€æœ‰çš„é˜Ÿåˆ—éƒ½æ”¶åˆ°äº†è¯¥æ¶ˆæ¯ï¼š

<img src="SpringBootAdvanced.assets\image-20200409141938179.png" alt="image-20200409141938179" style="zoom:80%;" />

éšä¾¿ç‚¹å¼€ä¸€ä¸ªèƒ½çœ‹å…·ä½“æ¶ˆæ¯ï¼š

![image-20200409142012702](SpringBootAdvanced.assets\image-20200409142012702.png)

## 2.6 @RabbitListenerå’Œ@EnableRabbit

åˆ›å»ºBookServiceï¼š

```java
package xuegao.learnSpringBoot.rabbitmq.service;

import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Service;
import xuegao.learnSpringBoot.rabbitmq.bean.Book;

@Service
public class BookService {
    /*ç›‘å¬xuegao.newsé˜Ÿåˆ—ï¼Œåªè¦å…¶æœ‰æ¶ˆæ¯è¿›æ¥å°±èƒ½ç›‘å¬åˆ°*/
    @RabbitListener(queues = "xuegao")
    public void receive(Book book){
        System.out.println("é˜Ÿåˆ—xuegaoæœ‰æ–°æ¶ˆæ¯äº†ï¼Œæ­¤æ—¶bookçŠ¶æ€ä¸ºï¼š"+book);
    }
}
```

åœ¨ä¸»é…ç½®ç±»ä¸Šä½¿ç”¨@EnableRabbitæ³¨è§£ï¼š

```java
@EnableRabbit//å¯ç”¨RabbitMQçš„æ³¨è§£åŠŸèƒ½
@SpringBootApplication
public class RabbitmqApplication {
    public static void main(String[] args) {
        SpringApplication.run(RabbitmqApplication.class, args);
    }
}
```

å¯åŠ¨é¡¹ç›®ï¼Œè¿è¡ŒRabbitmqApplicationTestsç±»çš„testFanoutæ–¹æ³•ï¼ŒæŸ¥çœ‹RabbitmqApplicationçš„æ§åˆ¶å°è¾“å‡ºï¼Œèƒ½çœ‹åˆ°BookServiceä¸‹çš„receiveæˆåŠŸç›‘å¬åˆ°äº†xuegaoé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ï¼š

![image-20200409172943476](SpringBootAdvanced.assets\image-20200409172943476.png)

å›åˆ°BookServiceç±»é‡Œï¼Œåˆ›å»ºreceiveXuegaoEmployeesæ–¹æ³•ï¼š

```java
@RabbitListener(queues = "xuegao.employees")
public void receiveXuegaoEmployees(Message message){
    System.out.println(message.getMessageProperties());//è·å¾—æ¶ˆæ¯å¤´ä¿¡æ¯
    System.out.println(message.getBody());//è·å¾—æ¶ˆæ¯ä½“
}
```

é‡å¯é¡¹ç›®ï¼Œè¿è¡ŒRabbitmqApplicationTestsç±»çš„testFanoutæ–¹æ³•ï¼ŒæŸ¥çœ‹RabbitmqApplicationçš„æ§åˆ¶å°è¾“å‡ºï¼š

![image-20200409174544862](SpringBootAdvanced.assets\image-20200409174544862.png)

## 2.7 AmqpAdminç®¡ç†ç»„ä»¶çš„ä½¿ç”¨

å‰é¢æ˜¯ä½¿ç”¨Webç•Œé¢ç®¡ç†RabbitMQï¼Œè€Œåœ¨ä»£ç ä¸­çš„AmqpAdminä¹Ÿå¯ä»¥åšåˆ°è¿™ç‚¹ã€‚AmqpAdminæ˜¯RabbitMQç³»ç»Ÿçš„ç®¡ç†åŠŸèƒ½ç»„ä»¶ï¼Œå®ƒèƒ½åˆ›å»ºå’Œåˆ é™¤Queueã€Exchangeã€Bindingã€‚

åœ¨RabbitmqApplicationTestsä¸­å°è¯•ç”¨AmqpAdminåˆ›å»ºexchangeï¼š

```java
@Autowired
AmqpAdmin amqpAdmin;//RabbitMQç³»ç»Ÿçš„ç®¡ç†åŠŸèƒ½ç»„ä»¶

/*åˆ›å»ºäº¤æ¢æœºï¼ŒDirectExchangeä¸ºExchangeæ¥å£ä¸‹çš„å®ç°ç±»ä¹‹ä¸€*/
@Test
void creatExchange(){
    amqpAdmin.declareExchange(new DirectExchange("amqpAdmin.exchange"));//å–åä¸ºamqpAdmin.exchange
    System.out.println("amqpAdmin.exchangeåˆ›å»ºå®Œæˆ");
}
```

è¿è¡Œæµ‹è¯•ï¼ŒæŸ¥çœ‹Exchangesåˆ—è¡¨ï¼Œå¯ä»¥çœ‹åˆ°æˆåŠŸåˆ›å»ºäº†amqpAdmin.exchangeï¼š

![image-20200409185504670](SpringBootAdvanced.assets\image-20200409185504670.png)

Exchangeæ¥å£ä¸‹çš„å±‚æ¬¡å…³ç³»ï¼š

![image-20200409185620778](SpringBootAdvanced.assets\image-20200409185620778.png)

è¿˜æ˜¯åœ¨RabbitmqApplicationTestsï¼Œå°è¯•åˆ›å»ºqueueï¼š

```java
/*åˆ›å»ºé˜Ÿåˆ—*/
@Test
void creatQueue(){
    //å–åä¸ºamqpAdmin.queueï¼Œå¹¶å°†æŒä¹…åŒ–è®¾ä¸ºtrue
    amqpAdmin.declareQueue(new Queue("amqpAdmin.queue",true));
    System.out.println("amqpAdmin.queueåˆ›å»ºå®Œæˆ");
}
```

æŸ¥çœ‹queuesï¼š

![image-20200409191113580](SpringBootAdvanced.assets\image-20200409191113580.png)

æ¥ä¸‹æ¥æµ‹è¯•Bindingï¼Œå…ˆçœ‹çœ‹org.springframework.amqp.core.Bindingä¸­çš„å¸¦å‚æ„é€ ï¼š

```java
public Binding(String destination, DestinationType destinationType, String exchange, String routingKey,@Nullable Map<String, Object> arguments) {

   super(arguments);
   this.destination = destination;
   this.destinationType = destinationType;
   this.exchange = exchange;
   this.routingKey = routingKey;
}
```

åœ¨RabbitmqApplicationTestsä¸­ï¼Œæµ‹è¯•Bindingï¼š

```java
/*æµ‹è¯•Bindingï¼Œå°†exchangeå’Œqueueç»‘å®šèµ·æ¥*/
@Test
void creatBinding(){
    //ä¾æ¬¡å¡«å†™ç›®çš„åœ°ã€ç›®çš„åœ°ç±»å‹ã€äº¤æ¢æœºåã€è·¯ç”±é”®åã€å‚æ•°ï¼ˆæ¶ˆæ¯å¤´ï¼‰
    amqpAdmin.declareBinding(new Binding("amqpAdmin.queue",Binding.DestinationType.QUEUE,
			"amqpAdmin.exchange","amqp.hello",null));
}
```

æŸ¥çœ‹amqpAdmin.exchangeçš„Bindingsï¼š

![image-20200409193231754](SpringBootAdvanced.assets\image-20200409193231754.png)

AmqpAdminè¿˜æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå¯ä»¥è‡ªè¡Œé€ä¸€æµ‹è¯•ï¼š

![image-20200409193351323](SpringBootAdvanced.assets\image-20200409193351323.png)

# ä¸‰ã€æ£€ç´¢

## 3.1 Elasticsearchç®€ä»‹å’Œå®‰è£…

**ç®€ä»‹ï¼š**

åº”ç”¨ç»å¸¸éœ€è¦æ·»åŠ æ£€ç´¢åŠŸèƒ½ï¼Œå¼€æºçš„ [ElasticSearch](https://www.elastic.co/) æ˜¯ç›®å‰å…¨æ–‡æœç´¢å¼•æ“çš„é¦–é€‰ã€‚å®ƒå¯ä»¥å¿«é€Ÿçš„å­˜å‚¨ã€æœç´¢å’Œåˆ†ææµ·é‡æ•°æ®ã€‚Spring Booté€šè¿‡æ•´åˆSpring Data ElasticSearchæä¾›äº†éå¸¸ä¾¿æ·çš„æ£€ç´¢åŠŸèƒ½æ”¯æŒã€‚

Elasticsearchæ˜¯ä¸ªåˆ†å¸ƒå¼æœç´¢æœåŠ¡ï¼Œä½¿ç”¨Javaç¼–å†™ï¼Œæä¾›Restful APIï¼Œåº•å±‚åŸºäºLuceneï¼Œé‡‡ç”¨å¤šshardï¼ˆåˆ†ç‰‡ï¼‰çš„æ–¹å¼ä¿è¯æ•°æ®å®‰å…¨ï¼Œå¹¶ä¸”æä¾›è‡ªåŠ¨reshardingçš„åŠŸèƒ½ï¼Œgithubç­‰å¤§å‹çš„ç«™ç‚¹ä¹Ÿæ˜¯é‡‡ç”¨äº†ElasticSearchä½œä¸ºå…¶æœç´¢æœåŠ¡ã€‚

**æ­å»ºï¼š**

ä½¿ç”¨Dockeræ‹‰å–elasticsrarchçš„é•œåƒï¼ˆé»˜è®¤çš„latestæ ‡ç­¾ç‰ˆæœ¬æœ‰äº›è€ï¼Œæœ€æ–°ç‰ˆæœ¬å¯ä»¥è‡ªå·±å»Docker HubæŸ¥ï¼‰ï¼š

```shell
docker pull elasticsearch:7.6.2
```

æ¥ä¸‹æ¥è¦runä¸ªå®ƒçš„å®¹å™¨å‡ºæ¥ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ElasticSearchä¸€æ—¦è¿è¡Œå°±ä¼šå ç”¨2GBå†…å­˜ç”¨äºå †ï¼Œæ‰€ä»¥è‹¥ä½ çš„ç³»ç»Ÿå†…å­˜ä¸æ˜¯å¾ˆå¤Ÿçš„è¯åœ¨è¿è¡Œæ—¶åº”å½“åšå‡ºé™åˆ¶ã€‚å› ä¸ºElasticsearchä½¿ç”¨Javaç¼–å†™çš„ï¼Œæ‰€ä»¥å¯ä»¥ç”¨Javaçš„å‘½ä»¤åšå‡ºé™åˆ¶ï¼š

```shell
#-Xms256mè¡¨ç¤ºåˆå§‹å †å†…å­˜å¤§å°ä¸º256MBï¼Œ-Xmx512mè¡¨ç¤ºæœ€å¤§å †å†…å­˜ä¸º512MBï¼Œ-dåå°è¿è¡Œï¼Œ-pæš´éœ²ç«¯å£
#å…¶é»˜è®¤ç”¨9200ä½œä¸ºWebé€šä¿¡ç«¯å£ã€‚åœ¨åˆ†æ­¥å¼çš„æƒ…å†µä¸‹ï¼Œå„ç»“ç‚¹çš„é€šä¿¡é»˜è®¤ç”¨9300ç«¯å£
#å¼€å‘æ¨¡å¼ä¸‹è¿˜éœ€è¦åŠ ä¸Š-e "discovery.type=single-node"
docker run -e ES_JAVA_OPTS="-Xms256m -Xmx512m" -d -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" --name HiElasticSearch elasticsearch:7.6.2
```

è®¿é—®ç›®æ ‡ä¸»æœºçš„9200ç«¯å£ï¼ˆè¿™æ—¶å€™æˆ‘æ‰å‘ç°ç‰ˆæœ¬æœ‰äº›è€â€¦â€¦ä¸çŸ¥é“ä¸ºä»€ä¹ˆlatestæ ‡ç­¾æ˜¯è¿™ä¹ˆä¹…ä»¥å‰çš„ç‰ˆæœ¬ï¼Œç„¶åæˆ‘é‡æ–°æäº†ä¸ªæ–°çš„ğŸ˜‚ï¼‰ï¼š

![image-20200409223243881](SpringBootAdvanced.assets\image-20200409223243881.png)

è¿™æ˜¯æ–°çš„ï¼š

![image-20200409225714111](SpringBootAdvanced.assets\image-20200409225714111.png)

## 3.2 Elasticsearchå¿«é€Ÿå…¥é—¨

Elasticsearchæ˜¯æœ‰[å®˜æ–¹ä¸­æ–‡æ–‡æ¡£](https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html)çš„ï¼š

![image-20200410202440786](SpringBootAdvanced.assets\image-20200410202440786.png)

æ‰“å¼€â€œé¢å‘æ–‡æ¡£â€ï¼š

![image-20200410202721587](SpringBootAdvanced.assets\image-20200410202721587.png)

å¼€å¤´æ˜¯è¿™æ ·è¯´çš„ï¼š

- åœ¨åº”ç”¨ç¨‹åºä¸­å¯¹è±¡å¾ˆå°‘åªæ˜¯ä¸€ä¸ªç®€å•çš„é”®å’Œå€¼çš„åˆ—è¡¨ã€‚é€šå¸¸ï¼Œå®ƒä»¬æ‹¥æœ‰æ›´å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œå¯èƒ½åŒ…æ‹¬æ—¥æœŸã€åœ°ç†ä¿¡æ¯ã€å…¶ä»–å¯¹è±¡æˆ–è€…æ•°ç»„ç­‰ã€‚
- ä¹Ÿè®¸æœ‰ä¸€å¤©ä½ æƒ³æŠŠè¿™äº›å¯¹è±¡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚ä½¿ç”¨å…³ç³»å‹æ•°æ®åº“çš„è¡Œå’Œåˆ—å­˜å‚¨ï¼Œè¿™ç›¸å½“äºæ˜¯æŠŠä¸€ä¸ªè¡¨ç°åŠ›ä¸°å¯Œçš„å¯¹è±¡å¡åˆ°ä¸€ä¸ªéå¸¸å¤§çš„ç”µå­è¡¨æ ¼ä¸­ï¼šä¸ºäº†é€‚åº”è¡¨ç»“æ„ï¼Œä½ å¿…é¡»è®¾æ³•å°†è¿™ä¸ªå¯¹è±¡æ‰å¹³åŒ–â€”é€šå¸¸ä¸€ä¸ªå­—æ®µå¯¹åº”ä¸€åˆ—â€”è€Œä¸”æ¯æ¬¡æŸ¥è¯¢æ—¶åˆéœ€è¦å°†å…¶é‡æ–°æ„é€ ä¸ºå¯¹è±¡ã€‚

- Elasticsearch æ˜¯ *é¢å‘æ–‡æ¡£* çš„ï¼Œæ„å‘³ç€å®ƒå­˜å‚¨æ•´ä¸ªå¯¹è±¡æˆ– *æ–‡æ¡£*ã€‚Elasticsearch ä¸ä»…å­˜å‚¨æ–‡æ¡£ï¼Œè€Œä¸” *ç´¢å¼•* æ¯ä¸ªæ–‡æ¡£çš„å†…å®¹ï¼Œä½¿ä¹‹å¯ä»¥è¢«æ£€ç´¢ã€‚åœ¨ Elasticsearch ä¸­ï¼Œæˆ‘ä»¬å¯¹æ–‡æ¡£è¿›è¡Œç´¢å¼•ã€æ£€ç´¢ã€æ’åºå’Œè¿‡æ»¤â€”è€Œä¸æ˜¯å¯¹è¡Œåˆ—æ•°æ®ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¸åŒçš„æ€è€ƒæ•°æ®çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯ Elasticsearch èƒ½æ”¯æŒå¤æ‚å…¨æ–‡æ£€ç´¢çš„åŸå› ã€‚

æ¥ç€è¯´æ˜Elasticsearchä½¿ç”¨JSONä½œä¸ºæ–‡æ¡£çš„åºåˆ—åŒ–æ ¼å¼ï¼š

- Elasticsearch ä½¿ç”¨ JavaScript Object Notationï¼ˆæˆ–è€… [*JSON*](http://en.wikipedia.org/wiki/Json)ï¼‰ä½œä¸ºæ–‡æ¡£çš„åºåˆ—åŒ–æ ¼å¼ã€‚JSON åºåˆ—åŒ–ä¸ºå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€æ‰€æ”¯æŒï¼Œå¹¶ä¸”å·²ç»æˆä¸º NoSQL é¢†åŸŸçš„æ ‡å‡†æ ¼å¼ã€‚ å®ƒç®€å•ã€ç®€æ´ã€æ˜“äºé˜…è¯»ã€‚

- ä¸‹é¢è¿™ä¸ª JSON æ–‡æ¡£ä»£è¡¨äº†ä¸€ä¸ª user å¯¹è±¡ï¼š

  ```json
  {
      "email":      "john@smith.com",
      "first_name": "John",
      "last_name":  "Smith",
      "info": {
          "bio":         "Eco-warrior and defender of the weak",
          "age":         25,
          "interests": [ "dolphins", "whales" ]
      },
      "join_date": "2014/05/01"
  }
  ```

- è™½ç„¶åŸå§‹çš„userå¯¹è±¡å¾ˆå¤æ‚ï¼Œä½†è¿™ä¸ªå¯¹è±¡çš„ç»“æ„å’Œå«ä¹‰åœ¨ JSON ç‰ˆæœ¬ä¸­éƒ½å¾—åˆ°äº†ä½“ç°å’Œä¿ç•™ã€‚åœ¨ Elasticsearch ä¸­å°†å¯¹è±¡è½¬åŒ–ä¸º JSON åæ„å»ºç´¢å¼•è¦æ¯”åœ¨ä¸€ä¸ªæ‰å¹³çš„è¡¨ç»“æ„ä¸­è¦ç®€å•çš„å¤šã€‚

**é€‚åº”æ–°ç¯å¢ƒï¼š**

é€‚åº”æ–°ç¯å¢ƒï¼š

- ä¸ºäº†è®©å¤§å®¶å¯¹ Elasticsearch èƒ½å®ç°ä»€ä¹ˆåŠå…¶ä¸Šæ‰‹éš¾æ˜“ç¨‹åº¦æœ‰ä¸€ä¸ªåŸºæœ¬å°è±¡ï¼Œè®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„æ•™ç¨‹å¼€å§‹å¹¶ä»‹ç»ç´¢å¼•ã€æœç´¢åŠèšåˆç­‰åŸºç¡€æ¦‚å¿µã€‚
- æˆ‘ä»¬å°†ä¸€å¹¶ä»‹ç»ä¸€äº›æ–°çš„æŠ€æœ¯æœ¯è¯­ï¼Œå³ä½¿æ— æ³•ç«‹å³å…¨éƒ¨ç†è§£å®ƒä»¬ä¹Ÿæ— å¦¨ï¼Œå› ä¸ºåœ¨æœ¬ä¹¦åç»­å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ·±å…¥ä»‹ç»è¿™é‡Œæåˆ°çš„æ‰€æœ‰æ¦‚å¿µã€‚
- æ¥ä¸‹æ¥å°½æƒ…äº«å— Elasticsearch æ¢ç´¢ä¹‹æ—…ã€‚

åˆ›å»ºé›‡å‘˜ç›®å½•ï¼š

- æˆ‘ä»¬å—é›‡äº  *Megacorp* å…¬å¸ï¼Œä½œä¸º HR éƒ¨é—¨æ–°çš„ *â€œçƒ­çˆ±æ— äººæœºâ€* ï¼ˆ*"We love our drones!"*ï¼‰æ¿€åŠ±é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡æ˜¯ä¸ºæ­¤åˆ›å»ºä¸€ä¸ªå‘˜å·¥ç›®å½•ã€‚è¯¥ç›®å½•åº”å½“èƒ½åŸ¹å…»å‘˜å·¥è®¤åŒæ„ŸåŠæ”¯æŒå®æ—¶ã€é«˜æ•ˆã€åŠ¨æ€åä½œï¼Œå› æ­¤æœ‰ä¸€äº›ä¸šåŠ¡éœ€æ±‚ï¼š
  1. æ”¯æŒåŒ…å«å¤šå€¼æ ‡ç­¾ã€æ•°å€¼ã€ä»¥åŠå…¨æ–‡æœ¬çš„æ•°æ®
  2. æ£€ç´¢ä»»ä¸€å‘˜å·¥çš„å®Œæ•´ä¿¡æ¯
  3. å…è®¸ç»“æ„åŒ–æœç´¢ï¼Œæ¯”å¦‚æŸ¥è¯¢ 30 å²ä»¥ä¸Šçš„å‘˜å·¥
  4. å…è®¸ç®€å•çš„å…¨æ–‡æœç´¢ä»¥åŠè¾ƒå¤æ‚çš„çŸ­è¯­æœç´¢
  5. æ”¯æŒåœ¨åŒ¹é…æ–‡æ¡£å†…å®¹ä¸­é«˜äº®æ˜¾ç¤ºæœç´¢ç‰‡æ®µ
  6. æ”¯æŒåŸºäºæ•°æ®åˆ›å»ºå’Œç®¡ç†åˆ†æä»ªè¡¨ç›˜

**ç´¢å¼•å‘˜å·¥æ–‡æ¡£ï¼š**

- ç¬¬ä¸€ä¸ªä¸šåŠ¡éœ€æ±‚æ˜¯å­˜å‚¨å‘˜å·¥æ•°æ®ã€‚ è¿™å°†ä¼šä»¥*å‘˜å·¥æ–‡æ¡£* çš„å½¢å¼å­˜å‚¨ï¼šä¸€ä¸ªæ–‡æ¡£ä»£è¡¨ä¸€ä¸ªå‘˜å·¥ã€‚å­˜å‚¨æ•°æ®åˆ° Elasticsearch çš„è¡Œä¸ºå«åš *ç´¢å¼•* ï¼Œä½†åœ¨ç´¢å¼•ä¸€ä¸ªæ–‡æ¡£ä¹‹å‰ï¼Œéœ€è¦ç¡®å®šå°†æ–‡æ¡£å­˜å‚¨åœ¨å“ªé‡Œã€‚
- ä¸€ä¸ª Elasticsearch é›†ç¾¤å¯ä»¥åŒ…å«å¤šä¸ª*ç´¢å¼•* ï¼Œç›¸åº”çš„æ¯ä¸ªç´¢å¼•å¯ä»¥åŒ…å«å¤šä¸ª*ç±»å‹*ï¼Œä½†æ˜¯==å»ºè®®ä¸€ä¸ªç´¢å¼•åªå¯¹åº”ä¸€ä¸ªç±»å‹== ã€‚ è¿™äº›ä¸åŒçš„ç±»å‹å­˜å‚¨ç€å¤šä¸ª*æ–‡æ¡£* ï¼Œæ¯ä¸ªæ–‡æ¡£åˆæœ‰å¤šä¸ª*å±æ€§* ã€‚

å›¾ç¤ºï¼š

![image-20200410210427463](SpringBootAdvanced.assets\image-20200410210427463.png)

å¯¹äºå‘˜å·¥ç›®å½•ï¼Œæˆ‘ä»¬å°†åšå¦‚ä¸‹æ“ä½œï¼š

- æ¯ä¸ªå‘˜å·¥ç´¢å¼•ä¸€ä¸ªæ–‡æ¡£ï¼Œæ–‡æ¡£åŒ…å«è¯¥å‘˜å·¥çš„æ‰€æœ‰ä¿¡æ¯ã€‚
- æ¯ä¸ªæ–‡æ¡£éƒ½å°†æ˜¯ employee *ç±»å‹* ã€‚
- è¯¥ç±»å‹ä½äº*ç´¢å¼•* megacorp å†…ã€‚
- è¯¥ç´¢å¼•ä¿å­˜åœ¨æˆ‘ä»¬çš„Elasticsearch é›†ç¾¤ä¸­ã€‚

å®è·µä¸­è¿™éå¸¸ç®€å•ï¼ˆå°½ç®¡çœ‹èµ·æ¥æœ‰å¾ˆå¤šæ­¥éª¤ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€æ¡å‘½ä»¤å®Œæˆæ‰€æœ‰è¿™äº›åŠ¨ä½œï¼š

```json
PUT /megacorp/employee/1
{
    "first_name" : "John",
    "last_name" :  "Smith",
    "age" :        25,
    "about" :      "I love to go rock climbing",
    "interests": [ "sports", "music" ]
}
```

æ³¨æ„ï¼Œè·¯å¾„ `/megacorp/employee/1` åŒ…å«äº†ä¸‰éƒ¨åˆ†çš„ä¿¡æ¯ï¼š

- `megacorp`	ç´¢å¼•åç§°
- `employee`    ç±»å‹åç§°
- `1`                ç‰¹å®šé›‡å‘˜çš„ID

**ä½¿ç”¨Postmanæµ‹è¯•ï¼š**

é€‰æ‹©PUTç±»å‹çš„è¯·æ±‚ï¼Œ9200ä¸ºäº¤äº’ç«¯å£ï¼Œæ‰€ä»¥IPåæ¥9200ï¼Œç„¶åå¡«å†™è·¯å¾„ã€‚å†é€‰æ‹©Bodyï¼Œç‚¹å‡»rawï¼ˆåŸå§‹ï¼‰ï¼Œé€‰æ‹©JSONï¼Œå°†ä¸Šé¢çš„JSONæ•°æ®ç²˜è´´ä¸Šå»å³å¯ï¼š

![image-20200410212541685](SpringBootAdvanced.assets\image-20200410212541685.png)

æ”¶åˆ°çš„å“åº”ï¼š

```json
{
    "_index": "megacorp",
    "_type": "employee",
    "_id": "1",
    "_version": 1,
    "result": "created",
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 0,
    "_primary_term": 1
}
```

å¦‚æ³•ç‚®åˆ¶ï¼Œæ·»åŠ 2ã€3å·å‘˜å·¥ï¼š

```json
PUT /megacorp/employee/2
{
    "first_name" :  "Jane",
    "last_name" :   "Smith",
    "age" :         32,
    "about" :       "I like to collect rock albums",
    "interests":  [ "music" ]
}

PUT /megacorp/employee/3
{
    "first_name" :  "Douglas",
    "last_name" :   "Fir",
    "age" :         35,
    "about":        "I like to build cabinets",
    "interests":  [ "forestry" ]
}
```

**æ£€ç´¢æ–‡æ¡£ï¼š**

ç›®å‰æˆ‘ä»¬å·²ç»åœ¨ Elasticsearch ä¸­å­˜å‚¨äº†ä¸€äº›æ•°æ®ï¼Œ æ¥ä¸‹æ¥å°±èƒ½ä¸“æ³¨äºå®ç°åº”ç”¨çš„ä¸šåŠ¡éœ€æ±‚äº†ã€‚ç¬¬ä¸€ä¸ªéœ€æ±‚æ˜¯ï¼šå¯ä»¥æ£€ç´¢åˆ°å•ä¸ªé›‡å‘˜çš„æ•°æ®ã€‚

è¿™åœ¨ Elasticsearch ä¸­å¾ˆç®€å•ï¼Œæ‰§è¡ŒHTTP `GET` è¯·æ±‚å¹¶æŒ‡å®šæ–‡æ¡£çš„åœ°å€â€”â€”ç´¢å¼•åº“ã€ç±»å‹å’ŒIDï¼Œä½¿ç”¨è¿™ä¸‰ä¸ªä¿¡æ¯å¯ä»¥è¿”å›åŸå§‹çš„ JSON æ–‡æ¡£ï¼š

è¯·æ±‚ï¼š

```
192.168.0.3:9200/megacorp/employee/1
```

å“åº”ï¼š

```json
{
    "_index": "megacorp",
    "_type": "employee",
    "_id": "1",
    "_version": 1,
    "_seq_no": 0,
    "_primary_term": 1,
    "found": true,
    "_source": {
        "first_name": "John",
        "last_name": "Smith",
        "age": 25,
        "about": "I love to go rock climbing",
        "interests": [
            "sports",
            "music"
        ]
    }
}
```

æç¤ºï¼š

å°† HTTP å‘½ä»¤ç”± `PUT` æ”¹ä¸º `GET` å¯ä»¥ç”¨æ¥æ£€ç´¢æ–‡æ¡£ï¼ŒåŒæ ·çš„ï¼Œå¯ä»¥ä½¿ç”¨ `DELETE` å‘½ä»¤æ¥åˆ é™¤æ–‡æ¡£ï¼Œä»¥åŠä½¿ç”¨ `HEAD` æŒ‡ä»¤æ¥æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœæƒ³æ›´æ–°å·²å­˜åœ¨çš„æ–‡æ¡£ï¼Œåªéœ€å†æ¬¡ `PUT` ã€‚

æ›´æ–°å‘˜å·¥ä¿¡æ¯å¾—åˆ°çš„å“åº”ç¤ºä¾‹ï¼Œèƒ½æ³¨æ„åˆ°_versionå‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”resultä¸ºupdatedï¼š

```json
{
    "_index": "megacorp",
    "_type": "employee",
    "_id": "3",
    "_version": 2,
    "result": "updated",
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 5,
    "_primary_term": 1
}
```

**è½»é‡æœç´¢ï¼š**

ä½¿ç”¨è¯¥è¯·æ±‚æ¥æœç´¢æ‰€æœ‰é›‡å‘˜ï¼Œè¿™å‡ ä¹æ˜¯æœ€ç®€å•çš„æœç´¢äº†ï¼š

```
192.168.0.3:9200/megacorp/employee/_search
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨ç´¢å¼•åº“ `megacorp` ä»¥åŠç±»å‹ `employee`ï¼Œä½†ä¸æŒ‡å®šä¸€ä¸ªæ–‡æ¡£ ID ä¸åŒï¼Œè¿™æ¬¡ä½¿ç”¨ `_search` ã€‚è¿”å›ç»“æœåŒ…æ‹¬äº†æ‰€æœ‰ä¸‰ä¸ªæ–‡æ¡£ï¼Œæ”¾åœ¨æ•°ç»„ `hits` ä¸­ã€‚ä¸€ä¸ªæœç´¢é»˜è®¤è¿”å›åæ¡ç»“æœã€‚å“åº”å†…å®¹å¦‚ä¸‹ï¼š

```json
{
    "took": 182,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 3,
            "relation": "eq"
        },
        "max_score": 1.0,
        "hits": [
            {
                "_index": "megacorp",
                "_type": "employee",
                "_id": "1",
                "_score": 1.0,
                "_source": {
                    "first_name": "John",
                    "last_name": "Smith",
                    "age": 25,
                    "about": "I love to go rock climbing",
                    "interests": [
                        "sports",
                        "music"
                    ]
                }
            },
            {
                "_index": "megacorp",
                "_type": "employee",
                "_id": "3",
                "_score": 1.0,
                "_source": {
                    "first_name": "ä¸¤ä»½",
                    "last_name": "é›ªç³•",
                    "age": 35,
                    "about": "I like to build cabinets",
                    "interests": [
                        "forestry"
                    ]
                }
            },
            {
                "_index": "megacorp",
                "_type": "employee",
                "_id": "2",
                "_score": 1.0,
                "_source": {
                    "first_name": "Jane",
                    "last_name": "Smith",
                    "age": 32,
                    "about": "I like to collect rock albums",
                    "interests": [
                        "music"
                    ]
                }
            }
        ]
    }
}
```

æ³¨æ„ï¼šè¿”å›ç»“æœä¸ä»…å‘ŠçŸ¥åŒ¹é…äº†å“ªäº›æ–‡æ¡£ï¼Œè¿˜åŒ…å«äº†æ•´ä¸ªæ–‡æ¡£æœ¬èº«ï¼šæ˜¾ç¤ºæœç´¢ç»“æœç»™æœ€ç»ˆç”¨æˆ·æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ã€‚

æ¥ä¸‹æ¥ï¼Œå°è¯•ä¸‹æœç´¢å§“æ°ä¸º``Smith`` çš„é›‡å‘˜ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨*é«˜äº®* æœç´¢ã€‚è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬æ¶‰åŠåˆ°*æŸ¥è¯¢å­—ç¬¦ä¸²* ï¼ˆ*query-string*ï¼‰æœç´¢ï¼Œä¹Ÿå°±æ˜¯ç”¨qæ¥æŒ‡å®šï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡URLå‚æ•°æ¥ä¼ é€’æŸ¥è¯¢ä¿¡æ¯ç»™æœç´¢æ¥å£ï¼š

```
192.168.0.3:9200/megacorp/employee/_search?q=last_name:Smith
```

æˆ‘ä»¬ä»ç„¶åœ¨è¯·æ±‚è·¯å¾„ä¸­ä½¿ç”¨ `_search` ç«¯ç‚¹ï¼Œå¹¶å°†æŸ¥è¯¢æœ¬èº«èµ‹å€¼ç»™å‚æ•° `q=` ã€‚è¿”å›ç»“æœç»™å‡ºäº†æ‰€æœ‰last_nameå±æ€§ä¸ºSmithçš„å‘˜å·¥ä¿¡æ¯ï¼š

```json
{
    "took": 64,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": 0.52354836,
        "hits": [
            {
                "_index": "megacorp",
                "_type": "employee",
                "_id": "1",
                "_score": 0.52354836,
                "_source": {
                    "first_name": "John",
                    "last_name": "Smith",
                    "age": 25,
                    "about": "I love to go rock climbing",
                    "interests": [
                        "sports",
                        "music"
                    ]
                }
            },
            {
                "_index": "megacorp",
                "_type": "employee",
                "_id": "2",
                "_score": 0.52354836,
                "_source": {
                    "first_name": "Jane",
                    "last_name": "Smith",
                    "age": 32,
                    "about": "I like to collect rock albums",
                    "interests": [
                        "music"
                    ]
                }
            }
        ]
    }
}
```

**ä½¿ç”¨æŸ¥è¯¢è¡¨è¾¾å¼æœç´¢ï¼š**

Query-string æœç´¢é€šè¿‡å‘½ä»¤éå¸¸æ–¹ä¾¿åœ°è¿›è¡Œä¸´æ—¶æ€§çš„å³å¸­æœç´¢  ï¼Œä½†å®ƒæœ‰è‡ªèº«çš„å±€é™æ€§ï¼ˆå‚è§ [*è½»é‡* æœç´¢](https://www.elastic.co/guide/cn/elasticsearch/guide/current/search-lite.html) ï¼‰ã€‚Elasticsearch æä¾›äº†ä¸°å¯Œçµæ´»çš„æŸ¥è¯¢è¯­è¨€ï¼Œå«åš *æŸ¥è¯¢è¡¨è¾¾å¼* ï¼Œ å®ƒæ”¯æŒæ„å»ºæ›´åŠ å¤æ‚å’Œå¥å£®çš„æŸ¥è¯¢ã€‚

*é¢†åŸŸç‰¹å®šè¯­è¨€* ï¼ˆDSLï¼‰ï¼Œ ä¸‹é¢ä½¿ç”¨ JSON æ„é€ äº†è¯·æ±‚ã€‚å¯ä»¥åƒè¿™æ ·é‡å†™ä¹‹å‰çš„æŸ¥è¯¢æ‰€æœ‰åä¸º Smith çš„æœç´¢ ï¼š

è¯·æ±‚ï¼š

```
192.168.0.3:9200/megacorp/employee/_search
```

Bodyï¼š

```json
{
    "query" : {
        "match" : {
            "last_name" : "Smith"
        }
    }
}
```

è¿”å›ç»“æœä¸ä¹‹å‰çš„æŸ¥è¯¢ä¸€æ ·ï¼Œä½†è¿˜æ˜¯å¯ä»¥çœ‹åˆ°æœ‰ä¸€äº›å˜åŒ–ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯ï¼Œä¸å†ä½¿ç”¨ *query-string* å‚æ•°ï¼Œè€Œæ˜¯ç”±è¯·æ±‚ä½“æ›¿ä»£ã€‚è¿™ä¸ªè¯·æ±‚ä½¿ç”¨ JSON æ„é€ ï¼Œå¹¶ä½¿ç”¨äº†`match` æŸ¥è¯¢ï¼ˆå±äºæŸ¥è¯¢ç±»å‹ä¹‹ä¸€ï¼Œåé¢å°†ç»§ç»­ä»‹ç»ï¼‰ã€‚

**æ›´å¤æ‚çš„çš„æœç´¢ï¼š**

ç°åœ¨å°è¯•ä¸‹æ›´å¤æ‚çš„æœç´¢ã€‚ åŒæ ·æœç´¢å§“æ°ä¸º Smith çš„å‘˜å·¥ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬åªéœ€è¦å¹´é¾„å¤§äº 30 çš„ã€‚æŸ¥è¯¢éœ€è¦ç¨ä½œè°ƒæ•´ï¼Œä½¿ç”¨è¿‡æ»¤å™¨ *filter* ï¼Œå®ƒæ”¯æŒé«˜æ•ˆåœ°æ‰§è¡Œç»“æ„åŒ–æŸ¥è¯¢ã€‚

è¿˜æ˜¯GETè¯·æ±‚ï¼š

```
192.168.0.3:9200/megacorp/employee/_search
```

Bodyï¼š

- filteré‡Œæ˜¯`range` *è¿‡æ»¤å™¨* ï¼Œ å®ƒèƒ½æ‰¾åˆ°å¹´é¾„å¤§äº 30 çš„æ–‡æ¡£ï¼Œå…¶ä¸­ `gt` è¡¨ç¤º_å¤§äº_(*great than*)ã€‚

```json
{
    "query" : {
        "bool": {
            "must": {
                "match" : {
                    "last_name" : "smith" 
                }
            },
            "filter": {
                "range" : {
                    "age" : { "gt" : 30 } 
                }
            }
        }
    }
}
```

å“åº”ï¼š

```json
{
    "took": 28,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 1,
            "relation": "eq"
        },
        "max_score": 0.52354836,
        "hits": [
            {
                "_index": "megacorp",
                "_type": "employee",
                "_id": "2",
                "_score": 0.52354836,
                "_source": {
                    "first_name": "Jane",
                    "last_name": "Smith",
                    "age": 32,
                    "about": "I like to collect rock albums",
                    "interests": [
                        "music"
                    ]
                }
            }
        ]
    }
}
```

**å…¨æ–‡æœç´¢ï¼š**

æˆªæ­¢ç›®å‰çš„æœç´¢ç›¸å¯¹éƒ½å¾ˆç®€å•ï¼šå•ä¸ªå§“åï¼Œé€šè¿‡å¹´é¾„è¿‡æ»¤ã€‚ç°åœ¨å°è¯•ä¸‹ç¨å¾®é«˜çº§ç‚¹å„¿çš„å…¨æ–‡æœç´¢ï¼Œä¼ ç»Ÿæ•°æ®åº“å¾ˆéš¾æå®šçš„ä»»åŠ¡ã€‚

æœç´¢ä¸‹æ‰€æœ‰å–œæ¬¢æ”€å²©ï¼ˆrock climbingï¼‰çš„å‘˜å·¥ï¼š

- è¯·æ±‚ï¼š

  ```
  192.168.0.3:9200/megacorp/employee/_search
  ```

- Bodyï¼š

  ```json
  {
      "query" : {
          "match" : {
              "about" : "rock climbing"
          }
      }
  }
  ```

- å“åº”ï¼š

  ```json
  {
      "took": 53,
      "timed_out": false,
      "_shards": {
          "total": 1,
          "successful": 1,
          "skipped": 0,
          "failed": 0
      },
      "hits": {
          "total": {
              "value": 2,
              "relation": "eq"
          },
          "max_score": 1.4167401,
          "hits": [
              {
                  "_index": "megacorp",
                  "_type": "employee",
                  "_id": "1",
                  "_score": 1.4167401,
                  "_source": {
                      "first_name": "John",
                      "last_name": "Smith",
                      "age": 25,
                      "about": "I love to go rock climbing",
                      "interests": [
                          "sports",
                          "music"
                      ]
                  }
              },
              {
                  "_index": "megacorp",
                  "_type": "employee",
                  "_id": "2",
                  "_score": 0.4589591,
                  "_source": {
                      "first_name": "Jane",
                      "last_name": "Smith",
                      "age": 32,
                      "about": "I like to collect rock albums",
                      "interests": [
                          "music"
                      ]
                  }
              }
          ]
      }
  }
  ```

å¯ä»¥æ³¨æ„ä¸‹æŸ¥è¯¢åˆ°çš„ç»“æœä¸­çš„_scoreå±æ€§ã€‚

ç›¸å…³æ€§å¾—åˆ†ï¼š

- Elasticsearch  é»˜è®¤æŒ‰ç…§ç›¸å…³æ€§å¾—åˆ†æ’åºï¼Œå³æ¯ä¸ªæ–‡æ¡£è·ŸæŸ¥è¯¢çš„åŒ¹é…ç¨‹åº¦ã€‚ç¬¬ä¸€ä¸ªæœ€é«˜å¾—åˆ†çš„ç»“æœå¾ˆæ˜æ˜¾ï¼šJohn Smith çš„ `about` å±æ€§æ¸…æ¥šåœ°å†™ç€ â€œrock climbingâ€ ã€‚
- ä½†ä¸ºä»€ä¹ˆ Jane Smith ä¹Ÿä½œä¸ºç»“æœè¿”å›äº†å‘¢ï¼ŸåŸå› æ˜¯å®ƒçš„`about` å±æ€§é‡Œæåˆ°äº† â€œrockâ€ ã€‚å› ä¸ºåªæœ‰ â€œrockâ€ è€Œæ²¡æœ‰ â€œclimbingâ€ ï¼Œæ‰€ä»¥å¥¹çš„ç›¸å…³æ€§å¾—åˆ†ä½äº John çš„ã€‚
- è¿™æ˜¯ä¸ªå¾ˆå¥½çš„æ¡ˆä¾‹ï¼Œé˜æ˜äº†Elasticsearchå¦‚ä½• *åœ¨* å…¨æ–‡å±æ€§ä¸Šæœç´¢å¹¶è¿”å›ç›¸å…³æ€§æœ€å¼ºçš„ç»“æœã€‚Elasticsearchä¸­çš„ *ç›¸å…³æ€§*  æ¦‚å¿µéå¸¸é‡è¦ï¼Œä¹Ÿæ˜¯å®Œå…¨åŒºåˆ«äºä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“çš„ä¸€ä¸ªæ¦‚å¿µï¼Œä¼ ç»Ÿæ•°æ®åº“ä¸­çš„è®°å½•è¦ä¹ˆåŒ¹é…è¦ä¹ˆä¸åŒ¹é…ã€‚

**çŸ­è¯­æœç´¢ï¼š**

æ‰¾å‡ºå±æ€§ä¸­çš„ç‹¬ç«‹å•è¯æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æœ‰æ—¶å€™æƒ³è¦ç²¾ç¡®åŒ¹é…ä¸€ç³»åˆ—å•è¯æˆ–è€…_çŸ­è¯­_ ã€‚ æ¯”å¦‚ï¼Œ æˆ‘ä»¬æƒ³æ‰§è¡Œè¿™æ ·çš„æŸ¥è¯¢ï¼šä»…åŒ¹é…åŒæ—¶åŒ…å« â€œrockâ€ *å’Œ* â€œclimbingâ€ ï¼Œ*å¹¶ä¸”*  äºŒè€…ä»¥çŸ­è¯­ â€œrock climbingâ€ çš„å½¢å¼ç´§æŒ¨ç€çš„é›‡å‘˜è®°å½•ã€‚

ä¸ºæ­¤å¯¹ `match` æŸ¥è¯¢ç¨ä½œè°ƒæ•´ï¼Œä½¿ç”¨ `match_phrase` æŸ¥è¯¢ï¼š

- è¯·æ±‚ï¼š

  ```
  192.168.0.3:9200/megacorp/employee/_search
  ```

- Bodyï¼š

  ```json
  {
      "query" : {
          "match_phrase" : {
              "about" : "rock climbing"
          }
      }
  }
  ```

- å“åº”ï¼š

  ```json
  {
      "took": 19,
      "timed_out": false,
      "_shards": {
          "total": 1,
          "successful": 1,
          "skipped": 0,
          "failed": 0
      },
      "hits": {
          "total": {
              "value": 1,
              "relation": "eq"
          },
          "max_score": 1.4167401,
          "hits": [
              {
                  "_index": "megacorp",
                  "_type": "employee",
                  "_id": "1",
                  "_score": 1.4167401,
                  "_source": {
                      "first_name": "John",
                      "last_name": "Smith",
                      "age": 25,
                      "about": "I love to go rock climbing",
                      "interests": [
                          "sports",
                          "music"
                      ]
                  }
              }
          ]
      }
  }
  ```

ä¸å‡ºæ‰€æ–™ï¼Œè¿”å›ç»“æœä»…æœ‰ John Smith çš„æ–‡æ¡£ã€‚

**é«˜äº®æœç´¢ï¼š**

è®¸å¤šåº”ç”¨éƒ½å€¾å‘äºåœ¨æ¯ä¸ªæœç´¢ç»“æœä¸­ *é«˜äº®*  éƒ¨åˆ†æ–‡æœ¬ç‰‡æ®µï¼Œä»¥ä¾¿è®©ç”¨æˆ·çŸ¥é“ä¸ºä½•è¯¥æ–‡æ¡£ç¬¦åˆæŸ¥è¯¢æ¡ä»¶ã€‚åœ¨ Elasticsearch ä¸­æ£€ç´¢å‡ºé«˜äº®ç‰‡æ®µä¹Ÿå¾ˆå®¹æ˜“ã€‚

å†æ¬¡æ‰§è¡Œå‰é¢çš„æŸ¥è¯¢ï¼Œå¹¶ä½¿ç”¨ `highlight` å‚æ•°ï¼š

- è¯·æ±‚ï¼š

  ```
  192.168.0.3:9200/megacorp/employee/_search
  ```

- Bodyï¼š

  ```json
  {
      "query" : {
          "match_phrase" : {
              "about" : "rock climbing"
          }
      },
      "highlight": {
          "fields" : {
              "about" : {}
          }
      }
  }
  ```

- å“åº”ï¼š

  ```json
  {
      "took": 105,
      "timed_out": false,
      "_shards": {
          "total": 1,
          "successful": 1,
          "skipped": 0,
          "failed": 0
      },
      "hits": {
          "total": {
              "value": 1,
              "relation": "eq"
          },
          "max_score": 1.4167401,
          "hits": [
              {
                  "_index": "megacorp",
                  "_type": "employee",
                  "_id": "1",
                  "_score": 1.4167401,
                  "_source": {
                      "first_name": "John",
                      "last_name": "Smith",
                      "age": 25,
                      "about": "I love to go rock climbing",
                      "interests": [
                          "sports",
                          "music"
                      ]
                  },
                  "highlight": {
                      "about": [
                          "I love to go <em>rock</em> <em>climbing</em>"
                      ]
                  }
              }
          ]
      }
  }
  ```

å½“æ‰§è¡Œè¯¥æŸ¥è¯¢æ—¶ï¼Œè¿”å›ç»“æœè¾ƒä¹‹å‰å¤šäº† `highlight` éƒ¨åˆ†ã€‚è¯¥éƒ¨åˆ†åŒ…å«äº† `about` å±æ€§åŒ¹é…çš„æ–‡æœ¬ç‰‡æ®µï¼Œå¹¶ä»¥ HTML æ ‡ç­¾ <em></em> å°è£…ã€‚

## 3.3 SpringBootæ•´åˆJestæ¥æ“ä½œElasticsearch

åˆ›å»ºæ–°é¡¹ç›®ï¼š

![image-20200411154003943](SpringBootAdvanced.assets\image-20200411154003943.png)

æ·»åŠ Webå’ŒElasticsearchåœºæ™¯ï¼š

![image-20200411155347975](SpringBootAdvanced.assets\image-20200411155347975.png)

åˆ›å»ºå¥½é¡¹ç›®åï¼Œå†POMæ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€æ®µé…ç½®ï¼Œå®ƒç”¨äºå¼•å…¥Elasticsearchåœºæ™¯ï¼š

```xml
<!--å¼•å…¥Elasticsearchåœºæ™¯ï¼ŒSpringBooté»˜è®¤ä½¿ç”¨SpringData ElasticSearchæ¨¡å—è¿›è¡Œæ“ä½œ-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

æ³¨æ„ä¸‹è¿™ä¸¤ä¸ªåŒ…å†…çš„ç±»ï¼š

- org.springframework.boot.autoconfigure.data.elasticsearch

- org.springframework.boot.autoconfigure.elasticsearch.jest

- åœ¨é¡¹ç›®ç»“æ„çš„External Librariesä¸­å¯ä»¥æ‰¾åˆ°

  ![image-20200411171359762](SpringBootAdvanced.assets\image-20200411171359762.png)

  ![image-20200411171137951](SpringBootAdvanced.assets\image-20200411171137951.png)

  ![image-20200411171152564](SpringBootAdvanced.assets\image-20200411171152564.png)

SpringBooté»˜è®¤æ”¯æŒä¸¤ç§æŠ€æœ¯æ¥å’ŒElasticsearchäº¤äº’ï¼š

- Jestï¼ˆä»¥è¿‡æ—¶ï¼‰ï¼š
  - é»˜è®¤ä¸ç”Ÿæ•ˆï¼Œéœ€è¦å¯¼å…¥Jestçš„å·¥å…·åŒ…ã€‚
  - Jestä»¥è¿‡æ—¶ï¼Œæ‰€ä»¥ä»2.2.0å¼€å§‹æ”¯æŒå…¶å®ƒè‡ªåŠ¨é…ç½®çš„Elasticsearchå®¢æˆ·ç«¯ã€‚

- SpringData ElasticSearchï¼š

  - ElasticsearchAutoConfigurationæ˜¯Elasticsearchçš„è‡ªåŠ¨é…ç½®ç±»ï¼Œå…¨éƒ¨æºç å¯ä»¥è‡ªå·±å»ç¿»ï¼š

    - ```java
      @Bean
      @ConditionalOnMissingBean
      public TransportClient elasticsearchClient() throws Exception {
         TransportClientFactoryBean factory = new TransportClientFactoryBean();
         factory.setClusterNodes(this.properties.getClusterNodes());
         factory.setProperties(createProperties());
         factory.afterPropertiesSet();
         return factory.getObject();
      }
      
      private Properties createProperties() {
         Properties properties = new Properties();
         properties.put("cluster.name", this.properties.getClusterName());
         properties.putAll(this.properties.getProperties());
         return properties;
      }
      ```

    - å®ƒé…ç½®äº†Clientçš„èŠ‚ç‚¹ä¿¡æ¯ï¼ŒåŒ…æ‹¬ClusterNodesã€ClusterNameç­‰ã€‚

  - ä½¿ç”¨org.springframework.data.elasticsearch.core.ElasticsearchTemplateæ¥æ“ä½œElasticsearchã€‚

  - ç¼–å†™org.springframework.data.elasticsearch.repository.ElasticsearchRepositoryçš„å­æ¥å£æ¥æ“ä½œElasticsearchã€‚

  - Elasticsearch Clientsï¼š

    - Transport Clientï¼š
      - ä»Elasticsearch 7å¼€å§‹ä¸æ¨èä½¿ç”¨ä¼—æ‰€å‘¨çŸ¥çš„TransportClientï¼Œå¹¶å°†åœ¨Elasticsearch 8ä¸­å°†å…¶åˆ é™¤ã€‚ï¼ˆè¯·å‚é˜…Elasticsearchæ–‡æ¡£ï¼‰ã€‚
      - å¼ºçƒˆå»ºè®®ä½¿ç”¨High Level REST Clientè€Œä¸æ˜¯TransportClientã€‚
    - High Level REST Clientï¼š
      - ä»2.2.0å¼€å§‹æ”¯æŒHigh Level REST Clientï¼Œå¹¶ä¸”æ˜¯é»˜è®¤å®¢æˆ·ç«¯ã€‚
    - ReactiveElasticsearchClientï¼š
      - ReactiveElasticsearchClientæ˜¯åŸºäºWebClientçš„éå®˜æ–¹é©±åŠ¨ç¨‹åºã€‚å®ƒä½¿ç”¨Elasticsearchæ ¸å¿ƒé¡¹ç›®æä¾›çš„è¯·æ±‚/å“åº”å¯¹è±¡ã€‚
    - å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-data/elasticsearch/docs/3.2.6.RELEASE/reference/html/#elasticsearch.clients

**ä½¿ç”¨Jestæ“ä½œElasticsearchï¼š**

å¼•å…¥Jestï¼ˆæœ€å¥½è¦å’ŒElasticsearchå¯¹åº”ç‰ˆæœ¬ï¼‰ï¼š

```xml
<!-- https://mvnrepository.com/artifact/io.searchbox/jest -->
<dependency>
    <groupId>io.searchbox</groupId>
    <artifactId>jest</artifactId>
    <version>6.3.1</version>
</dependency>
```

å¯é…ç½®é¡¹äºorg.springframework.boot.autoconfigure.elasticsearch.jest.JestPropertiesæŸ¥çœ‹ã€‚

å»SpringBooté…ç½®æ–‡ä»¶ä¸­é…ç½®uriså‚æ•°ï¼Œè¿æ¥ä½ çš„æœåŠ¡å™¨ï¼Œè¯¥å‚æ•°æ˜¯æ•°ç»„ï¼Œå¯ç”¨é€—å·åˆ†éš”å¤šä¸ªå‚æ•°ï¼Œé»˜è®¤IPæ˜¯localhostï¼š

```properties
spring.elasticsearch.jest.uris=http://192.168.64.128:9200/
```

å¯åŠ¨é¡¹ç›®ï¼Œæ§åˆ¶å°è¾“å‡ºæ˜¯è¿™æ ·çš„ï¼Œæ²¡æœ‰æŠ¥é”™å³å¯ï¼š

```
2020-04-12 21:17:28.380  INFO 13676 --- [           main] io.searchbox.client.AbstractJestClient   : Setting server pool to a list of 1 servers: [http://192.168.0.3:9200/]
```

åˆ›å»ºxuegao.learnSpringBoot.elasticsearch.bean.Articleæ¨¡å‹ï¼Œå¹¶ä¸ºæ‰€æœ‰å±æ€§æ·»åŠ GetSetæ–¹æ³•ï¼š

```java
package xuegao.learnSpringBoot.elasticsearch.bean;

import io.searchbox.annotations.JestId;

public class Article {
    @JestId
    private Integer id;//ä½¿ç”¨@JestIdå‘Šè¯‰Jestè¿™æ˜¯ä¸»é”®
    private String author;
    private String title;
    private String content;

	/*çœç•¥GetSetæ–¹æ³•çš„ä»£ç â€¦â€¦*/
}
```

æ¥ä¸‹æ¥åœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œå°è¯•ç´¢å¼•æ–‡æ¡£ï¼š

```java
package xuegao.learnSpringBoot.elasticsearch;

import io.searchbox.client.JestClient;
import io.searchbox.core.Index;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import xuegao.learnSpringBoot.elasticsearch.bean.Article;

import java.io.IOException;

@SpringBootTest
class ElasticsearchApplicationTests {
    @Autowired
    JestClient jestClient;

    @Test
    void contextLoads() {
        Article article = new Article();
        article.setId(1);
        article.setTitle("é—ªè€€æš–æš–");
        article.setAuthor("å çº¸");
        article.setContent("æ¡ƒä¹‹å¤­å¤­ï¼Œç¼ç¼å…¶åã€‚");

        //åœ¨Elasticsearchä¸­ç´¢å¼•ï¼ˆä¿å­˜ï¼‰æ–‡æ¡£ï¼Œè¿™æ ·ä¿å­˜çš„ç´¢å¼•è·¯å¾„ä¸º/xuegao/article
        Index index = new Index.Builder(article).index("xuegao").type("article").build();
        try {
            jestClient.execute(index);//æ‰§è¡Œindexï¼Œå¯èƒ½ä¼šæŠ›å‡ºIOå¼‚å¸¸
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

}
```

è®¿é—®æ–‡æ¡£ï¼š

![image-20200413214601070](SpringBootAdvanced.assets\image-20200413214601070.png)

æµ‹è¯•æœç´¢ï¼š

```java
//æµ‹è¯•æœç´¢
@Test
void search() throws IOException {
    //æŸ¥è¯¢è¡¨è¾¾å¼ï¼ŒæŸ¥è¯¢contentå±æ€§ä¸­å¸¦â€œå¤­å¤­â€çš„æ–‡æ¡£
    String json = "{\n" +
            "    \"query\" : {\n" +
            "        \"match\" : {\n" +
            "            \"content\" : \"å¤­å¤­\"\n" +
            "        }\n" +
            "    }\n" +
            "}";
    //ä½¿ç”¨ä¸Šé¢çš„æŸ¥è¯¢è¡¨è¾¾å¼ï¼Œæ„å»ºæœç´¢åŠŸèƒ½ï¼ŒæŸ¥è¯¢æŒ‡å®šç´¢å¼•â†’ç±»å‹ä¸‹çš„æ–‡æ¡£
    Search search = new Search.Builder(json).addIndex("xuegao").addType("article").build();
    //æ‰§è¡Œsearchï¼Œå¯èƒ½ä¼šæŠ›å‡ºIOå¼‚å¸¸ã€‚æ‰§è¡Œåæœ‰è¿”å›å€¼ï¼Œå¯ä»¥å¾—åˆ°å¾ˆå¤šä¿¡æ¯ï¼Œè¿™é‡Œåªæ‰“å°JSONæ ¼å¼çš„å“åº”ä¿¡æ¯ã€‚
    SearchResult result = jestClient.execute(search);
    System.out.println(result.getJsonString());
}
```

æ§åˆ¶å°ï¼Œè¿™è¡ŒJSONå¾ˆé•¿ï¼Œå°±ä¸è´´äº†ï¼Œåæ­£æ•°æ®å’Œå‰é¢æµè§ˆå™¨æŸ¥åˆ°çš„æ˜¯ä¸€æ ·çš„ï¼š

![image-20200413221629894](SpringBootAdvanced.assets\image-20200413221629894.png)

å…³äºJestçš„æ›´å¤šæ“ä½œå¯ä»¥çœ‹GitHubé‡ŒJestçš„æ–‡æ¡£ï¼šhttps://github.com/searchbox-io/Jestã€‚

## 3.4 æ•´åˆSpringDataElasticsearch

åœ¨é¡¹ç›®çš„POMæ–‡ä»¶ä¸­å¯ç”¨Spring Data ElasticSearchæ¨¡å—ï¼ŒåŸå…ˆçš„Jestä¾èµ–å¯ä»¥ä¸åˆ é™¤ï¼š

```xml
<!--
å¼•å…¥Elasticsearchåœºæ™¯ï¼ŒSpringBooté»˜è®¤ä½¿ç”¨Spring Data ElasticSearchæ¨¡å—è¿›è¡Œæ“ä½œã€‚
Spring Data ElasticSearchæ¨¡å—å’ŒJestå®¢æˆ·ç«¯å¯ä»¥å…±å­˜ã€‚
-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

åŸæ•™ç¨‹ä¸­ä½¿ç”¨çš„æ˜¯ç°åœ¨å·²ç»ä¸è¢«æ¨èä½¿ç”¨çš„é…ç½®é¡¹ï¼ŒIDEAæç¤ºThe transport client support is deprecatedï¼ˆä¼ è¾“å®¢æˆ·ç«¯æ”¯æŒå·²å¼ƒç”¨ï¼‰ï¼Œä½†è¿™é‡Œè¿˜æ˜¯æµ‹è¯•ä¸‹ï¼ŒäºSpringBooté…ç½®æ–‡ä»¶é…ç½®ï¼š

```properties
spring.data.elasticsearch.cluster-name=docker-cluster
spring.data.elasticsearch.cluster-nodes=192.168.0.3:9300
```

cluster-nameå¯é€šè¿‡è®¿é—®9200ç«¯å£å“åº”çš„æ•°æ®è·å–ï¼š

```json
{
  "name" : "d024e351d8d1",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "RYD7g5S6TVObhMOO5DL9QQ",
  "version" : {
    "number" : "7.6.2",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "ef48eb35cf30adf4db14086e8aabd07ef6fb113f",
    "build_date" : "2020-03-26T06:34:37.794943Z",
    "build_snapshot" : false,
    "lucene_version" : "8.4.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

cluster-nodesä¸ºä¸»æœºåœ°å€åŠ ä¸Š9300ç«¯å£ï¼ˆå„ç»“ç‚¹çš„é€šä¿¡é»˜è®¤ç”¨9300ç«¯å£ï¼‰ã€‚

é…ç½®å¥½åç›´æ¥å¯åŠ¨é¡¹ç›®ï¼ŒåŸæ•™ç¨‹ä¸­å‡ºç°è¶…æ—¶é”™è¯¯ï¼Œæˆ‘å¹¶æ²¡æœ‰å‡ºç°ï¼Œä½†è¿˜æ˜¯è®°å½•ä¸€ä¸‹é—®é¢˜è§£å†³æ–¹æ³•ã€‚è€å¸ˆåœ¨è§†é¢‘ä¸­è¯´Elasticsearchç‰ˆæœ¬å¯èƒ½ä¼šå‡ºç°ä¸åˆé€‚çš„æƒ…å†µï¼Œæˆ‘æŸ¥çœ‹äº†ä¸‹SpringBoot2.2.6çš„Elasticsearchæ˜¯6.8.7ç‰ˆæœ¬çš„ï¼š

![image-20200414234139386](SpringBootAdvanced.assets\image-20200414234139386.png)

æˆ‘è£…åœ¨æœåŠ¡å™¨çš„Elasticsearchç‰ˆæœ¬ä¸º7.6.2ã€‚è¯¥ç½‘å€å±•ç¤ºäº†Spring Data Elasticsearchä¸Elasticsearchçš„ç‰ˆæœ¬å¯¹åº”å…³ç³»https://docs.spring.io/spring-data/elasticsearch/docs/3.2.0.RC3/reference/html/#preface.versionsï¼Œè¿™é‡Œå°†ç‰ˆæœ¬è¡¨æ ¼æ‘˜å½•å‡ºæ¥ï¼ˆä½ ä¹Ÿå¯ä»¥è‡ªè¡Œå»å®˜ç½‘spring data elasticsearchç›¸å…³çš„æ–‡æ¡£æŸ¥è¯´æ˜ï¼‰ï¼š

| Spring Data Elasticsearch | Elasticsearch |
| :-----------------------: | :-----------: |
|           3.2.x           |     6.8.1     |
|           3.1.x           |     6.2.2     |
|           3.0.x           |     5.5.0     |
|           2.1.x           |     2.4.0     |
|           2.0.x           |     2.2.0     |
|           1.3.x           |     1.5.2     |

æ‰“å¼€é¡¹ç›®POMï¼ŒæŸ¥çœ‹ä¾èµ–å…³ç³»å›¾ï¼Œæ‰¾åˆ°spring-data-elasticsearchï¼Œèƒ½çœ‹åˆ°å…¶ç‰ˆæœ¬å·ä¸º3.2.6ï¼š

![image-20200417221115753](SpringBootAdvanced.assets\image-20200417221115753.png)

å¦‚æœå‡ºç°äº†ç‰ˆæœ¬ä¸é€‚é…çš„é—®é¢˜æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š

1. å‡çº§SpringBootçš„ç‰ˆæœ¬ã€‚
2. å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„Elasticsearchï¼Œå³æ›´æ¢æœåŠ¡å™¨ä¸Šçš„Elasticsearchç‰ˆæœ¬ã€‚

é‡å¯é¡¹ç›®åº”å½“ä¸ä¼šæŠ¥é”™ã€‚

åˆ›å»ºBookæ¨¡å‹ä¸ºåé¢çš„æ“ä½œåšå‡†å¤‡ï¼š

```java
package xuegao.learnSpringBoot.elasticsearch.bean;

import org.springframework.data.elasticsearch.annotations.Document;

//@Documentç”¨äºå£°æ˜è¯¥æ–‡æ¡£ä½äºElasticsearchä»“åº“çš„liangfenxuegaoç´¢å¼•â†’bookç±»å‹ä¸‹
@Document(indexName = "liangfenxuegao",type = "book")
public class Book {
    private Integer id;
    private String bookName;
    private String author;
 
    /*çœç•¥GetSetã€toStringæ–¹æ³•â€¦â€¦*/
}
```

è¿™é‡Œè¯´ä¸‹æˆ‘è¸©å‘äº†ï¼Œ@Documentçš„indexNameå±æ€§æˆ‘å…ˆç”¨çš„xuegaoï¼Œä½†æ˜¯åé¢æµ‹è¯•æ·»åŠ æ–‡æ¡£æ—¶é¡¹ç›®å¯åŠ¨å¤±è´¥ï¼š

```
Failed to load ApplicationContext
```

å…³é”®é”™è¯¯åœ¨äºï¼š

```
nested exception is java.lang.IllegalArgumentException: Rejecting mapping update to [xuegao] as the final mapping would have more than 1 type: [article, book]
```

æ„æ€æ˜¯æ‹’ç»å¯¹[xuegao]çš„æ˜ å°„æ›´æ–°ï¼Œå› ä¸ºæœ€ç»ˆæ˜ å°„å°†å…·æœ‰è¶…è¿‡1ä¸ªç±»å‹ï¼š[articleï¼Œbook]ã€‚è¿™å…¶å®å’Œ3.2èŠ‚ä¸­çš„ï¼šâ€œå»ºè®®ä¸€ä¸ªç´¢å¼•åªå¯¹åº”ä¸€ä¸ªç±»å‹â€å¯¹ä¸Šäº†ï¼Œä¹Ÿå°±æ˜¯xuegaoç´¢å¼•ä¸‹å·²ç»æœ‰articleï¼Œä¸èƒ½å†æ”¾bookç±»å‹äº†ã€‚æ‰€ä»¥æˆ‘å°†@Documentçš„indexNameå±æ€§æ”¹ä¸ºliangfenxuegaoã€‚

**Spring Data Elasticsearchä¹‹Transport Clientçš„å‡ ç§ç”¨æ³•ï¼š**

- ç¼–å†™org.springframework.data.repository.CrudRepositoryçš„å­æ¥å£æ¥æ“ä½œElasticsearchã€‚

  - åˆ›å»ºBookCrudRepositoryï¼š

    ```java
    package xuegao.learnSpringBoot.elasticsearch.repository;
    
    import org.springframework.data.repository.CrudRepository;
    import xuegao.learnSpringBoot.elasticsearch.bean.Book;
    import java.util.List;
    
    //CrudRepository<Book, Integer>è¡¨ç¤ºè¦æ“ä½œçš„ç±»å‹ä¸ºBookï¼Œå…¶ä¸»é”®ç±»å‹ä¸ºIntegerã€‚
    public interface BookCrudRepository extends CrudRepository<Book, Integer> {
        /*
         * é™¤äº†ç»§æ‰¿çˆ¶æ¥å£çš„æ–¹æ³•ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰æ–¹æ³•ï¼Œå…³äºæ€ä¹ˆå®šä¹‰æ–¹æ³•ï¼Œä½¿å…¶ä¸ºä½ æƒ³è¦çš„æŸ¥è¯¢æ–¹å¼å·¥ä½œï¼Œéœ€è¦æŸ¥çœ‹SpringBootå®˜æ–¹æ–‡æ¡£ã€‚
         * å…·ä½“ä½äºå®˜æ–¹æ–‡æ¡£çš„Spring Data Elasticsearchçš„Elasticsearch Repositoriesä¸‹ã€‚
         * https://docs.spring.io/spring-data/elasticsearch/docs/3.2.6.RELEASE/reference/html/#elasticsearch.repositoriesã€‚
       * */
        List<Book> findByBookName(String bookName);
    }
    ```
  
  - åœ¨å•å…ƒæµ‹è¯•ä¸­å°è¯•ä¿å­˜æ–‡æ¡£ï¼š
  
    ```java
    @Autowired
    BookCrudRepository bookCrudRepository;
    
    //æ·»åŠ ç´¢å¼•ï¼Œå†…å®¹ä¸ºbookæ–‡æ¡£ï¼ŒBookç±»ä¸Šéœ€è¦ç”¨@Documentæ³¨è§£
    @Test
    void bookCrudRepositoryIndex(){
        Book book = new Book();
        book.setId(1);
        book.setBookName("ä¹Œäº‘ä¹‹ä¸Š");
        book.setAuthor("ä¸¤ä»½é›ªç³•");
     	bookCrudRepository.save(book);
    
      	System.out.println("é€šè¿‡IDæŸ¥æ‰¾ï¼š"+bookCrudRepository.findById(1));
        System.out.println("é€šè¿‡ä¹¦åæŸ¥æ‰¾ï¼š"+bookCrudRepository.findByBookName("ä¹Œäº‘"));
    }
    ```
  
  - æ§åˆ¶å°è¾“å‡ºï¼š
  
    ```
    é€šè¿‡IDæŸ¥æ‰¾ï¼šOptional[Book{id=1, bookName='ä¹Œäº‘ä¹‹ä¸Š', author='ä¸¤ä»½é›ªç³•'}]
    é€šè¿‡ä¹¦åæŸ¥æ‰¾ï¼š[Book{id=1, bookName='ä¹Œäº‘ä¹‹ä¸Š', author='ä¸¤ä»½é›ªç³•'}]
    ```
  
- é€šè¿‡org.springframework.data.elasticsearch.repository.ElasticsearchRepositoryçš„å­æ¥å£æ¥æ“ä½œElasticsearchã€‚

  - åˆ›å»ºBookElasticsearchRepositoryï¼š

    ```java
    package xuegao.learnSpringBoot.elasticsearch.repository;
    
    import org.springframework.data.elasticsearch.repository.ElasticsearchRepository;
    import xuegao.learnSpringBoot.elasticsearch.bean.Book;
    import java.util.List;
    
    public interface BookElasticsearchRepository extends ElasticsearchRepository<Book,Integer> {
        List<Book> findByAuthorLike(String author);
    }
    ```

  - åœ¨å•å…ƒæµ‹è¯•ä¸­å°è¯•ä¿å­˜æ–‡æ¡£ï¼š

    ```java
    //ç¼–å†™ElasticsearchRepositoryçš„å­æ¥å£æ¥æ“ä½œElasticsearch
    @Autowired
    BookElasticsearchRepository bookElasticsearchRepository;
    
    //æ·»åŠ ç´¢å¼•ï¼Œå†…å®¹ä¸ºbookæ–‡æ¡£ï¼ŒBookç±»ä¸Šéœ€è¦ç”¨@Documentæ³¨è§£
    @Test
    void bookElasticsearchRepository(){
        Book book = new Book();
        book.setId(2);
        book.setBookName("é£äº‘ä¹‹ä¸‹");
        book.setAuthor("æ¢¦å±¿åƒå¯»");
        bookElasticsearchRepository.index(book);
    
        System.out.println(bookElasticsearchRepository.findById(2));
        System.out.println(bookElasticsearchRepository.findByAuthorLike("åƒå¯»"));
    }
    ```

  - è¿è¡Œåçš„æ§åˆ¶å°è¾“å‡ºï¼š

    ```
    Optional[Book{id=2, bookName='é£äº‘ä¹‹ä¸‹', author='æ¢¦å±¿åƒå¯»'}]
    [Book{id=2, bookName='é£äº‘ä¹‹ä¸‹', author='æ¢¦å±¿åƒå¯»'}]
    ```

- ä½¿ç”¨org.springframework.data.elasticsearch.core.ElasticsearchTemplateæ¥æ“ä½œElasticsearchã€‚

  - ç›´æ¥æµ‹è¯•ï¼š

    ```java
    //ä½¿ç”¨Transport Clientçš„ElasticsearchTemplate
    @Autowired
    ElasticsearchTemplate elasticsearchTemplate;
    
    //å•å­—ç¬¦ä¸²æ¨¡ç³ŠæŸ¥è¯¢ï¼Œé»˜è®¤æ’åºï¼Œå°†ä»æ‰€æœ‰å­—æ®µä¸­æŸ¥æ‰¾åŒ…å«ä¼ æ¥çš„wordåˆ†è¯åå­—ç¬¦ä¸²çš„æ•°æ®é›†ã€‚
    @Test
    void testElasticsearchTemplate(){
        String author = "é›ªç³•";//ä½¿ç”¨queryStringQueryå®Œæˆå•å­—ç¬¦ä¸²æŸ¥è¯¢
        SearchQuery searchQuery = new NativeSearchQueryBuilder().withQuery(QueryBuilders.queryStringQuery(author)).build();
        List<Book> books = elasticsearchTemplate.queryForList(searchQuery, Book.class);
        System.out.println(books);
    }
    ```

  - æ§åˆ¶å°è¾“å‡ºï¼š

    ```
    [Book{id=1, bookName='ä¹Œäº‘ä¹‹ä¸Š', author='ä¸¤ä»½é›ªç³•'}]
    ```

**Spring Data Elasticsearchä¹‹ä½¿ç”¨RestClientï¼š**

https://github.com/spring-projects/spring-data-elasticsearchä¸­æåˆ°äº†ä¸å†æ¨èä½¿ç”¨Transport Clientï¼Œè€Œæ˜¯ä½¿ç”¨RestClientï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä½¿ç”¨RestClientè¿æ¥Elasticsearchï¼š

```properties
spring.elasticsearch.rest.uris=http://106.13.166.140:9200
```

æµ‹è¯•ï¼š

```java
//ä½¿ç”¨RestHighLevelClient
@Autowired
RestHighLevelClient restHighLevelClient;

@Test
void testRestHighLevelClient() throws IOException {
    //å®ä¾‹åŒ–book
    Book book = new Book();
    book.setId(11);
    book.setBookName("å¤©æ‰å‰‘ä»™çš„å¾’å¼Ÿä¸ºä½•æ˜¯æˆ‘è¿™ä¸ªåºŸæ");
    book.setAuthor("ä½ä»“ç”Ÿç”Ÿå­");
    //ä½¿ç”¨Jacksonçš„ObjectMapperç±»å°†bookåºåˆ—åŒ–ä¸ºJSONæ ¼å¼
    ObjectMapper objectMapper = new ObjectMapper();
    String source = objectMapper.writeValueAsString(book);

    /*
    IndexRequest()é‡Œç¬¬äºŒä¸ªå‚æ•°ä½¿ç”¨_docçš„åŸå› æ˜¯æˆ‘ä¹‹å‰ç”¨bookï¼Œæ§åˆ¶å°é‡Œæç¤ºï¼šSpecifying types in document index requests is deprecated, use the typeless endpoints instead (/{index}/_doc/{id}, /{index}/_doc, or /{index}/_create/{id})
    */
    IndexRequest indexRequest = new IndexRequest("liangfenxuegao", "_doc","11");
    indexRequest.source(source, XContentType.JSON);
    restHighLevelClient.index(indexRequest);
}
```

è®¿é—®http://192.168.0.3:9200/liangfenxuegao/_doc/11åå¾—åˆ°çš„å“åº”ï¼š

```json
{
  "_index": "liangfenxuegao",
  "_type": "_doc",
  "_id": "11",
  "_version": 1,
  "_seq_no": 1,
  "_primary_term": 1,
  "found": true,
  "_source": {
    "id": 11,
    "bookName": "å¤©æ‰å‰‘ä»™çš„å¾’å¼Ÿä¸ºä½•æ˜¯æˆ‘è¿™ä¸ªåºŸæ",
    "author": "ä½ä»“ç”Ÿç”Ÿå­"
  }
}
```

å…¶å®è¿˜æœ‰ Reactive Clientç­‰å®¢æˆ·ç«¯ï¼Œä»¥åŠéJavaè¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€è¯´äº†ã€‚

## 3.5 æ–°ç‰ˆæœ¬RestClient

æˆ‘åœ¨ä½¿ç”¨RestClientçš„è¿‡ç¨‹ä¸­å‘ç°æœ‰å¤§é‡è¢«å¼ƒç”¨çš„æ–¹æ³•ï¼Œä¸å¾—ä¸åæ§½ä¸€ä¸‹ç‰ˆæœ¬æ›´æ–°çš„å˜åŒ–å¤ªå¤§äº†ã€‚

å»ºè®®ä½¿ç”¨RestClientå‰å…ˆå»æŸ¥çœ‹å¯¹åº”ç‰ˆæœ¬çš„æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html ã€‚

# å››ã€ä»»åŠ¡

## 4.1 å¼‚æ­¥ä»»åŠ¡

åœ¨Javaåº”ç”¨ä¸­ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯é€šè¿‡åŒæ­¥çš„æ–¹å¼æ¥å®ç°äº¤äº’å¤„ç†çš„ï¼Œä½†æ˜¯åœ¨å¤„ç†ä¸ç¬¬ä¸‰æ–¹ç³»ç»Ÿäº¤äº’çš„æ—¶å€™ï¼Œå®¹æ˜“é€ æˆå“åº”è¿Ÿç¼“çš„æƒ…å†µã€‚ä¹‹å‰å¤§éƒ¨åˆ†éƒ½æ˜¯ä½¿ç”¨å¤šçº¿ç¨‹æ¥å®Œæˆæ­¤ç±»ä»»åŠ¡ï¼Œå…¶å®ï¼Œåœ¨Spring 3.xä¹‹åï¼Œå°±å·²ç»å†…ç½®äº†@Asyncæ¥å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

åˆ›å»ºæ–°é¡¹ç›®ï¼š

![image-20200422190042038](SpringBootAdvanced.assets\image-20200422190042038.png)

æ·»åŠ Spring Webåœºæ™¯ï¼š

![image-20200422203737806](SpringBootAdvanced.assets\image-20200422203737806.png)

åˆ›å»ºAsyncServiceç±»ï¼Œç”¨Thread.sleep(300)ä»¤çº¿ç¨‹ç¡çœ ä¸‰ç§’ï¼š

```java
package xuegao.learnSpringBoot.task.service;

import org.springframework.stereotype.Service;

@Service
public class AsyncService {

    public void helloAsync(){
        try {
            Thread.sleep(3000);//ä»¤çº¿ç¨‹ç¡çœ ä¸‰ç§’
            System.out.println("å¼‚æ­¥ä½ å¥½");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

åˆ›å»ºAsyncControllerç±»ï¼Œè°ƒç”¨AsyncServiceç±»é‡Œçš„æ–¹æ³•ï¼š

```java
package xuegao.learnSpringBoot.task.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import xuegao.learnSpringBoot.task.service.AsyncService;
import javax.annotation.Resource;

@RestController
public class AsyncController {
    @Resource(name = "asyncService")
    AsyncService asyncService;

    @GetMapping("hi")
    String hi(){
        asyncService.helloAsync();//ä»¥åŒæ­¥æ–¹å¼å·¥ä½œæ—¶ï¼Œä¼šå…ˆç­‰å¾…è¯¥æ–¹æ³•æ‰§è¡Œå®Œæˆå†è¿è¡Œä¸‹é¢çš„ä»£ç 
        return "Hiï¼";
    }
}
```

åœ¨æµè§ˆå™¨å‘hiè¯·æ±‚ï¼Œä½ ä¼šå‘ç°å»¶è¿Ÿä¸‰ç§’ä»¥ä¸Šæ‰å¾—åˆ°å“åº”ï¼š

![image-20200422212500271](SpringBootAdvanced.assets\image-20200422212500271.png)

æ§åˆ¶å°ä¹Ÿä¼šå¾—åˆ°å“åº”ï¼š

![image-20200422215623269](SpringBootAdvanced.assets\image-20200422215623269.png)

è¿™æ˜¯å› ä¸ºç›®å‰ä»¥åŒæ­¥æ–¹å¼å·¥ä½œï¼Œå¯ä»¥é€šè¿‡@Asyncå‘Šè¯‰SpringBootè¿™æ˜¯å¼‚æ­¥æ–¹æ³•ï¼š

```java
@Service
public class AsyncService {
    @Async//å‘Šè¯‰SpringBootè¿™æ˜¯å¼‚æ­¥æ–¹æ³•
    public void helloAsync(){
    	/*çœç•¥â€¦â€¦*/   
    }
}
```

è¿˜éœ€è¦åœ¨ä¸»é…ç½®ç±»ç”¨@EnableAsyncæ¥å¯ç”¨Asyncæ³¨è§£åŠŸèƒ½ï¼š

```java
@EnableAsync//å¯ç”¨Asyncæ³¨è§£ï¼Œæ‰èƒ½ä½¿ç”¨@Async
@SpringBootApplication
public class TaskApplication {
    public static void main(String[] args) {
        SpringApplication.run(TaskApplication.class, args);
    }
}
```

é‡å¯é¡¹ç›®ï¼Œä½ ä¼šå‘ç°å‘hiè¯·æ±‚åï¼Œé¡µé¢é©¬ä¸Šä¼šå¾—åˆ°å“åº”ï¼Œè€Œæ§åˆ¶å°çš„â€œå¼‚æ­¥ä½ å¥½â€ä»æœ‰ä¸‰ç§’å»¶è¿Ÿã€‚è¯´æ˜AsyncServiceç±»çš„helloAsyncæ–¹æ³•ç¡®å®ä»¥å¼‚æ­¥æ–¹å¼å·¥ä½œäº†ã€‚

æ³¨æ„ï¼š

- åœ¨ä½¿ç”¨@Asyncçš„æ—¶å€™åˆ‡è®°ä¸è¦åœ¨ä¸€ä¸ªç±»é‡Œé¢è°ƒç”¨@Asyncå£°æ˜çš„æ–¹æ³•ï¼Œä¼šäº§ç”Ÿä»£ç†ç»•è¿‡é—®é¢˜ã€‚

## 4.2 å®šæ—¶ä»»åŠ¡

é¡¹ç›®å¼€å‘ä¸­ç»å¸¸éœ€è¦æ‰§è¡Œä¸€äº›å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚éœ€è¦åœ¨æ¯å¤©å‡Œæ™¨æ—¶å€™ï¼Œåˆ†æä¸€æ¬¡å‰ä¸€å¤©çš„æ—¥å¿—ä¿¡æ¯ã€‚Springä¸ºæˆ‘ä»¬æä¾›äº†å¼‚æ­¥æ‰§è¡Œä»»åŠ¡è°ƒåº¦çš„æ–¹å¼ï¼Œæä¾›TaskExecutor ã€TaskScheduler æ¥å£ã€‚

åˆ›å»ºScheduledServiceç±»æ¥æµ‹è¯•@Scheduledæ³¨è§£ï¼š

```java
package xuegao.learnSpringBoot.task.service;

import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

@Service
public class ScheduledService {
    /**
     * @Scheduled
     *  cronçš„ç”¨æ³•:
     *      å…±å…­ä½ï¼Œä¾æ¬¡ä¸ºç§’ã€åˆ†ã€æ—¶ã€å¤©ã€æœˆã€å‘¨ã€‚
     *      å¯ä»¥é€šè¿‡ç‰¹æ®Šå­—ç¬¦æ¥ä»£è¡¨ç‰¹æ®Šå«ä¹‰ã€‚
     *      ä¾‹å¦‚"0 * * * * MON-FRI"è¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨äº”ï¼Œæ¯åˆ†é’Ÿé‡Œï¼Œç§’æ•°ä¸º0æ—¶éƒ½æ‰§è¡Œè¯¥æ–¹æ³•ã€‚
     * */
    @Scheduled(cron = "0 * * * * MON-FRI")
    public void hi(){
        System.out.println("Hiï¼");
    }
}
```

è¿™æ ·è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦åœ¨ä¸»é…ç½®ç±»ç§å¯ç”¨@Scheduledæ³¨è§£ï¼š

```java
@EnableScheduling//å¯ç”¨Schedulingæ³¨è§£ï¼Œæ‰èƒ½ä½¿ç”¨@Scheduled
@SpringBootApplication
public class TaskApplication {
    public static void main(String[] args) {
        SpringApplication.run(TaskApplication.class, args);
    }
}
```

è¿™æ ·å¯åŠ¨é¡¹ç›®åï¼Œåœ¨å‘¨ä¸€è‡³å‘¨äº”ï¼Œæ¯åˆ†é’Ÿé‡Œç§’æ•°ä¸º0æ—¶éƒ½ä¼šåœ¨Consoleæ‰“å°â€Hi!â€œï¼š

```
Hiï¼
Hiï¼
```

cronè¡¨è¾¾å¼ï¼š

| **å­—æ®µ** | **å…è®¸å€¼**                          | **å…è®¸çš„ç‰¹æ®Šå­—ç¬¦** |
| -------- | ----------------------------------- | ------------------ |
| ç§’       | 0-59                                | , -  * /           |
| åˆ†       | 0-59                                | , -  * /           |
| å°æ—¶     | 0-23                                | , -  * /           |
| æ—¥æœŸ     | 1-31                                | , -  * ? / L W C   |
| æœˆä»½     | 1-12                                | , -  * /           |
| æ˜ŸæœŸ     | 0-7æˆ–SUN-SATï¼ˆ0å’Œ7éƒ½æ˜¯å‘¨æ—¥çš„æ„æ€ ï¼‰ | , -  * ? / L C #   |

ç‰¹æ®Šå­—ç¬¦çš„å«ä¹‰ï¼š

| **ç‰¹æ®Šå­—ç¬¦** | **ä»£è¡¨å«ä¹‰**               |
| ------------ | -------------------------- |
| ,            | æšä¸¾                       |
| -            | åŒºé—´                       |
| *            | ä»»æ„                       |
| /            | æ­¥é•¿                       |
| ?            | æ—¥/æ˜ŸæœŸå†²çªåŒ¹é…            |
| L            | æœ€å                       |
| W            | å·¥ä½œæ—¥                     |
| C            | å’Œcalendarè”ç³»åè®¡ç®—è¿‡çš„å€¼ |
| #            | æ˜ŸæœŸï¼Œ4#2ï¼Œç¬¬2ä¸ªæ˜ŸæœŸå››     |

é€šè¿‡é€—å·æ¥æšä¸¾å¤šä¸ªï¼š

```java
//è¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨äº”ï¼Œæ¯åˆ†é’Ÿé‡Œï¼Œç§’æ•°ä¸º0,1,2,3,4æ—¶éƒ½æ‰§è¡Œè¯¥æ–¹æ³•ã€‚
@Scheduled(cron = "0,1,2,3,4 * * * * MON-FRI")
```

é€šè¿‡çŸ­æ¨ªæ è¡¨ç¤ºåŒºé—´ï¼š

```java
//è¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨äº”ï¼Œæ¯åˆ†é’Ÿé‡Œï¼Œç§’æ•°ä¸º0,1,2,3,4æ—¶éƒ½æ‰§è¡Œè¯¥æ–¹æ³•ã€‚
@Scheduled(cron = "0-4 * * * * MON-FRI")
```

é€šè¿‡æ–œæ è¡¨ç¤ºæ­¥é•¿ï¼š

```java
//è¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨äº”ï¼Œæ¯è¿‡å››ç§’éƒ½æ‰§è¡Œè¯¥æ–¹æ³•ã€‚
@Scheduled(cron = "0/4 * * * * MON-FRI")
```

æ›´é«˜çº§çš„ç»„åˆç”¨æ³•ï¼š

```java
//æ¯é€¢å½“æœˆæœ€åä¸€ä¸ªå·¥ä½œæ—¥å‡Œæ™¨2ç‚¹ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•
@Scheduled(cron = "0 0 2 LW * ?")
```

å…¶å®è¡¨è¾¾å¼æèµ·æ¥ä¹ŸæŒºçƒ¦äººçš„ï¼Œæ‰€ä»¥æˆ‘ä¸ªäººæ¨èä½¿ç”¨cronè¡¨è¾¾å¼ç”Ÿæˆå™¨æ¥å®Œæˆå·¥ä½œï¼Œè´´ä¸ªcronåœ¨çº¿ç”Ÿæˆå™¨http://www.qqe2.com/dev/cronã€‚

å¦å¤–è¯´ä¸€ä¸‹ç‰¹æ®Šå­—ç¬¦ï¼Œé—®å·ï¼Œçš„ä½œç”¨ã€‚ä¾‹å¦‚ä½ æŒ‡å®šæ¯å‘¨éƒ½è¦è¿è¡Œï¼Œä½†åˆæŒ‡å®šäº†æ¯æœˆçš„ç¬¬1å¤©ä¸è¿è¡Œï¼Œé‚£æ˜¾ç„¶æœ‰å†²çªï¼Œæ˜¯ä¼šå‡ºé”™çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨é—®å·æ¥ä½¿å‘¨ä¸ç”Ÿæ•ˆï¼š

```
* * * 1 * ? 
```

## 4.3 é‚®ä»¶ä»»åŠ¡

åœ¨é¡¹ç›®çš„POMæ–‡ä»¶ä¸­å¼•å…¥spring-boot-starter-mailï¼š

```xml
<!--ä½¿ç”¨é‚®ä»¶å‘é€ä»»åŠ¡éœ€è¦å¼•å…¥spring-boot-starter-mailå¯åŠ¨å™¨-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

åœ¨org.springframework.boot.autoconfigure.mailä¸‹æœ‰è¿™å‡ ä¸ªç±»ï¼Œç”¨äºè‡ªåŠ¨é…ç½®ç­‰åŠŸèƒ½ï¼ŒMailPropertiesä¸­æœ‰è®¸å¤šå±æ€§å¯é…ç½®ï¼š

![image-20200423233648256](SpringBootAdvanced.assets\image-20200423233648256.png)

æ”¶å‘é‚®ä»¶çš„è¿‡ç¨‹ç¤ºä¾‹ï¼š

<img src="SpringBootAdvanced.assets\image-20200423233900538.png" alt="image-20200423233900538" style="zoom:80%;" />

è¿›è¡Œé¡¹ç›®çš„mailä»»åŠ¡é…ç½®å‰ï¼Œéœ€è¦å…ˆæœ‰æ”¯æŒPOP3/SMTPç­‰æœåŠ¡çš„é‚®ç®±è´¦å·ï¼Œä»¥QQé‚®ç®±ä¸ºä¾‹ï¼Œè¿›å…¥è®¾ç½®â†’è´¦æˆ·ï¼š

![image-20200423235042051](SpringBootAdvanced.assets\image-20200423235042051.png)

åœ¨ä¸‹æ–¹æœ‰å¼€å¯æœåŠ¡çš„å†…å®¹ï¼š

![image-20200423235132878](SpringBootAdvanced.assets\image-20200423235132878.png)

ä¾‹å¦‚å¼€å¯IMAP/SMTPæœåŠ¡ï¼Œä¼šå¼¹å‡ºå¯¹è¯æ¡†ï¼Œå…·ä½“æ€ä¹ˆæ“ä½œå°±ä¸è¯´äº†ï¼š

![image-20200423235312763](SpringBootAdvanced.assets\image-20200423235312763.png)

æœ‰äº†æˆæƒç åï¼Œå»SpringBoot Profileé…ç½®ç›¸å…³å±æ€§ã€‚QQé‚®ç®±çš„SMTPåŸŸåä¸ºsmtp.qq.comã€‚163é‚®ç®±çš„ä¸ºsmtp.163.comï¼Œå…¶å®è¿™äº›ä¿¡æ¯éƒ½å¯ä»¥è‡ªå·±å»æ‰¾ã€‚

```properties
#é…ç½®é‚®ç®±çš„è´¦å·å¯†ç 
    spring.mail.username=liangfenxuegao@163.com
    spring.mail.password=æˆ‘æ˜¯æˆæƒç 
#é…ç½®SMTPæœåŠ¡å™¨çš„æœåŠ¡å™¨ä¸»æœºä½ç½®
    spring.mail.host=smtp.163.com
```

æ¥æµ‹è¯•ä¸€ä¸‹ï¼ˆæ³¨æ„message.setFromè¦å’Œä¸Šé¢SpringBoot Profileä¸­é…ç½®çš„è´¦å·ä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼‰ï¼š

```java
package xuegao.learnSpringBoot.task;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSenderImpl;

@SpringBootTest
class TaskApplicationTests {
    @Autowired
    JavaMailSenderImpl mailSender;//å¼•å…¥JavaMailSenderå®ç°

    @Test
    void contextLoads() {
        //å®ä¾‹åŒ–ç®€å•é‚®ä»¶æ¶ˆæ¯ï¼Œè¯¥ç±»æä¾›äº†ä¸€äº›ç®€å•çš„æ–¹æ³•
        SimpleMailMessage message = new SimpleMailMessage();
        //è®¾ç½®æ¶ˆæ¯
        message.setSubject("æˆ‘æ˜¯ä¸»é¢˜");
        message.setText("æˆ‘æ˜¯å†…å®¹");
        message.setFrom("liangfenxuegao@163.com");//è°å‘çš„
        message.setTo("liangfenxuegao@foxmail.com");//å‘ç»™è°

        mailSender.send(message);//ä½¿ç”¨mailSenderå‘é€æ¶ˆæ¯
    }
}
```

ç™»å½•liangfenxuegao@foxmail.comï¼Œç¡®å®æ”¶åˆ°æ¥è‡ªliangfenxuegao@163.comçš„é‚®ä»¶äº†ï¼š

![image-20200424003415020](SpringBootAdvanced.assets\image-20200424003415020.png)

å¹¶ä¸”æˆ‘ç™»å½•163é‚®ç®±ä¹Ÿèƒ½åœ¨â€œä»¥å‘é€â€ä¸­çœ‹åˆ°è¿™æ¡é‚®ä»¶ï¼š

![image-20200424003534826](SpringBootAdvanced.assets\image-20200424003534826.png)

åœ¨spring.mail.propertieså¯ä»¥é…ç½®é¢å¤–çš„å±æ€§ï¼ŒåŸæ•™ç¨‹ä¸­è€å¸ˆå‡ºç°äº†530é”™è¯¯ã€‚å…·ä½“ä¸ºï¼šA secure connection is requiered(such as ssl)ã€‚æ„æ€æ˜¯éœ€è¦å®‰å…¨è¿æ¥ï¼ˆä¾‹å¦‚SSLï¼‰ã€‚è¿™åº”è¯¥æ˜¯æ—§ç‰ˆæœ¬çš„SpringBootæœªé»˜è®¤å¯ç”¨SSLçš„åŸå› ï¼Œè§£å†³åŠæ³•æ˜¯å†SpringBooté…ç½®æ–‡ä»¶ä¸­å¯ç”¨SSLè¿æ¥ï¼Œæ–°ç‰ˆæœ¬ä¸­ä¸å†éœ€è¦å†è®¾ç½®æ­¤é…ç½®é¡¹ï¼ˆæˆ‘æ˜¯2.2.6ï¼‰ï¼š

```properties
spring.mail.properties.mail.smtp.ssl.enable=true
```

**æµ‹è¯•å¤æ‚é‚®ä»¶æ”¶å‘ï¼š**

```java
//æµ‹è¯•å¤æ‚é‚®ä»¶æ”¶å‘
@Test
void complexMail() throws MessagingException {
    //åˆ›å»ºå¤æ‚æ¶ˆæ¯é‚®ä»¶ï¼Œå¯ä»¥å‘é€é™„ä»¶ã€HTMLé¡µé¢ç­‰
    MimeMessage mimeMessage = mailSender.createMimeMessage();
    //ä½¿ç”¨MimeMessageåŠ©æ‰‹ï¼Œå®ƒæœ‰å¾ˆå¤šæ–¹æ³•å¯ä¾›ä½¿ç”¨
    MimeMessageHelper mimeMessageHelper = new MimeMessageHelper(mimeMessage, true);
    //ä½¿ç”¨mimeMessageHelperè®¾ç½®æ¶ˆæ¯
    mimeMessageHelper.setSubject("æˆ‘æ˜¯ä¸»é¢˜");
    mimeMessageHelper.setText("<b style='color:red'>ä½¿ç”¨äº†HTMLæ ‡ç­¾çš„å†…å®¹</b>",true);//å¯ä½¿ç”¨HTMLæ ‡ç­¾ï¼Œéœ€è¦å°†äºŒå‚è®¾ä¸ºtrueæ‰èƒ½ç”Ÿæ•ˆ
    mimeMessageHelper.setFrom("liangfenxuegao@163.com");//è°å‘çš„
    mimeMessageHelper.setTo("liangfenxuegao@foxmail.com");//å‘ç»™è°
    //æ·»åŠ é™„ä»¶ï¼Œå¯ä»¥ç”¨java.io.Fileæˆ–org.springframework.core.io.InputStreamSourceæ¥æŒ‡å®šæ–‡ä»¶
    mimeMessageHelper.addAttachment("é™„ä»¶1.jpg",new File("src/main/resources/static/images/å¥³å­©-åƒä¸œè¥¿.jpg"));
    mimeMessageHelper.addAttachment("é™„ä»¶2.jpg",new File("src/main/resources/static/images/ç¾å¥³-æ°´æ¯-å”¯ç¾.jpg"));
    mailSender.send(mimeMessage);//ä½¿ç”¨mailSenderå‘é€æ¶ˆæ¯
}
```

æ³¨æ„æˆ‘æ·»åŠ çš„ä¸¤ä¸ªé™„ä»¶ï¼Œæ˜¯ä¸¤å¼ å›¾ç‰‡ï¼Œæ”¾åœ¨äº†é¡¹ç›®å†…çš„è¿™ä¸ªä½ç½®ï¼š

![image-20200424011624730](SpringBootAdvanced.assets\image-20200424011624730.png)

ç„¶åè¿è¡Œæµ‹è¯•å³å¯æ”¶åˆ°é‚®ä»¶ï¼š

![image-20200424011657427](SpringBootAdvanced.assets\image-20200424011657427.png)

# äº”ã€å®‰å…¨

## 5.1 æµ‹è¯•ç¯å¢ƒæ­å»º

ç›®å‰æœ‰ä¸¤ä¸ªæ¯”è¾ƒæµè¡Œçš„æ¡†æ¶ï¼Œåˆ†åˆ«ä¸ºApache Shiroå’ŒSpring Securityã€‚

Spring Securityæ˜¯é’ˆå¯¹Springé¡¹ç›®çš„å®‰å…¨æ¡†æ¶ï¼Œä¹Ÿæ˜¯Spring Bootåº•å±‚å®‰å…¨æ¨¡å—é»˜è®¤çš„æŠ€æœ¯é€‰å‹ã€‚ä»–å¯ä»¥å®ç°å¼ºå¤§çš„webå®‰å…¨æ§åˆ¶ã€‚å¯¹äºå®‰å…¨æ§åˆ¶ï¼Œæˆ‘ä»¬ä»…éœ€å¼•å…¥spring-boot-starter-securityæ¨¡å—ï¼Œè¿›è¡Œå°‘é‡çš„é…ç½®ï¼Œå³å¯å®ç°å¼ºå¤§çš„å®‰å…¨ç®¡ç†ã€‚

ä½¿ç”¨Spring Securityæ¨¡å—æ—¶ä¼šç”¨åˆ°è¿™å‡ ä¸ªç±»ï¼š

- WebSecurityConfigurerAdapterï¼šè‡ªå®šä¹‰Securityç­–ç•¥
- AuthenticationManagerBuilderï¼šè‡ªå®šä¹‰è®¤è¯ç­–ç•¥
- @EnableWebSecurityï¼šå¼€å¯WebSecurityæ¨¡å¼

åˆ›å»ºé¡¹ç›®ï¼š

![image-20200424213642054](SpringBootAdvanced.assets\image-20200424213642054.png)

æ·»åŠ ä¾èµ–åœºæ™¯ï¼Œæš‚æ—¶ä¸æ·»åŠ Spring Securityï¼ˆä¸æ˜¯ä¸å¯ä»¥æ·»åŠ ï¼‰ï¼š

![image-20200424213940526](SpringBootAdvanced.assets\image-20200424213940526.png)

åœ¨å°šç¡…è°·çš„èµ„æ–™ä¸­æœ‰ç”¨äºSpringSecurityå®éªŒçš„æ–‡æ¡£ï¼Œæ¥ä¸‹æ¥è¦ä½¿ç”¨å®ƒï¼š

![image-20200424214901380](SpringBootAdvanced.assets\image-20200424214901380.png)

å°†è¯¥æ–‡æ¡£ä¸‹templatesä¸­çš„å†…å®¹ç²˜è´´åˆ°é¡¹ç›®çš„src\main\resourcesä¸‹ï¼š

![image-20200424215334143](SpringBootAdvanced.assets\image-20200424215334143.png)

å°†è¯¥æ–‡æ¡£ä¸‹javaä¸­çš„æ–‡ä»¶ç²˜è´´åˆ°src\main\java\xuegao\learnSpringBoot\security\controllerä¸‹ï¼š

![image-20200424215719868](SpringBootAdvanced.assets\image-20200424215719868.png)

å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®ä¹‹ï¼Œç›®å‰ä»»ä½•è®¿å®¢éƒ½å¯ä»¥æŸ¥çœ‹è¯¥ç³»ç»Ÿçš„æ‰€æœ‰ç§˜ç±ï¼š

![image-20200424222057472](SpringBootAdvanced.assets\image-20200424222057472.png)

åŸæ•™ç¨‹ä¸­å‡ºç°äº†Thymeleafç‰ˆæœ¬è¿‡ä½çš„é—®é¢˜ï¼Œå¯¼è‡´æ— æ³•è®¿é—®è¯¥é¡µé¢ï¼Œå¦‚æœéœ€è¦æŒ‡å®šç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨é¡¹ç›®POMæ–‡ä»¶çš„propertiesæ ‡ç­¾ä¸­æŒ‡å®šéœ€è¦çš„ç‰ˆæœ¬ã€‚

é€šè¿‡è¿™ä¸¤ä¸ªæ­¥éª¤è¿›å…¥spring-boot-dependenciesï¼š

![image-20200424223028206](SpringBootAdvanced.assets\image-20200424223028206.png)

![image-20200424223037199](SpringBootAdvanced.assets\image-20200424223037199.png)

è¯¥æ–‡ä»¶ä¸­è®¾ç½®äº†æ‰€æœ‰ä¾èµ–çš„ç‰ˆæœ¬ï¼Œæ‰¾åˆ°thymeleafç‰ˆæœ¬ç®¡ç†ï¼Œå¤åˆ¶éœ€è¦ç®¡ç†çš„é¡¹åˆ°é¡¹ç›®POMæ–‡ä»¶çš„propertiesæ ‡ç­¾ä¸­ï¼ŒæŒ‡å®šä¸ºè‡ªå·±éœ€è¦çš„ç‰ˆæœ¬å³å¯ï¼š

![image-20200424223319895](SpringBootAdvanced.assets\image-20200424223319895.png)

```xml
<properties>
    <java.version>11</java.version>
    <thymeleaf.version>3.0.11.RELEASE</thymeleaf.version>
    <thymeleaf-layout-dialect.version>2.4.1</thymeleaf-layout-dialect.version>
    <thymeleaf-extras-springsecurity4.version>3.0.4.RELEASE</thymeleaf-extras-springsecurity4.version>
</properties>
```

## 5.2 ç™»å½•ã€è®¤è¯å’Œæˆæƒ

**å…³äºè®¿é—®æ§åˆ¶çš„é€šç”¨æ¦‚å¿µï¼ˆä¸é™äºSpring Securityï¼‰ï¼š**

- åº”ç”¨ç¨‹åºçš„ä¸¤ä¸ªä¸»è¦åŒºåŸŸæ˜¯â€œè®¤è¯â€å’Œâ€œæˆæƒâ€ï¼ˆæˆ–è€…è®¿é—®æ§åˆ¶ï¼‰ã€‚è¿™ä¸¤ä¸ªä¸»è¦åŒºåŸŸæ˜¯Spring Security çš„ä¸¤ä¸ªç›®æ ‡ã€‚
- â€œè®¤è¯â€ï¼ˆAuthenticationï¼‰ï¼Œæ˜¯å»ºç«‹ä¸€ä¸ªå®ƒå£°æ˜çš„ä¸»ä½“çš„è¿‡ç¨‹ï¼ˆâ€œä¸»ä½“â€ä¸€èˆ¬æ˜¯æŒ‡ç”¨æˆ·ã€è®¾å¤‡æˆ–ä¸€äº›å¯ä»¥åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­æ‰§è¡ŒåŠ¨ä½œçš„å…¶ä»–ç³»ç»Ÿï¼‰ã€‚
- â€œæˆæƒâ€ï¼ˆAuthorizationï¼‰æŒ‡ç¡®å®šä¸€ä¸ªä¸»ä½“æ˜¯å¦å…è®¸åœ¨ä½ çš„åº”ç”¨ç¨‹åºæ‰§è¡ŒæŸä¸ªåŠ¨ä½œçš„è¿‡ç¨‹ã€‚ä¸ºäº†æŠµè¾¾éœ€è¦æˆæƒçš„ç‚¹ï¼Œä¸»ä½“çš„èº«ä»½å·²ç»æœ‰è®¤è¯è¿‡ç¨‹å»ºç«‹ã€‚

**å®ç°ç™»å½•ã€è®¤è¯å’Œã€æˆæƒçš„æ­¥éª¤ï¼š**

1. äºPOMæ–‡ä»¶ä¸­å¼•å…¥Spring Securityï¼š

   ```xml
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-security</artifactId>
   </dependency>
   ```

2. ç¼–å†™Spring Securityçš„é…ç½®ï¼š

   è®¿é—®https://spring.io/guides/gs/securing-web/å¯ä»¥æŸ¥çœ‹Spring Securingçš„å¿«é€Ÿå‘å¯¼ã€‚

   ```java
   package xuegao.learnSpringBoot.security.config;
   
   import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
   import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
   
   /**
    * @EnableWebSecurityï¼š
    *  ç”¨äºå¼€å¯WebSecurityæ¨¡å¼ã€‚
    *  è¯¥æ³¨è§£å·²ç»å¸¦æœ‰@Configurationï¼Œæ‰€ä»¥æœ¬é…ç½®ç±»æ— éœ€å†æ·»åŠ ã€‚
    * */
   @EnableWebSecurity
   public class MySecurityConfig extends WebSecurityConfigurerAdapter {
   
   }
   ```

3. æ§åˆ¶è¯·æ±‚çš„è®¿é—®æƒé™ï¼š

   å…ˆé‡å†™çˆ¶ç±»çš„configure(HttpSecurity http)æ–¹æ³•ï¼Œæ·»åŠ ä¸€äº›è®¿é—®è§„åˆ™ï¼Œé™åˆ¶æŒ‡å®šè§’è‰²è®¿é—®æŒ‡å®šè·¯å¾„ï¼š

   ```java
   @EnableWebSecurity
   public class MySecurityConfig extends WebSecurityConfigurerAdapter {
   
       @Override
       protected void configure(HttpSecurity http) throws Exception {
           //super.configure(http);//ä¸è°ƒç”¨çˆ¶ç±»çš„è¿™ä¸ªæ„é€ å™¨ï¼Œå› ä¸ºå…¶åŒ…å«äº†ä¸€äº›é»˜è®¤é…ç½®
           /*
           è‡ªå®šä¹‰è¯·æ±‚çš„æˆæƒè§„åˆ™ï¼ˆantMatchersè¡¨ç¤ºanté£æ ¼çš„è·¯å¾„åŒ¹é…ï¼‰ï¼š
               http.æˆæƒè¯·æ±‚().è·¯å¾„åŒ¹é…("/").å…è®¸å…¨éƒ¨()
               .è·¯å¾„åŒ¹é…("/level1/**").å…è®¸è§’è‰²("VIP11")
               åé¢çš„çœç•¥â€¦â€¦
           */
           http.authorizeRequests().antMatchers("/").permitAll()
               .antMatchers("/level1/**").hasRole("VIP1")
               .antMatchers("/level2/**").hasRole("VIP2")
               .antMatchers("/level3/**").hasRole("VIP3");
       }
   }
   ```

   è®¿é—®â€œæ­¦æ—ç§˜ç±ç®¡ç†ç³»ç»Ÿâ€ï¼Œå°è¯•æŸ¥çœ‹ç§˜ç±æ—¶ä¼šæ”¶åˆ°403é”™è¯¯ï¼Œå¹¶æç¤ºAccess Deniedï¼š

   ![image-20200425232441397](SpringBootAdvanced.assets\image-20200425232441397.png)

   å¼€å¯è‡ªåŠ¨é…ç½®çš„ç™»å½•åŠŸèƒ½ï¼š

   ```java
   @Override
   protected void configure(HttpSecurity http) throws Exception {
   	/*çœç•¥â€¦â€¦*/
       
       /*
       å¼€å¯è‡ªåŠ¨é…ç½®çš„ç™»å½•åŠŸèƒ½ï¼Œè¿™æ˜¯å®ƒçš„é»˜è®¤ç­–ç•¥ï¼š
           ä¸€ã€è®¿é—®/loginä¼šå‰å¾€ç™»å½•é¡µ
           äºŒã€ç™»å½•é”™è¯¯æ—¶ä¼šé‡å®šå‘åˆ°/login?error
       */
       http.formLogin();
   }
   ```

   é‡å¯é¡¹ç›®ï¼Œå†æ¬¡å°è¯•æŸ¥çœ‹ç§˜ç±ï¼Œä¼šçœ‹åˆ°è¿™æ ·çš„ç•Œé¢ï¼š

   ![image-20200425232830432](SpringBootAdvanced.assets\image-20200425232830432.png)

   æŸ¥çœ‹è¯¥é¡µé¢çš„æºç ï¼Œä¼šå‘ç°è¡¨å•ä¸­æœ‰æ¡nameå±æ€§ä¸º_csrfçš„éšè—è¾“å…¥åŸŸï¼Œè¿™æ˜¯ç”¨æ¥é¢„é˜²CSRFçš„ã€‚ä»€ä¹ˆæ˜¯CSRFå‘¢ï¼ŸCSRFï¼ˆCross-site request forgeryï¼‰è·¨ç«™è¯·æ±‚ä¼ªé€ ã€‚è€ŒHttpSecurityä¼šå¯ç”¨CSRFåŠŸèƒ½ï¼Œä¼šä¸ºè¡¨å•æ·»åŠ CSRFçš„å€¼ï¼Œæäº¤æ—¶æºå¸¦ä»è€Œé¢„é˜²CSRFï¼š
   
   ```html
   <input name="_csrf" type="hidden" value="f3c1e6d3-9bc2-4904-8f5b-48c982cfc2a9" />
   ```
   
   è¿™æ—¶è¿˜æ²¡æœ‰é…ç½®ç”¨æˆ·ç»„å¯ä»¥é€šè¿‡é‡å†™userDetailsServiceæ–¹æ³•æ¥é…ç½®ï¼ˆä»…ç”¨ä½œæ¼”ç¤ºï¼Œä¸å®‰å…¨ï¼‰ï¼š
   
   ```java
   @EnableWebSecurity
   public class MySecurityConfig extends WebSecurityConfigurerAdapter {
   	/*çœç•¥â€¦â€¦*/
       
       @Bean
       @Override
       public UserDetailsService userDetailsService() {
           UserDetails bess = User.withDefaultPasswordEncoder().username("bess").password("123456").roles("VIP1").build();
           UserDetails daisy = User.withDefaultPasswordEncoder().username("daisy").password("123456").roles("VIP1","VIP2").build();
           UserDetails william = User.withDefaultPasswordEncoder().username("william").password("123456").roles("VIP1","VIP2","VIP3").build();
   
           return new InMemoryUserDetailsManager(bess,daisy,william);
       }
   }
   ```
   
   é‡å¯é¡¹ç›®ï¼Œå†æ¬¡å°è¯•æŸ¥çœ‹ç§˜ç±ï¼Œä¾‹å¦‚ä»¥daisyçš„èº«ä»½ç™»å½•ï¼Œä½ ä¼šå‘ç°èƒ½è®¿é—®æ™®é€šå’Œé«˜çº§çš„æ­¦åŠŸç§˜ç±ã€‚
   
   åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒç¯å¢ƒä¸­ï¼Œä½¿ç”¨é€šè¿‡æ•°æ®åº“åŠ è½½æ‰æ˜¯æœ€åˆé€‚çš„åšæ³•ï¼Œä½†é‚£å°±ååˆ†å¤æ‚äº†ï¼ŒåŸè§†é¢‘æ²¡è®²ï¼Œæˆ‘ä¹Ÿå…ˆä¸æäº†ã€‚ä½ éœ€è¦çš„è¯å¯ä»¥è‡ªè¡ŒæŸ¥æ‰¾èµ„æ–™ã€‚å¯ä»¥å‚è€ƒï¼šhttps://www.jianshu.com/p/c3b79a625d84

## 5.3 æƒé™æ§åˆ¶å’Œæ³¨é”€

å¼€å¯æ³¨é”€åŠŸèƒ½å¾ˆç®€å•ï¼Œè¿˜æ˜¯åœ¨MySecurityConfigç±»ä¸­çš„configure(HttpSecurity http)æ–¹æ³•ï¼Œè°ƒç”¨httpå¯¹è±¡çš„logoutæ–¹æ³•å³å¯ï¼š

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
	/*çœç•¥â€¦â€¦*/

    /*
    å¼€å¯æ³¨é”€åŠŸèƒ½ï¼Œä¸åšé…ç½®æ—¶ä¼šä½¿ç”¨å¦‚ä¸‹é»˜è®¤ç­–ç•¥ï¼š
        ä¸€ã€è®¿é—®/logoutå°†æ³¨é”€ç”¨æˆ·ï¼Œæ¸…ç©ºsession
        äºŒã€æ³¨é”€æˆåŠŸåå°†å‰å¾€/login?logouté¡µé¢
    */
    http.logout();
}
```

ç”±äºSpring Securityè¦æ±‚å‘å‡ºçš„/logoutè¯·æ±‚ï¼Œä¸ºPOSTè¯·æ±‚ï¼Œæ‰€ä»¥åœ¨resources\templates\welcome.htmlçš„bodyæ ‡ç­¾é‡Œæ·»åŠ è¿™æ ·ä¸€æ®µä»£ç ï¼š

```html
<!--å‘å‡º/logoutè¯·æ±‚ï¼ŒSpring Securityè¦æ±‚ä¸ºPOSTè¯·æ±‚-->
<form th:action="@{/logout}" method="post">
    <input type="submit" value="ç™»å‡º">
</form>
```

å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®æ­¦æ—ç§˜ç±ç®¡ç†ç³»ç»Ÿå¹¶ç™»å½•è´¦å·ï¼Œåœ¨ç‚¹å‡»â€œç™»å‡ºâ€ï¼š

![image-20200426200956987](SpringBootAdvanced.assets\image-20200426200956987.png)

å°±ä¼šæˆåŠŸæ³¨é”€è´¦å·å¹¶è·³è½¬åˆ°è¿™é‡Œï¼ˆhttp://localhost:8080/login?logoutï¼‰ï¼š

![image-20200426201035135](SpringBootAdvanced.assets\image-20200426201035135.png)

ä¸Šé¢æ˜¯é»˜è®¤çš„logoutç­–ç•¥ï¼Œæ¥ä¸‹æ¥è‡ªå®šä¹‰ç­–ç•¥ï¼Œä¾‹å¦‚æ³¨é”€è´¦å·åé‡å®šå‘åˆ°æ­¦æ—ç§˜ç±ç®¡ç†ç³»ç»Ÿï¼š

```java
http.logout().logoutSuccessUrl("/");//ç™»å‡ºåå‰å¾€è·¯å¾„ï¼šâ€/â€œã€‚
```

é‡å¯é¡¹ç›®ï¼Œæ­¤æ—¶ç‚¹å‡»ç™»å‡ºæ—¶å‰å¾€çš„å°±æ˜¯æ­¦æ—ç§˜ç±ç®¡ç†ç³»ç»Ÿäº†ã€‚

**æ ¹æ®ç™»å½•æƒ…å†µå®æ—¶å˜æ¢é¡µé¢æ˜¾ç¤ºæ•ˆæœï¼š**

åœ¨POMæ–‡ä»¶å¼•å…¥thymeleaf-extras-springsecurity5ï¼š

```xml
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity5</artifactId>
    <version>3.0.4.RELEASE</version>
</dependency>
```

ä¸ºäº†æœ‰è¯­æ³•æç¤ºï¼Œéœ€è¦åœ¨æ·»åŠ xmlns:sec="https://www.thymeleaf.org/extras/spring-security"ã€‚ä¸‹é¢å°†æ•´ä¸ªwelcome.htmlé¡µé¢è´´å‡ºæ¥äº†ï¼š

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Insert title here</title>
</head>
<body>
   <h1 align="center">æ¬¢è¿å…‰ä¸´æ­¦æ—ç§˜ç±ç®¡ç†ç³»ç»Ÿ</h1>
   <!--å¦‚æœæœªè®¤è¯ï¼Œæ˜¾ç¤ºï¼šâ€œæ¸¸å®¢æ‚¨å¥½â€¦â€¦â€-->
   <div sec:authorize="!isAuthenticated()">
      <h2 align="center">æ¸¸å®¢æ‚¨å¥½ï¼Œå¦‚æœæƒ³æŸ¥çœ‹æ­¦æ—ç§˜ç± <a th:href="@{/login}">è¯·ç™»å…¥</a></h2>
   </div>
   <!--å¦‚æœå·²è®¤è¯ï¼Œæ˜¾ç¤ºâ€œç™»å‡ºæŒ‰é’®â€-->
   <div sec:authorize="isAuthenticated()">
      <!--sec:authentication="name"ä¼šå–å‡ºç”¨æˆ·åï¼Œprincipal.authoritiesèƒ½å¾—åˆ°è¯¥ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²-->
      <h2><span sec:authentication="name"></span>æ‚¨å¥½ï¼Œæ‚¨æ‹¥æœ‰çš„è§’è‰²æœ‰ï¼š<span sec:authentication="principal.authorities"></span></h2>
      <!--å‘å‡º/logoutè¯·æ±‚ï¼ŒSpring Securityè¦æ±‚ä¸ºPOSTè¯·æ±‚-->
      <form th:action="@{/logout}" method="post">
         <input type="submit" value="ç™»å‡º">
      </form>
   </div>
   <hr>

   <!--æœ‰VIP1è§’è‰²æ—¶ç”Ÿæ•ˆ-->
   <div sec:authorize="hasRole('VIP1')">
      <h3>æ™®é€šæ­¦åŠŸç§˜ç±</h3>
      <ul>
         <li><a th:href="@{/level1/1}">ç½—æ±‰æ‹³</a></li>
         <li><a th:href="@{/level1/2}">æ­¦å½“é•¿æ‹³</a></li>
         <li><a th:href="@{/level1/3}">å…¨çœŸå‰‘æ³•</a></li>
      </ul>
   </div>

   <!--æœ‰VIP2è§’è‰²æ—¶ç”Ÿæ•ˆ-->
   <div sec:authorize="hasRole('VIP2')">
      <h3>é«˜çº§æ­¦åŠŸç§˜ç±</h3>
      <ul>
         <li><a th:href="@{/level2/1}">å¤ªææ‹³</a></li>
         <li><a th:href="@{/level2/2}">ä¸ƒä¼¤æ‹³</a></li>
         <li><a th:href="@{/level2/3}">æ¢¯äº‘çºµ</a></li>
      </ul>
   </div>

   <!--æœ‰VIP3è§’è‰²æ—¶ç”Ÿæ•ˆ-->
   <div sec:authorize="hasRole('VIP3')">
      <h3>ç»ä¸–æ­¦åŠŸç§˜ç±</h3>
      <ul>
         <li><a th:href="@{/level3/1}">è‘µèŠ±å®å…¸</a></li>
         <li><a th:href="@{/level3/2}">é¾Ÿæ´¾æ°”åŠŸ</a></li>
         <li><a th:href="@{/level3/3}">ç‹¬å­¤ä¹å‰‘</a></li>
      </ul>
   </div>
</body>
</html>
```

é‡å¯é¡¹ç›®åï¼Œåˆ·æ–°æ­¦æ—ç§˜ç±ç®¡ç†ç³»ç»Ÿé¡µé¢çš„æ•ˆæœï¼Œå°†æ²¡æœ‰ç™»å‡ºæŒ‰é’®å’Œä¸‹é¢çš„ç§˜ç±åˆ—è¡¨ï¼š

<img src="SpringBootAdvanced.assets\image-20200426223231063.png" alt="image-20200426223231063" style="zoom:80%;" />

ä¾‹å¦‚ç™»å½•daisyç”¨æˆ·ï¼Œæ˜¾ç¤ºæ•ˆæœæ˜¯è¿™æ ·çš„ï¼š

<img src="SpringBootAdvanced.assets\image-20200426223350449.png" alt="image-20200426223350449" style="zoom:80%;" />

## 5.4 å®ç°â€œè®°ä½æˆ‘â€åŠŸèƒ½å’Œå®šåˆ¶ç™»å½•é¡µ

**å®ç°â€œè®°ä½æˆ‘â€åŠŸèƒ½ï¼š**

è¿˜æ˜¯åœ¨MySecurityConfigç±»ä¸­çš„configure(HttpSecurity http)æ–¹æ³•ï¼Œåªéœ€æ·»åŠ ä¸€è¡Œhttp.rememberMe();å³å¯å®ç°è¯¥åŠŸèƒ½ï¼š

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
	/*çœç•¥â€¦â€¦*/

    /*
    å¼€å¯â€œè®°ä½æˆ‘â€åŠŸèƒ½ï¼š
        ç™»å…¥æˆåŠŸåï¼šç”Ÿæˆåä¸ºremember-meçš„cookieç»™æµè§ˆå™¨ä¿å­˜ï¼Œæ—¥åå†æ¬¡è®¿é—®æ—¶è¯¥cookieé€šè¿‡æ£€æŸ¥å°±å¯å…ç™»å½•ã€‚
        ç™»å‡ºæˆåŠŸåï¼šåˆ é™¤åä¸ºremember-meçš„cookieã€‚
    */
	http.rememberMe();
}
```

é‡æ–°è®¿é—®ç®¡ç†ç³»ç»Ÿï¼Œè¿›å…¥ç™»å½•é¡µæ—¶ä¼šå‘ç°å¤šäº†ä¸ªâ€œRemember me on this computer.â€å¤é€‰æ¡†ï¼š

<img src="SpringBootAdvanced.assets\image-20200426225634105.png" alt="image-20200426225634105" style="zoom:80%;" />

è‹¥ä¸å‹¾é€‰ç›´æ¥ç™»å½•ï¼Œé‚£ä¹ˆé€€å‡ºæµè§ˆå™¨åå†æ¬¡è®¿é—®ç®¡ç†ç³»ç»Ÿåˆéœ€è¦é‡æ–°ç™»å½•äº†ï¼Œè€Œå‹¾é€‰ä¸Šåå°±èƒ½é¿å…è¯¥ç‚¹ï¼Œå®ç°å…ç™»å½•ã€‚

è¿™æ˜¯é€šè¿‡Cokieåšåˆ°çš„ï¼Œç™»å½•ç®¡ç†ç³»ç»Ÿåæ‰“å¼€â€œå¼€å‘äººå‘˜å·¥å…·â€ï¼ŒæŸ¥çœ‹Cookiceä¿¡æ¯æ—¶èƒ½çœ‹åˆ°remember-meï¼Œè¿˜æ˜¾ç¤ºäº†è¿‡æœŸæ—¶é—´ï¼š

![image-20200426230817853](SpringBootAdvanced.assets\image-20200426230817853.png)

å½“ç‚¹å‡»ç™»å‡ºæ—¶è¯¥Cookieä¼šç«‹å³è¢«åˆ é™¤ï¼š

![image-20200426230917371](SpringBootAdvanced.assets\image-20200426230917371.png)

åœ¨ç½‘ç»œä¸­æŸ¥çœ‹logoutè¯·æ±‚çš„å“åº”æ ‡å¤´çš„Set-Cookieï¼ˆæ„æ€æ˜¯ç«‹å³æ¸…é™¤remember-meè¿™ä¸ªcookieï¼‰ï¼š

![image-20200426234202582](SpringBootAdvanced.assets\image-20200426234202582.png)

**å®šåˆ¶ç™»å½•é¡µï¼š**

åœ¨xuegao.learnSpringBoot.security.controller.KungfuControllerä¸­è¿™ä¸ªæ–¹æ³•å¤„ç†äº†/userLoginè¯·æ±‚ï¼š

```java
//ç™»å½•é¡µ
@GetMapping("/userLogin")
public String loginPage() {
   return PREFIX+"login";
}
```

è¯¥æ–¹æ³•æ˜ å°„çš„é¡µé¢login.htmlï¼š

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>ç™»å…¥</title>
</head>
<body>
	<h1 align="center">æ¬¢è¿ç™»å…¥æ­¦æ—ç§˜ç±ç®¡ç†ç³»ç»Ÿ</h1>
	<hr>
	<div align="center">
		<!--
		ä»¥POSTæ–¹å¼å‘å‡º/loginè¯·æ±‚ï¼ŒSpring Securityé»˜è®¤è§†ä¸ºç™»å½•è¯·æ±‚å¤„ç†ã€‚
		ä¸€æ—¦å®šåˆ¶äº†MySecurityConfigç±»configureæ–¹æ³•ä¸‹çš„http.loginPage()ï¼š
			é‚£ä¹ˆå‘å¾€loginPageé‡Œå¡«å†™çš„è·¯å¾„çš„è¯·æ±‚å°†è§†ä¸ºç™»å½•è¯·æ±‚å¤„ç†ï¼Œé™¤éç‰¹æ„å£°æ˜http.loginProcessingUrl("/login")ã€‚
		-->
		<form th:action="@{'/userLogin'}" method="post">
			<!--è¿™ä¿©çš„nameå±æ€§è¦å’ŒMySecurityConfigç±»configureæ–¹æ³•ä¸‹çš„http.usernameParameter("username").passwordParameter("password")é…ç½®çš„å€¼ä¸€è‡´ï¼ŒSpring Securityæ‰èƒ½å–åˆ°å€¼-->
			è´¦æˆ·ï¼š<input name="username"/><br>
			å¯†ç ï¼š<input name="password"><br/>
			<input type="submit" value="ç™»å…¥">
		</form>
	</div>
</body>
</html>
```

MySecurityConfigç±»configureæ–¹æ³•ä¸‹çš„http.formLogin()é…ç½®ï¼š

```java
/*
å¼€å¯ç™»å½•åŠŸèƒ½ï¼Œè¿™æ˜¯å®ƒçš„é»˜è®¤ç­–ç•¥ï¼ˆä¸åšé…ç½®æ—¶ä¼šä½¿ç”¨é»˜è®¤ç­–ç•¥ï¼‰ï¼š
    ä¸€ã€è®¿é—®/loginä¼šå‰å¾€ç™»å½•é¡µ
    äºŒã€ç™»å½•é”™è¯¯æ—¶ä¼šé‡å®šå‘åˆ°/login?error
å®šåˆ¶ç™»å½•é¡µï¼š
    ä¸€ã€é€šè¿‡loginPageæ–¹æ³•å®šåˆ¶ç™»å½•é¡µã€‚
    äºŒã€ä»¥POSTæ–¹å¼å‘å‡º/loginè¯·æ±‚ï¼ŒSpring Securityé»˜è®¤è§†ä¸ºç™»å½•è¯·æ±‚å¤„ç†ã€‚
    ä¸‰ã€é€šè¿‡usernameParameter()ã€passwordParameter()æ–¹æ³•ä»/userLoginé¡µé¢çš„ï¼Œnameå±æ€§ä¸ºæŒ‡å®šå€¼çš„inputæ ‡ç­¾å–å€¼ã€‚
	å››ã€ä¸€æ—¦å®šåˆ¶äº†loginPageï¼Œé‚£ä¹ˆloginPageçš„POSTè¯·æ±‚å°±æ˜¯ç”¨äºå¤„ç†ç™»å½•ï¼Œç›¸å½“äºhttp.loginProcessingUrl("/userLogin")ï¼Œé™¤éç‰¹æ„å£°æ˜http.loginProcessingUrl("/login")ã€‚
*/
http.formLogin().usernameParameter("username").passwordParameter("password").loginPage("/userLogin");
```

é‡å¯é¡¹ç›®ï¼Œç‚¹å‡»â€œè¯·ç™»å…¥â€ï¼š

![image-20200427212523787](SpringBootAdvanced.assets\image-20200427212523787.png)

å°±ä¼šè·³è½¬åˆ°è‡ªå®šä¹‰çš„ç™»å½•é¡µï¼ˆ/userLoginï¼‰ï¼Œè¾“å…¥è´¦æˆ·å¯†ç ååº”èƒ½æˆåŠŸç™»å…¥ï¼š

![image-20200427212551996](SpringBootAdvanced.assets\image-20200427212551996.png)

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå³ä¾¿æ˜¯è‡ªå®šä¹‰çš„ç™»å½•é¡µï¼ŒHttpSecurityä¹Ÿä¼šå¯ç”¨CSRFåŠŸèƒ½ï¼Œä¸ºè¡¨å•æ·»åŠ CSRFçš„å€¼ï¼Œä»è€Œé¢„é˜²CSRFã€‚æŸ¥çœ‹è¯¥é¡µé¢çš„æºç å¯å‘ç°è¾ƒä¹‹é¡¹ç›®ä¸­åŸæ¥çš„login.htmlï¼Œformæ ‡ç­¾ä¸­å¤šäº†nameå±æ€§ä¸º_csrfçš„è¾“å…¥åŸŸï¼ˆè¿™é‡Œåˆ é™¤äº†æ³¨é‡Šå†…å®¹ï¼‰ï¼š

```html
<form action="/userLogin" method="post">
    <input type="hidden" name="_csrf" value="404af71a-928b-4949-a10c-8fb59cd9ab32"/>
    è´¦æˆ·ï¼š<input name="username"/><br/>
    å¯†ç ï¼š<input name="password"><br/>
	<input type="checkbox" name="rememberMe">è®°ä½æˆ‘<br/>
	<input type="submit" value="ç™»å…¥">
</form>
```

**ä¸ºè‡ªå®šä¹‰çš„ç™»å½•é¡µæ·»åŠ â€œè®°ä½æˆ‘â€åŠŸèƒ½ï¼š**

MySecurityConfigç±»configureæ–¹æ³•ä¸‹http.rememberMe()ç›¸å…³é…ç½®ï¼š

```java
//rememberMeParameterçš„å‚æ•°é»˜è®¤ä¸ºrememberMeï¼Œè°ƒç”¨è¯¥æ–¹æ³•å¯ä»¥è‡ªå®šä¹‰å‚æ•°å€¼ï¼Œä»è€Œå‘/userLoginé¡µé¢çš„ï¼Œnameå±æ€§ä¸ºæŒ‡å®šå€¼çš„inputæ ‡ç­¾å–å€¼ã€‚
http.rememberMe().rememberMeParameter("rememberMe");
```

login.htmlé‡Œï¼Œå‘å¾€/userLoginçš„è¡¨å•å†…ï¼Œæ·»åŠ nameå±æ€§ä¸ºrememberMeçš„è¾“å…¥åŸŸï¼š

```html
<form th:action="@{'/userLogin'}" method="post">
	çœç•¥â€¦â€¦
    
   <!--è¿™ä¸ªnameå±æ€§è¦å’ŒMySecurityConfigç±»configureæ–¹æ³•ä¸‹çš„http.rememberMeParameter("rememberMe")é…ç½®çš„å€¼ä¸€è‡´ï¼Œâ€œè®°ä½æˆ‘â€åŠŸèƒ½æ‰èƒ½ç”Ÿæ•ˆ-->
   <input type="checkbox" name="rememberMe">è®°ä½æˆ‘<br/>

   <input type="submit" value="ç™»å…¥">
</form>
```

é‡å¯é¡¹ç›®è®¿é—®ç™»å½•é¡µèƒ½çœ‹åˆ°å¤šäº†â€œè®°ä½æˆ‘â€ï¼š

![image-20200427220705948](SpringBootAdvanced.assets\image-20200427220705948.png)

å‹¾é€‰ä¸Šå†ç™»å½•ï¼Œç„¶åå…³é—­æµè§ˆå™¨ï¼Œå†è®¿é—®æ­¦æ—ç§˜ç±ç®¡ç†ç³»ç»Ÿå°±ä¼šå‘ç°æˆåŠŸå®ç°äº†â€œè®°ä½æˆ‘â€åŠŸèƒ½ã€‚

## 5.5 Spring Securityä½¿ç”¨ajaxå®ç°å¼‚æ­¥ç™»å½•

å‚è€ƒåšæ–‡ï¼šhttps://blog.csdn.net/qq_34869990/article/details/103360678 

**è‡ªå®šä¹‰ç™»å½•å¤„ç†é€»è¾‘ï¼š**

ç¼–å†™è‡ªå®šä¹‰ç™»å½•æˆåŠŸå’Œç™»å½•å¤±è´¥å¤„ç†é€»è¾‘(è¿”å›jsonæ•°æ®ï¼Œè€Œä¸æ˜¯é¡µé¢è·³è½¬)ï¼Œç³»ç»Ÿé»˜è®¤ç™»å½•æˆåŠŸä¼šè·³å›ä¸Šä¸€ä¸ªé¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œé”™è¯¯æç¤ºï¼Œæ‰€ä»¥éœ€è¦è‡ªå®šä¹‰ajaxå¤„ç†ã€‚

1. ç™»å½•æˆåŠŸå¤„ç†å™¨ï¼š

   ```java
   @Component
   public class MyAuthenticationSuccessHandler implements AuthenticationSuccessHandler {
   
       @Override
       public void onAuthenticationSuccess(
               HttpServletRequest httpServletRequest,
               HttpServletResponse httpServletResponse,
               Authentication authentication) throws IOException, ServletException {
   
           //è£…è½½æ¶ˆæ¯
           HashMap<String, Object> map = new HashMap<>();
           map.put("code",200);//HTTPçŠ¶æ€ç ã€‚200è¡¨ç¤ºOKï¼Œå³æ­£å¸¸çŠ¶æ€ã€‚
           map.put("message","ç™»å½•æˆåŠŸ");
           String stringJson = new JSONObject(map).toString();//å°†mapè½¬ä¸ºJSONæ ¼å¼
   
           httpServletRequest.getSession().setAttribute("username",authentication.getName());//è®¾ç½®å½“å‰Sessionä¸­ï¼Œusernameé”®å¯¹åº”çš„å€¼æ˜¯å½“å‰ç™»å½•ç”¨æˆ·çš„ç”¨æˆ·åã€‚
           httpServletResponse.setContentType("application/json;charset=UTF-8");//è®¾ç½®å†…å®¹ç±»å‹
           PrintWriter out = httpServletResponse.getWriter();
           out.write(stringJson);
           out.flush();
           out.close();
       }
   }
   ```

2. ç™»å½•å¤±è´¥å¤„ç†å™¨ï¼š

   ```java
   @Component
   public class MyAuthenticationFailHandler implements AuthenticationFailureHandler {
   
       @Override
       public void onAuthenticationFailure(
               HttpServletRequest request,
               HttpServletResponse response,
               AuthenticationException exception) throws IOException, ServletException {
   
           //è£…è½½æ¶ˆæ¯
           HashMap<String, Object> map = new HashMap<>();
           map.put("code",300);//HTTPçŠ¶æ€ç ã€‚300è¡¨ç¤ºMultiple Choicesã€‚
           map.put("message",exception.getMessage()+"è¯·æ£€æŸ¥æ˜¯å¦æœ‰è´¦å·æˆ–å¯†ç é”™è¯¯");
           String stringJson = new JSONObject(map).toString();//å°†mapè½¬ä¸ºJSONæ ¼å¼
   
           response.setContentType("application/json;charset=UTF-8");//è®¾ç½®å†…å®¹ç±»å‹
           PrintWriter out = response.getWriter();
           out.write(stringJson);
           out.flush();
           out.close();
       }
   }
   ```

## 5.6 è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯

å‚è€ƒæ–‡ç« ï¼šhttps://www.hangge.com/blog/cache/detail_2717.html ã€‚

æ–¹æ³•ä¸€ï¼šé€šè¿‡æ³¨å…¥Principalæ¥å£è·å–ç”¨æˆ·ä¿¡æ¯ã€‚

- åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒSpring ä¼šå°† Usernameã€Passwordã€Authenticationã€Token æ³¨å…¥åˆ° Principal æ¥å£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è·å–ä½¿ç”¨ã€‚

- ```java
  @GetMapping("getCurrentLoginUsername")
  public String hello(Principal principal) {
  	return principal.getName();//å¦‚æœæœªç™»å½•ï¼Œprincipalå°†ä¸ºnullã€‚
  }
  ```

# å…­ã€åˆ†å¸ƒå¼

## 6.1 Dobboç®€ä»‹

**åˆ†å¸ƒå¼åº”ç”¨ï¼š**

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå›½å†…å¸¸ç”¨zookeeper+dubboç»„åˆï¼Œè€ŒSpring Bootæ¨èä½¿ç”¨å…¨æ ˆçš„Springï¼Œå³Spring BootåŠ Spring Cloudã€‚

åˆ†å¸ƒå¼ç³»ç»Ÿï¼š

![image-20200427231918934](SpringBootAdvanced.assets\image-20200427231918934.png)

- å•ä¸€åº”ç”¨æ¶æ„
  å½“ç½‘ç«™æµé‡å¾ˆå°æ—¶ï¼Œåªéœ€ä¸€ä¸ªåº”ç”¨ï¼Œå°†æ‰€æœ‰åŠŸèƒ½éƒ½éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œä»¥å‡å°‘éƒ¨ç½²èŠ‚ç‚¹å’Œæˆæœ¬ã€‚æ­¤æ—¶ï¼Œç”¨äºç®€åŒ–å¢åˆ æ”¹æŸ¥å·¥ä½œé‡çš„æ•°æ®è®¿é—®æ¡†æ¶(ORM)æ˜¯å…³é”®ã€‚
- å‚ç›´åº”ç”¨æ¶æ„
  å½“è®¿é—®é‡é€æ¸å¢å¤§ï¼Œå•ä¸€åº”ç”¨å¢åŠ æœºå™¨å¸¦æ¥çš„åŠ é€Ÿåº¦è¶Šæ¥è¶Šå°ï¼Œå°†åº”ç”¨æ‹†æˆäº’ä¸ç›¸å¹²çš„å‡ ä¸ªåº”ç”¨ï¼Œä»¥æå‡æ•ˆç‡ã€‚æ­¤æ—¶ï¼Œç”¨äºåŠ é€Ÿå‰ç«¯é¡µé¢å¼€å‘çš„Webæ¡†æ¶(MVC)æ˜¯å…³é”®ã€‚
- åˆ†å¸ƒå¼æœåŠ¡æ¶æ„
  å½“å‚ç›´åº”ç”¨è¶Šæ¥è¶Šå¤šï¼Œåº”ç”¨ä¹‹é—´äº¤äº’ä¸å¯é¿å…ï¼Œå°†æ ¸å¿ƒä¸šåŠ¡æŠ½å–å‡ºæ¥ï¼Œä½œä¸ºç‹¬ç«‹çš„æœåŠ¡ï¼Œé€æ¸å½¢æˆç¨³å®šçš„æœåŠ¡ä¸­å¿ƒï¼Œä½¿å‰ç«¯åº”ç”¨èƒ½æ›´å¿«é€Ÿçš„å“åº”å¤šå˜çš„å¸‚åœºéœ€æ±‚ã€‚æ­¤æ—¶ï¼Œç”¨äºæé«˜ä¸šåŠ¡å¤ç”¨åŠæ•´åˆçš„åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶(RPC)æ˜¯å…³é”®ã€‚
- æµåŠ¨è®¡ç®—æ¶æ„
  å½“æœåŠ¡è¶Šæ¥è¶Šå¤šï¼Œå®¹é‡çš„è¯„ä¼°ï¼Œå°æœåŠ¡èµ„æºçš„æµªè´¹ç­‰é—®é¢˜é€æ¸æ˜¾ç°ï¼Œæ­¤æ—¶éœ€å¢åŠ ä¸€ä¸ªè°ƒåº¦ä¸­å¿ƒåŸºäºè®¿é—®å‹åŠ›å®æ—¶ç®¡ç†é›†ç¾¤å®¹é‡ï¼Œæé«˜é›†ç¾¤åˆ©ç”¨ç‡ã€‚æ­¤æ—¶ï¼Œç”¨äºæé«˜æœºå™¨åˆ©ç”¨ç‡çš„èµ„æºè°ƒåº¦å’Œæ²»ç†ä¸­å¿ƒ(SOA)æ˜¯å…³é”®ã€‚

**Zookeeperå’ŒDubboï¼š**

- Zookeeper

  ZooKeeper æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œå¼€æ”¾æºç çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡ã€‚å®ƒæ˜¯ä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›ä¸€è‡´æ€§æœåŠ¡çš„è½¯ä»¶ï¼Œæä¾›çš„åŠŸèƒ½åŒ…æ‹¬ï¼šé…ç½®ç»´æŠ¤ã€åŸŸåæœåŠ¡ã€åˆ†å¸ƒå¼åŒæ­¥ã€ç»„æœåŠ¡ç­‰ã€‚

- Dubbo

  Dubboæ˜¯Alibabaå¼€æºçš„åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ï¼Œå®ƒæœ€å¤§çš„ç‰¹ç‚¹æ˜¯æŒ‰ç…§åˆ†å±‚çš„æ–¹å¼æ¥æ¶æ„ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼å¯ä»¥ä½¿å„ä¸ªå±‚ä¹‹é—´è§£è€¦åˆï¼ˆæˆ–è€…æœ€å¤§é™åº¦åœ°æ¾è€¦åˆï¼‰ã€‚ä»æœåŠ¡æ¨¡å‹çš„è§’åº¦æ¥çœ‹ï¼ŒDubboé‡‡ç”¨çš„æ˜¯ä¸€ç§éå¸¸ç®€å•çš„æ¨¡å‹ï¼Œè¦ä¹ˆæ˜¯æä¾›æ–¹æä¾›æœåŠ¡ï¼Œè¦ä¹ˆæ˜¯æ¶ˆè´¹æ–¹æ¶ˆè´¹æœåŠ¡ï¼Œæ‰€ä»¥åŸºäºè¿™ä¸€ç‚¹å¯ä»¥æŠ½è±¡å‡ºæœåŠ¡æä¾›æ–¹ï¼ˆProviderï¼‰å’ŒæœåŠ¡æ¶ˆè´¹æ–¹ï¼ˆConsumerï¼‰ä¸¤ä¸ªè§’è‰²ã€‚

  ![image-20200427235153276](SpringBootAdvanced.assets\image-20200427235153276.png)

## 6.2 Dockerå®‰è£…Zookeeper

æ‹‰å–é•œåƒï¼š

```powershell
docker pull zookeeper
```

åœ¨Docker Hubé‡Œæ‰¾åˆ°zookeeperå®˜æ–¹é•œåƒï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®è¯¥é“¾æ¥ï¼šhttps://hub.docker.com/_/zookeeperã€‚åœ¨å…¶Descriptionä¸­æœ‰å…³äºå¦‚ä½•ä½¿ç”¨è¯¥é•œåƒçš„è¯´æ˜ï¼š

- ```sh
  docker run --name some-zookeeper --restart always -d zookeeper
  ```

- This image includes `EXPOSE 2181 2888 3888 8080` (the  zookeeper client port, follower port, election port, AdminServer port  respectively), so standard container linking will make it automatically  available to the linked containers. Since the Zookeeper "fails fast"  it's better to always restart it.

å‚è€ƒè¯¥è¯´æ˜ï¼Œè¿è¡Œé•œåƒï¼Œæš´éœ²zookeeperå®¢æˆ·ç«¯ç«¯å£ï¼ˆ2181ï¼‰ï¼š

- ```shell
  docker run --name helloZookeeper --restart always -p 2181:2181 -d zookeeper:latest
  ```

ä½¿ç”¨docker pså‘½ä»¤æŸ¥çœ‹è¿è¡Œæ˜¯å¦æˆåŠŸå³å¯ï¼ˆå¤åˆ¶ä»£ç å—é‡Œçš„æ–‡æœ¬åˆ°è®°äº‹æœ¬é‡Œå³å¯æ­£å¸¸æŸ¥çœ‹ï¼‰ï¼š

```shell
root@instance-hxkkn97p:~# docker ps
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                                                                        NAMES
5354644e214b        zookeeper:latest      "/docker-entrypoint.â€¦"   2 minutes ago       Up 2 minutes        2888/tcp, 3888/tcp, 0.0.0.0:2181->2181/tcp, 8080/tcp                                         helloZookeeper
```

## 6.3 SpringBootã€Dubboä»¥åŠZookeeperæ•´åˆ

åˆ›å»ºç©ºå·¥ç¨‹ï¼š

![image-20200428211617411](SpringBootAdvanced.assets\image-20200428211617411.png)

å…ˆåˆ›å»ºdubboç›¸å…³çš„ï¼š

![image-20200428211807524](SpringBootAdvanced.assets\image-20200428211807524.png)

åœ¨é¡¹ç›®è§†å›¾ä¸­åˆ›å»ºæ¨¡å—ï¼š

![image-20200428211936965](SpringBootAdvanced.assets\image-20200428211936965.png)

ä¹Ÿé€šè¿‡é¡¶éƒ¨å¯¼èˆªæ çš„Fileâ†’Newâ†’Module...åˆ›å»ºï¼š

![image-20200428212022189](SpringBootAdvanced.assets\image-20200428212022189.png)

**åˆ›å»ºç”Ÿäº§è€…æ¨¡å—ï¼š**

éœ€è¦åˆ›å»ºçš„ä»ç„¶æ˜¯ä¸ªSpringBootå·¥ç¨‹ï¼š

![image-20200428212233910](SpringBootAdvanced.assets\image-20200428212233910.png)

åˆ›å»ºprovider-ticketå·¥ä»¶ï¼š

![image-20200428212845165](SpringBootAdvanced.assets\image-20200428212845165.png)

ç…§ä¾‹æ·»åŠ Spring Webåœºæ™¯ï¼š

![image-20200428213243100](SpringBootAdvanced.assets\image-20200428213243100.png)

æ–‡ä»¶åå’Œä½ç½®ï¼š

![image-20200428213310074](SpringBootAdvanced.assets\image-20200428213310074.png)

åˆ›å»ºå¥½æ¨¡å—åï¼Œåˆ›å»ºTicketServiceæ¥å£åŠå…¶å®ç°ç±»ï¼š

```java
package xuegao.learnSpringBoot.dubbo.providerTicket.service;

public interface TicketService {
    public String getTicket();
}
```

```java
package xuegao.learnSpringBoot.dubbo.providerTicket.service;

public class TicketServiceImpl implements TicketService{
    @Override
    public String getTicket() {
        return "ã€Šæµæµªåœ°çƒã€‹";
    }
}
```

**åˆ›å»ºæ¶ˆè´¹è€…æ¨¡å—ï¼š**

åˆ›å»ºconsumer-userå·¥ä»¶ï¼š

![image-20200428220829690](SpringBootAdvanced.assets\image-20200428220829690.png)

ç…§ä¾‹æ·»åŠ Spring Webåœºæ™¯ï¼š

![image-20200428213243100](SpringBootAdvanced.assets\image-20200428213243100.png)

æ–‡ä»¶åå’Œä½ç½®ï¼š

![image-20200428225436703](SpringBootAdvanced.assets\image-20200428225436703.png)

åˆ›å»ºUserServiceç±»ã€‚è¿™æ—¶è‹¥æƒ³è¦åœ¨æœ¬æ¨¡å—è°ƒç”¨provider-ticketæ¨¡å—çš„TicketServiceImplï¼Œå°±å¯ä»¥ç”¨Dubboæ¥å®ç°ï¼š

![image-20200428231640452](SpringBootAdvanced.assets\image-20200428231640452.png)

**æ•´åˆDubboï¼š**

è®¿é—®https://github.com/apache/dubbo-spring-boot-project/blob/master/README_CN.mdï¼Œè¿™é‡Œæœ‰å¦‚ä½•æ·»åŠ Dubbo Spring Boot å·¥ç¨‹çš„è¯´æ˜ã€‚å¦å¤–è¿˜éœ€è¦å¼•å…¥Zookeeperå®¢æˆ·ç«¯å·¥å…·ï¼Œæ‰€ä»¥åœ¨provider-ticketæ¨¡å—çš„POMæ–‡ä»¶é‡Œæ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š

```xml
<!-- Dubbo Spring Boot Starter -->
<dependency>
   <groupId>org.apache.dubbo</groupId>
   <artifactId>dubbo-spring-boot-starter</artifactId>
   <version>2.7.6</version>
</dependency>
<!--å¼•å…¥Zookeeperå®¢æˆ·ç«¯å·¥å…·ã€‚ https://mvnrepository.com/artifact/com.github.sgroschupf/zkclient -->
<dependency>
   <groupId>com.github.sgroschupf</groupId>
   <artifactId>zkclient</artifactId>
   <version>0.1</version>
</dependency>
```

ç„¶åâ€¦â€¦ç„¶åæˆ‘è·Ÿç€è€å¸ˆåšåé¢çš„å†…å®¹ï¼Œå¯åŠ¨é¡¹ç›®æ—¶æˆ‘ä¸€ç›´æŠ¥é”™ï¼Œå„ç§è¸©å‘ï¼Œç²¾ç¥æŠ˜ç£¨/(ã„’oã„’)/~~ã€‚æ€»ç»“ä¸€ä¸‹ç¢°åˆ°äº†æ—¥å¿—ä¾èµ–ã€è¿æ¥è¶…æ—¶ã€curator-frameworkä¾èµ–ã€curator-recipesä¾èµ–çš„é—®é¢˜ã€‚

æˆ‘å‚è€ƒäº†å¦‚ä¸‹åšæ–‡ï¼š

- https://blog.csdn.net/wohaqiyi/article/details/81009689
- https://www.cnblogs.com/yaofengdoit/p/12215878.html
- https://blog.csdn.net/u013042707/article/details/79920824
- https://blog.csdn.net/u010938610/article/details/85318907

è¿™é‡Œç›´æ¥å°†æˆ‘çš„æœ€ç»ˆPOMæ–‡ä»¶è´´å‡ºæ¥ï¼Œä½†ä¸è§å¾—èƒ½è§£å†³ä½ çš„é—®é¢˜ï¼Œæ¯•ç«Ÿç‰ˆæœ¬å˜åŠ¨ä¹Ÿæ˜¯å¾ˆè¦å‘½çš„ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
   <modelVersion>4.0.0</modelVersion>
   <parent>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-parent</artifactId>
      <version>2.2.6.RELEASE</version>
      <relativePath/> <!-- lookup parent from repository -->
   </parent>
   <groupId>xuegao.learnSpringBoot.dubbo</groupId>
   <artifactId>provider-ticket</artifactId>
   <version>0.0.1-SNAPSHOT</version>
   <name>provider-ticket</name>
   <description>å–ç¥¨è€…</description>

   <properties>
      <java.version>11</java.version>
      <spring-boot.version>2.2.6.RELEASE</spring-boot.version>
      <dubbo.version>2.7.6</dubbo.version>
   </properties>

   <dependencyManagement>
      <dependencies>
         <!-- Spring Boot -->
         <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${spring-boot.version}</version>
            <type>pom</type>
            <scope>import</scope>
         </dependency>

         <!-- Apache Dubbo  -->
         <dependency>
            <groupId>org.apache.dubbo</groupId>
            <artifactId>dubbo-dependencies-bom</artifactId>
            <version>${dubbo.version}</version>
            <type>pom</type>
            <scope>import</scope>
         </dependency>

         <dependency>
            <groupId>org.apache.dubbo</groupId>
            <artifactId>dubbo</artifactId>
            <version>${dubbo.version}</version>
            <exclusions>
               <exclusion>
                  <groupId>org.springframework</groupId>
                  <artifactId>spring</artifactId>
               </exclusion>
               <exclusion>
                  <groupId>javax.servlet</groupId>
                  <artifactId>servlet-api</artifactId>
               </exclusion>
               <exclusion>
                  <groupId>log4j</groupId>
                  <artifactId>log4j</artifactId>
               </exclusion>
            </exclusions>
         </dependency>
      </dependencies>
   </dependencyManagement>

   <dependencies>
      <!-- Dubbo Spring Boot Starter -->
      <dependency>
         <groupId>org.apache.dubbo</groupId>
         <artifactId>dubbo-spring-boot-starter</artifactId>
         <version>2.7.6</version>
      </dependency>
      <dependency>
         <groupId>org.apache.dubbo</groupId>
         <artifactId>dubbo</artifactId>
      </dependency>
      <!--è¿™ä¸ªzkclientå’ŒåŸæ•™ç¨‹ä¸­çš„åº”è¯¥æ²¡ä»€ä¹ˆä¸åŒï¼Œä¸€å®šè¦æ’é™¤å®ƒå¯¹log4jã€slf4j-log4j12çš„ä¾èµ–ã€‚ https://mvnrepository.com/artifact/com.101tec/zkclient -->
      <dependency>
         <groupId>com.101tec</groupId>
         <artifactId>zkclient</artifactId>
         <version>0.11</version>
         <exclusions>
            <exclusion>
               <groupId>log4j</groupId>
               <artifactId>log4j</artifactId>
            </exclusion>
            <exclusion>
               <groupId>org.slf4j</groupId>
               <artifactId>slf4j-log4j12</artifactId>
            </exclusion>
         </exclusions>
      </dependency>

      <!--
      springbooté›†æˆdubboæ—¶å‡ºç°äº†java.lang.ClassNotFoundException: org.apache.curator.framework.CuratorFrameworkFactoryï¼Œ
      åŸå› æ˜¯ç¼ºå°‘curatorä¾èµ–ã€‚
      -->
      <!-- https://mvnrepository.com/artifact/org.apache.curator/curator-framework -->
      <dependency>
         <groupId>org.apache.curator</groupId>
         <artifactId>curator-framework</artifactId>
         <version>4.0.1</version>
      </dependency>
      <!--åŒæ—¶æ˜¯æŠ¥java.lang.ClassNotFoundExceptionã€‚ https://mvnrepository.com/artifact/org.apache.curator/curator-recipes -->
      <dependency>
         <groupId>org.apache.curator</groupId>
         <artifactId>curator-recipes</artifactId>
         <version>4.2.0</version>
      </dependency>

      <dependency>
         <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-web</artifactId>
      </dependency>

      <dependency>
         <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-test</artifactId>
         <scope>test</scope>
         <exclusions>
            <exclusion>
               <groupId>org.junit.vintage</groupId>
               <artifactId>junit-vintage-engine</artifactId>
            </exclusion>
         </exclusions>
      </dependency>
   </dependencies>

   <build>
      <plugins>
         <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
         </plugin>
      </plugins>
   </build>

</project>
```

ä¸ºTicketServiceImplç±»æ·»ä¸Šä¸¤ä¸ªæ³¨è§£ï¼š

```java
package xuegao.learnSpringBoot.dubbo.providerTicket.service;

import org.apache.dubbo.config.annotation.Service;
import org.springframework.stereotype.Component;

@Component//æ·»åŠ åˆ°Spring IOCå®¹å™¨ä¸­
@Service//å°†æœåŠ¡å‘å¸ƒå‡ºå»ï¼ˆæ³¨æ„è¿™æ˜¯Dubboçš„@Serviceæ³¨è§£ï¼‰
public class TicketServiceImpl implements TicketService{

    @Override
    public String getTicket() {
        return "ã€Šæµæµªåœ°çƒã€‹";
    }
}
```

åœ¨SpringBoot Profileä¸­é…ç½®dubboï¼š

```properties
#æŒ‡å®šæœ¬åº”ç”¨çš„åç§°
dubbo.application.name=provider-ticket
#å¡«å†™æ³¨å†Œä¸­å¿ƒçš„ä½ç½®
dubbo.registry.address=zookeeper://192.168.0.3:2181
#æŒ‡å®šè¦å‘å¸ƒçš„æœåŠ¡ï¼ˆæ‰«ææŒ‡å®šä½ç½®ä¸‹æœ‰çš„æœåŠ¡ï¼‰
dubbo.scan.base-packages=xuegao.learnSpringBoot.dubbo.providerTicket.service
#æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤è¶…æ—¶æ—¶é—´å¤ªçŸ­ï¼Œè€Œæˆ‘çš„æœåŠ¡å™¨åœ¨äº‘ç«¯ï¼Œä¸å¤Ÿå“åº”æ—¶é—´
dubbo.config-center.timeout=10000
```

æ­¤æ—¶ä½ å¯åŠ¨provider-ticketæ¨¡å—åº”è¯¥æ˜¯èƒ½æ­£å¸¸å¯åŠ¨çš„ã€‚

ç¡®è®¤èƒ½æ­£å¸¸å¯åŠ¨åå°†ç›®å…‰æ”¾åˆ°consumer-useræ¨¡å—ï¼Œå°†provider-ticketæ¨¡å—POMæ–‡ä»¶é‡Œpropertiesã€dependencyManagementã€dependenciesæ ‡ç­¾çš„å†…å®¹ç›´æ¥å¤åˆ¶è¿‡å»ã€‚

ç„¶åä¸ºconsumer-useræ¨¡å—çš„SpringBoot Profileæ·»åŠ è¿™ä¸‰è¡Œé…ç½®ï¼š

```properties
#æŒ‡å®šæœ¬åº”ç”¨çš„åç§°
dubbo.application.name=provider-ticket
#å¡«å†™æ³¨å†Œä¸­å¿ƒçš„ä½ç½®
dubbo.registry.address=zookeeper://192.168.0.3:2181
#æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤è¶…æ—¶æ—¶é—´å¤ªçŸ­ï¼Œè€Œæˆ‘çš„æœåŠ¡å™¨åœ¨äº‘ç«¯ï¼Œä¸å¤Ÿå“åº”æ—¶é—´
dubbo.config-center.timeout=10000
```

ä¸ºäº†è®©xuegao.learnSpringBoot.dubbo.consumerUser.service.UserServiceèƒ½æ¶ˆè´¹åˆ°xuegao.learnSpringBoot.dubbo.providerTicket.service.TicketServiceçš„ç¥¨ç¥¨ï¼Œéœ€è¦å°†TicketServiceæœ¬èº«ä»¥å…¨ç±»åçš„æ–¹å¼å¤åˆ¶åˆ°consumer-useræ¨¡å—ä¸­å»ï¼š

![image-20200501020201387](SpringBootAdvanced.assets\image-20200501020201387.png)

é€šè¿‡@Referenceæ³¨è§£åœ¨UserServiceç±»è¿œç¨‹å¼•ç”¨TicketServiceï¼š

```java
package xuegao.learnSpringBoot.dubbo.consumerUser.service;

import org.apache.dubbo.config.annotation.Reference;
import org.springframework.stereotype.Service;
import xuegao.learnSpringBoot.dubbo.providerTicket.service.TicketService;

@Service//è¿™å›ä½¿ç”¨Springçš„@Serviceï¼Œå°†æœ¬ç»„ä»¶æ·»åŠ åˆ°Spring IOCå®¹å™¨ä¸­
public class UserService {

    @Reference//è¿œç¨‹å¼•ç”¨æ³¨è§£
    TicketService ticketService;

    public void getTicket(){
        String ticket = ticketService.getTicket();
        System.out.println("å¾—åˆ°ç¥¨äº†ï¼š"+ticket);
    }
}
```

åœ¨consumer-useræ¨¡å—çš„å•å…ƒæµ‹è¯•ä¸­æµ‹è¯•æ˜¯å¦èƒ½è¿œç¨‹è°ƒç”¨æˆåŠŸï¼š

```java
package xuegao.learnSpringBoot.dubbo.consumerUser;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;
import xuegao.learnSpringBoot.dubbo.consumerUser.service.UserService;

import javax.annotation.Resource;

@SpringBootTest
class ConsumerUserApplicationTests {
   @Resource(name = "userService")
   UserService userService;

   @Test
   void contextLoads() {
      userService.getTicket();
   }

}
```

è¿è¡Œæµ‹è¯•åçš„æ§åˆ¶å°è¾“å‡ºï¼š

```shell
å¾—åˆ°ç¥¨äº†ï¼šã€Šæµæµªåœ°çƒã€‹
```

è¿™æ ·å°±æˆåŠŸäº†ï¼Œæˆ‘çœ‹åˆ°å¼¹å¹•ä¸Šæœ‰äººè¯´ï¼šâ€œproviderå°‘äº†ä¸€å±‚apiçš„åŒ…â€ã€‚äº‹å®ä¸Šè€å¸ˆä¹Ÿç¡®å®å¯¹Dubboæ•™çš„å¾ˆæµ…ï¼Œæˆ‘è§‰å¾—å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£è¿›è¡Œè¿›ä¸€æ­¥å­¦ä¹ ã€‚å› ä¸ºæ˜¯é˜¿é‡Œå·´å·´å¼€å‘çš„ï¼Œæ‰€ä»¥ä¸­æ–‡æ–‡æ¡£è¿˜æ˜¯å¾ˆé¦™çš„ï¼šhttp://dubbo.apache.org/zh-cn/docs/user/quick-start.htmlã€‚

## 6.4 SpringCloud-Eurekaæ³¨å†Œä¸­å¿ƒ

**SpringCloudï¼š**

Spring Cloudæ˜¯ä¸ªåˆ†å¸ƒå¼çš„æ•´ä½“è§£å†³æ–¹æ¡ˆã€‚Spring Cloud ä¸ºå¼€å‘è€…æä¾›äº†åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆé…ç½®ç®¡ç†ã€æœåŠ¡å‘ç°ã€ç†”æ–­ã€è·¯ç”±ã€å¾®ä»£ç†ã€æ§åˆ¶æ€»çº¿ã€ä¸€æ¬¡æ€§tokenã€å…¨å±€é”ã€leaderé€‰ä¸¾ã€åˆ†å¸ƒå¼sessionã€é›†ç¾¤çŠ¶æ€ï¼‰ä¸­å¿«é€Ÿæ„å»ºçš„å·¥å…·ï¼Œä½¿ç”¨Spring Cloudçš„å¼€å‘è€…å¯ä»¥å¿«é€Ÿçš„å¯åŠ¨æœåŠ¡æˆ–æ„å»ºåº”ç”¨ã€åŒæ—¶èƒ½å¤Ÿå¿«é€Ÿå’Œäº‘å¹³å°èµ„æºè¿›è¡Œå¯¹æ¥ã€‚

SpringCloudåˆ†å¸ƒå¼å¼€å‘äº”å¤§å¸¸ç”¨ç»„ä»¶ï¼š

- æœåŠ¡å‘ç°â€”â€”Netflix Eureka
- å®¢æœç«¯è´Ÿè½½å‡è¡¡â€”â€”Netflix Ribbon
- æ–­è·¯å™¨â€”â€”Netflix Hystrix
- æœåŠ¡ç½‘å…³â€”â€”Netflix Zuul
- åˆ†å¸ƒå¼é…ç½®â€”â€”Spring Cloud Config

**æ­å»ºé¡¹ç›®ï¼š**

åˆ›å»ºç©ºå·¥ç¨‹ï¼š

![image-20200428211617411](SpringBootAdvanced.assets\image-20200428211617411.png)

å¡«å†™é¡¹ç›®åï¼š

![image-20200501232220653](SpringBootAdvanced.assets\image-20200501232220653.png)

æ–°å»ºSpringBootæ¨¡å—ï¼š

![image-20200501232457869](SpringBootAdvanced.assets\image-20200501232457869.png)

ä½œä¸ºSpringCloud-Eurekaæ³¨å†Œä¸­å¿ƒï¼š

![image-20200501234726135](SpringBootAdvanced.assets\image-20200501234726135.png)

æ·»åŠ Eureka Serveråœºæ™¯ä¾èµ–ï¼Œä»è€Œä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼š

![image-20200501235000105](SpringBootAdvanced.assets\image-20200501235000105.png)

æ¨¡å—ååŠä½ç½®ï¼š

![image-20200501235107227](SpringBootAdvanced.assets\image-20200501235107227.png)

å®Œæˆåå†åˆ›å»ºä¸ªæ¨¡å—ï¼Œåä¸ºprovider-ticketï¼š

![image-20200501235827622](SpringBootAdvanced.assets\image-20200501235827622.png)

è¿™å›ä¾èµ–çš„æ˜¯Eureka Discovery Clientï¼Œä»è€Œå»è¿æ¥æ³¨å†Œä¸­å¿ƒï¼ˆè¯¥å›¾å°‘äº†Spring Webåœºæ™¯ï¼‰ï¼š

![image-20200502000159674](SpringBootAdvanced.assets\image-20200502000159674.png)

å†æ¥åˆ›å»ºæœåŠ¡æ¶ˆè´¹è€…æ¨¡å—ï¼š

![image-20200502003430798](SpringBootAdvanced.assets\image-20200502003430798.png)

åŒæ ·ä¹Ÿæ˜¯æ·»åŠ Eureka Discovery Clientï¼Œä»è€Œå»è¿æ¥æ³¨å†Œä¸­å¿ƒï¼ˆè¯¥å›¾å°‘äº†Spring Webåœºæ™¯ï¼‰ï¼š

![image-20200502003602712](SpringBootAdvanced.assets\image-20200502003602712.png)

**é…ç½®æ³¨å†Œä¸­å¿ƒï¼š**

consumer-userå’Œprovider-ticketæ¨¡å—éœ€è¦æœ‰æ³¨å†Œä¸­å¿ƒæ‰èƒ½è¿è½¬ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°†eureka-serveræ¨¡å—å¯åŠ¨ï¼Œä½†æ˜¯å¯åŠ¨å‰éœ€è¦å…ˆå¯¹eureka-serveræ¨¡å—åšä¸€äº›é…ç½®ã€‚

äºapplication.yamlæ–‡ä»¶é…ç½®EurekaServerï¼š

```yaml
server:
  port: 8761

eureka:
  instance:
    hostname: eureka-server #æœ¬eurekaå®ä¾‹çš„ä¸»æœºå
  client:
    register-with-eureka: false #ä¸å°†æœ¬æ¨¡å—æ·»åŠ â€œæ³¨å†Œä¸­å¿ƒâ€ï¼Œå› ä¸ºè‡ªå·±å°±æ˜¯â€œæ³¨å†Œä¸­å¿ƒâ€ã€‚
    fetch-registry: false #ä¸ä»â€œæ³¨å†Œä¸­å¿ƒâ€é‡Œè·å–æœåŠ¡çš„æ³¨å†Œä¿¡æ¯ï¼Œå› ä¸ºè‡ªå·±å°±æ˜¯â€œæ³¨å†Œä¸­å¿ƒâ€ã€‚
    #é…ç½®â€œæ³¨å†Œä¸­å¿ƒâ€çš„æ³¨å†Œåœ°å€
    service-url:
      defaultZone: http://localhost:8761/eureka #é»˜è®¤ä¸ºhttp://localhost:8761/defaultZone
```

è¿˜éœ€è¦åœ¨ä¸»é…ç½®ç±»æ³¨è§£@EnableEurekaServeræ¥å¯ç”¨â€œæ³¨å†Œä¸­å¿ƒâ€åŠŸèƒ½ï¼š

```java
package xuegao.learnSpringBoot.springCloud.eurekaServer;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

/**
 * æœ¬æ¨¡å—ä¸ºSpringCloud-Eurekaæ³¨å†Œä¸­å¿ƒã€‚
 * æ³¨å†Œä¸­å¿ƒçš„ä½¿ç”¨æ–¹æ³•ï¼š
 *     ä¸€ã€é…ç½®EurekaServer
 *     äºŒã€ä½¿ç”¨@EnableEurekaServerå¯ç”¨â€œæ³¨å†Œä¸­å¿ƒâ€åŠŸèƒ½
 * */
@EnableEurekaServer//å¯ç”¨â€œæ³¨å†Œä¸­å¿ƒâ€åŠŸèƒ½
@SpringBootApplication
public class EurekaServerApplication {

   public static void main(String[] args) {
      SpringApplication.run(EurekaServerApplication.class, args);
   }

}
```

å¯åŠ¨eureka-serveræ¨¡å—ï¼Œåœ¨æµè§ˆå™¨è®¿é—®http://localhost:8761/ï¼Œè¿™é‡Œå±•ç¤ºäº†eureka-serverå®ä¾‹çš„çŠ¶æ€ï¼š

![image-20200502014307769](SpringBootAdvanced.assets\image-20200502014307769.png)

## 6.5 æ³¨å†ŒæœåŠ¡

åœ¨provider-ticketæ¨¡å—åˆ›å»ºè¿™ä¸¤ä¸ªç±»ï¼š

```java
package xuegao.learnSpringBoot.springCloud.providerTicket.service;

import org.springframework.stereotype.Service;

@Service
public class TicketService {
    public String getTicket(){
        return "ã€Šå”äººè¡—æ¢æ¡ˆ3ã€‹";
    }
}
```

```java
package xuegao.learnSpringBoot.springCloud.providerTicket.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import xuegao.learnSpringBoot.springCloud.providerTicket.service.TicketService;
import javax.annotation.Resource;

@RestController
public class TicketController {
    @Resource(name = "ticketService")
    TicketService ticketService;

    @GetMapping("getTicket")
    public String getTicket(){
        return ticketService.getTicket();
    }
}
```

äºæœ¬æ¨¡å—çš„application.yamlé…ç½®æœ¬åº”ç”¨ï¼š

```yaml
server:
  port: 8001 #provider-ticketçš„ç«¯å£

spring:
  application:
    name: provider-ticket #æœ¬åº”ç”¨çš„åç§°

eureka:
  instance:
    prefer-ip-address: true #ä½¿ç”¨IPåœ°å€æ¥è¿æ¥åˆ°â€æ³¨å†Œä¸­å¿ƒâ€œ
  client:
    register-with-eureka: true #å°†æœ¬æ¨¡å—æ·»åŠ â€œæ³¨å†Œä¸­å¿ƒâ€œ
    fetch-registry: true #ä»â€œæ³¨å†Œä¸­å¿ƒâ€é‡Œè·å–æœåŠ¡çš„æ³¨å†Œä¿¡æ¯
    service-url:
      defaultZone: http://localhost:8761/eureka  #â€œæ³¨å†Œä¸­å¿ƒâ€çš„æ³¨å†Œåœ°å€
```

ç¡®ä¿eureka-serveræ¨¡å—å·²å¯åŠ¨åå†å¯åŠ¨æœ¬æ¨¡å—ï¼Œç„¶åè®¿é—®http://localhost:8761/å°±èƒ½çœ‹åˆ°è¯¥åº”ç”¨çš„å‡ºç°ï¼š

<img src="SpringBootAdvanced.assets/image-20200504203814988.png" alt="image-20200504203814988" style="zoom:80%;" />

è®¿é—®http://localhost:8001/getTicketåº”è¯¥èƒ½å¾—åˆ°ç”µå½±ç¥¨ï¼š

![image-20200504204122050](SpringBootAdvanced.assets/image-20200504204122050.png)

**è¸©å‘æé†’ï¼š**

å½“æ²¡æœ‰é…ç½®contextPathçš„æ—¶ï¼ŒæœåŠ¡ç«¯é…ç½®çš„eureka.client.serviceUrl.defaultZoneå’Œå®¢æˆ·ç«¯æ˜¯ä¸€æ ·ï¼Œä¸”å¿…é¡»ä¸ºï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ä¸èƒ½æ¢ï¼Œå³ä½¿æ¢æˆä¸€æ ·çš„ä¹Ÿä¸è¡Œï¼‰:

```properties
eureka.client.serviceUrl.defaultZone= http://localhost:8761/eureka/
```

å¦‚æœé…ç½®äº†contextPathï¼Œé‚£ä¹ˆå°±è¦å°†æœåŠ¡ç«¯é…ç½®çš„contextPathåï¼ŒåŠ åˆ°å®¢æˆ·ç«¯çš„defaultZoneçš„è®¿é—®è·¯å¾„ç«¯å£å·åé¢ï¼š

- ä¾‹å¦‚åœ¨æœåŠ¡ç«¯åšè¿™æ ·çš„é…ç½®ï¼š

  ```properties
  server.context-path=/pancake
  ```

- é‚£ä¹ˆå®¢æˆ·ç«¯å°±è¦è¿™æ ·é…ç½®ï¼š

  ```properties
  eureka.client.serviceUrl.defaultZone=http://localhost:8763/pancake/eureka/
  ```

**åŒåº”ç”¨ï¼Œå¤šå®ä¾‹ï¼š**

ä¿®æ”¹xuegao.learnSpringBoot.springCloud.providerTicket.service.TicketServiceç±»çš„getTicketæ–¹æ³•ï¼Œæ·»åŠ printlnè¯­å¥ï¼š

```java
public class TicketService {
    public String getTicket(){
        System.out.println("provider-ticketåº”ç”¨ï¼Œäº8001ç«¯å£ã€‚");
        return "ã€Šå”äººè¡—æ¢æ¡ˆ3ã€‹";
    }
}
```

æ‰“åŒ…provider-ticketæ¨¡å—ï¼š

![image-20200504205437065](SpringBootAdvanced.assets/image-20200504205437065.png)

å°†æ‰“åŒ…å¥½çš„jaråŒ…é‡å‘½åä¸ºprovider-ticket-0.0.1-SNAPSHOT-8001port.jarï¼ˆåå­—éšä¾¿å–ï¼‰ï¼š

![image-20200504210052784](SpringBootAdvanced.assets/image-20200504210052784.png)

ä¿®æ”¹xuegao.learnSpringBoot.springCloud.providerTicket.service.TicketServiceç±»çš„getTicketæ–¹æ³•ï¼š

```java
public class TicketService {
    public String getTicket(){
        System.out.println("provider-ticketåº”ç”¨ï¼Œäº8002ç«¯å£ã€‚");
        return "ã€Šå”äººè¡—æ¢æ¡ˆ3ã€‹";
    }
}
```

ä¿®æ”¹provider-ticketæ¨¡å—çš„ç«¯å£å·ä¸º8002ï¼š

```yaml
server:
  port: 8002 #provider-ticketçš„ç«¯å£
```

é‡æ–°æ‰“åŒ…æœ¬æ¨¡å—ï¼Œå°†æ–°ç”Ÿæˆçš„jaråŒ…é‡åä¸ºprovider-ticket-0.0.1-SNAPSHOT-8002port.jarï¼ˆåå­—éšä¾¿å–ï¼‰ï¼š

![image-20200504210447158](SpringBootAdvanced.assets/image-20200504210447158.png)

é€šè¿‡ç»ˆç«¯åˆ†åˆ«å°†ä¸¤è€…éƒ½å¯åŠ¨èµ·æ¥ï¼ˆä½¿ç”¨ä¸¤ä¸ªçª—å£åˆ†åˆ«å¯åŠ¨ï¼‰ï¼š

```shell
java -jar provider-ticket-0.0.1-SNAPSHOT-8001port.jar
```

```shell
java -jar provider-ticket-0.0.1-SNAPSHOT-8002port.jar
```

è®¿é—®http://localhost:8761/æŸ¥çœ‹ï¼Œèƒ½å‘ç°provider-ticketåº”ç”¨æ‹¥æœ‰äº†å¤šä¸ªå®ä¾‹ï¼š

![image-20200504211627332](SpringBootAdvanced.assets/image-20200504211627332.png)

## 6.6 æœåŠ¡å‘ç°å’Œæ¶ˆè´¹

é…ç½®consumer-useræ¨¡å—ï¼š

```yaml
server:
  port: 8200 #æœ¬åº”ç”¨çš„ç«¯å£

spring:
  application:
    name: consumer-user #æœ¬åº”ç”¨çš„åç§°

eureka:
  instance:
    prefer-ip-address: true #ä½¿ç”¨IPåœ°å€æ¥è¿æ¥åˆ°â€æ³¨å†Œä¸­å¿ƒâ€œ
  client:
    register-with-eureka: true #å°†æœ¬åº”ç”¨æ·»åŠ â€œæ³¨å†Œä¸­å¿ƒâ€œ
    fetch-registry: true #ä»â€œæ³¨å†Œä¸­å¿ƒâ€é‡Œè·å–æœåŠ¡çš„æ³¨å†Œä¿¡æ¯
    service-url:
      defaultZone: http://localhost:8761/eureka/  #â€œæ³¨å†Œä¸­å¿ƒâ€çš„æ³¨å†Œåœ°å€
```

äºconsumer-useræ¨¡å—çš„ä¸»é…ç½®ç±»å¼€å¯â€œå‘ç°æœåŠ¡â€åŠŸèƒ½ï¼Œå¹¶å‘IOCå®¹å™¨æ·»åŠ RestTemplateï¼Œç”¨å®ƒæ¥å‘é€httpè¯·æ±‚ï¼š

```java
package xuegao.learnSpringBoot.springCloud.consumerUser;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@EnableDiscoveryClient//å¼€å¯å‘ç°æœåŠ¡åŠŸèƒ½ï¼Œæ¶ˆè´¹ç±»å‹çš„åº”ç”¨éœ€è¦ä½¿ç”¨è¯¥æ³¨è§£ï¼Œæ‰èƒ½æ¶ˆè´¹â€œæ³¨å†Œä¸­å¿ƒâ€ä¸­çš„æœåŠ¡ã€‚
@SpringBootApplication
public class ConsumerUserApplication {

   public static void main(String[] args) {
      SpringApplication.run(ConsumerUserApplication.class, args);
   }

   //RestTemplateå¯ä»¥ç”¨æ¥å¸®åŠ©æˆ‘ä»¬å‘é€httpè¯·æ±‚
   @LoadBalanced//å¯ç”¨è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œå‘é€httpè¯·æ±‚çš„æ—¶å€™å¯ä»¥ç”¨åˆ°ã€‚å½“åŒä¸ªåº”ç”¨æœ‰å¤šä¸ªå®ä¾‹æ—¶ï¼Œä¼šé›¨éœ²å‡æ²¾çš„ä½¿ç”¨å¤šä¸ªå®ä¾‹çš„èµ„æºã€‚
   @Bean
   public RestTemplate restTemplate(){
         return new RestTemplate();
   }
}
```

åˆ›å»ºUserControllerï¼Œé€šè¿‡URLæ¶ˆè´¹æœåŠ¡ï¼š

```java
package xuegao.learnSpringBoot.springCloud.consumerUser.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import javax.annotation.Resource;

@RestController
public class UserController {
    @Resource(name = "restTemplate")
    RestTemplate restTemplate;

    @GetMapping("buyTicket")
    public String buyTicket(String name){
        //é€šè¿‡URLå¾—åˆ°å¯¹è±¡ï¼ŒæŒ‡å®šä¸ºStringç±»å‹ï¼Œä¸éœ€è¦æŒ‡å®šæœåŠ¡çš„ä¸»æœºä½ç½®åŠç«¯å£å·ã€‚
        String ticket = restTemplate.getForObject("http://PROVIDER-TICKET/getTicket", String.class);

        return name+"è´­ä¹°äº†"+ticket;
    }
}
```

å¯åŠ¨consumer-useræ¨¡å—ï¼ŒæŸ¥çœ‹ä¸€ä¸‹åº”ç”¨ä»¬æ˜¯å¦éƒ½å¼€å¯äº†ï¼š

![image-20200504234109514](SpringBootAdvanced.assets/image-20200504234109514.png)

é€šè¿‡è®¿é—®http://localhost:8200/buyTicketæ¶ˆè´¹æœåŠ¡ï¼Œå¯ä»¥å¸¦ä¸Šnameï¼š

![image-20200504234306377](SpringBootAdvanced.assets/image-20200504234306377.png)

ä¸€è¾¹åˆ·æ–°ç½‘å€ï¼Œä¸€è¾¹è§‚å¯ŸConsoleçš„è¾“å‡ºæƒ…å†µï¼Œä½ ä¼šå‘ç°provider-ticketçš„ä¸¤ä¸ªå®ä¾‹ä¼šä¾æ¬¡è¢«ä½¿ç”¨ï¼Œè€Œä¸ä¼šæŸä¸ªå®ä¾‹è¢«ç–¯ç‹‚ä½¿ç”¨ï¼Œè€Œå…¶å®ƒçš„å†·å†·æ¸…æ¸…ã€æ— äººé—®æ´¥ï¼š

![image-20200504234739089](SpringBootAdvanced.assets/image-20200504234739089.png)

![image-20200504234751510](SpringBootAdvanced.assets/image-20200504234751510.png)

# ä¸ƒã€çƒ­éƒ¨ç½²

## 7.1 devtoolså¼€å‘çƒ­éƒ¨ç½²

ä¹‹å‰åœ¨å¼€å‘ä¸­ä¿®æ”¹Javaæ–‡ä»¶åï¼Œä¸å¾—ä¸é‡å¯åº”ç”¨æ‰èƒ½çœ‹åˆ°æ•ˆæœï¼Œè¿™æµªè´¹äº†å¤§é‡çš„æ—¶é—´ã€‚æˆ‘ä»¬å¸Œæœ›ä¸é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œç¨‹åºå¯ä»¥è‡ªåŠ¨éƒ¨ç½²ï¼ˆçƒ­éƒ¨ç½²ï¼‰ã€‚ä¸‹é¢å°†è®²è§£å››ç§çƒ­éƒ¨ç½²æ–¹æ³•ï¼š

1. æ¨¡æ¿å¼•æ“ï¼ˆJSPã€Thymeleafç­‰ï¼‰ï¼š

   1. é¦–å…ˆåœ¨Spring Bootä¸­å¼€å‘æƒ…å†µä¸‹ç¦ç”¨æ¨¡æ¿å¼•æ“çš„cacheã€‚
   2. ç¼–è¾‘é¡µé¢åï¼Œä½¿ç”¨Ctrl+F9æˆ–æŒ‰å³ä¸Šè§’çš„å°é”¤å­å¯ä»¥é‡æ–°ç¼–è¯‘å½“å‰é¡µé¢å¹¶ç”Ÿæ•ˆã€‚

2. Spring Loadedï¼š

   1. å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/qq_28056641/article/details/81292612 ã€‚

   2. Springå®˜æ–¹æä¾›çš„çƒ­éƒ¨ç½²ç¨‹åºï¼Œå®ç°ä¿®æ”¹ç±»æ–‡ä»¶çš„çƒ­éƒ¨ç½²ã€‚

   3. ä¸‹è½½Spring Loadedï¼ˆé¡¹ç›®åœ°å€https://github.com/spring-projects/spring-loadedï¼‰ã€‚

   4. æ·»åŠ runtimeå‚æ•°ï¼Œ`-javaagnet:`åå¡«çš„æ˜¯ä¸‹è½½çš„Spring Loadedæ–‡ä»¶è·¯å¾„ï¼š

      ```shell
      -javaagent:C:/springloaded-1.2.5.RELEASE.jar â€“noverify
      ```

3. JRebelï¼š

   1. æ”¶è´¹çš„çƒ­éƒ¨ç½²æ’ä»¶ï¼Œå®‰è£…è¯¥æ’ä»¶ä½¿ç”¨å³å¯ã€‚

4. Spring Boot Devtoolsï¼š

   1. å¼•å…¥ä¾èµ–ï¼š

      ```xml
      <dependency>  
             <groupId>org.springframework.boot</groupId>  
             <artifactId>spring-boot-devtools</artifactId>   
      </dependency> 
      ```

   2. IDEAä½¿ç”¨Build Projectï¼ˆCtrl+F9ï¼‰å³å¯å®ç°çƒ­éƒ¨ç½²ã€‚

   3. å¯ä»¥è®¾ç½®ä¸ºè‡ªåŠ¨ç¼–è¯‘ï¼š

      1. è®¾ç½®è‡ªåŠ¨ç¼–è¯‘ï¼ˆsettingsâ†’compilerâ†’build project automaticallyï¼‰ã€‚

      2. æŒ‰ctrl+shift+alt+/ï¼ˆmaintenanceå¿«æ·é”®ï¼‰ï¼Œå‹¾é€‰compiler.automake.allow.when.app.runningã€‚

         ![image-20200505015827991](SpringBootAdvanced.assets/image-20200505015827991.png)

      3. Intellij IEDAå’ŒEclipseä¸åŒï¼ŒEclipseè®¾ç½®äº†è‡ªåŠ¨ç¼–è¯‘ä¹‹åï¼Œä¿®æ”¹å†…å®¹åä¿å­˜å°±ä¼šè‡ªåŠ¨ç¼–è¯‘ï¼Œè€ŒIDEAåœ¨éRUNæˆ–DEBUGæƒ…å†µä¸‹æ‰ä¼šè‡ªåŠ¨ç¼–è¯‘ï¼ˆå‰ææ˜¯ä½ å·²ç»è®¾ç½®äº†Auto-Compileï¼‰ã€‚
      
   4. devtoolså¯èƒ½ä¼šå¼•èµ·ç±»Castå¼‚å¸¸ï¼š
   
      - å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/m0_38043362/article/details/78064539 ã€‚
      - ç®€è¦æ¥è¯´ï¼Œdevtoolsçƒ­éƒ¨ç½²ä¼šå¯¼è‡´ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½ç›¸åŒçš„ç±»ï¼Œå¯¼è‡´åŒä¸ªç±»è‡ªå·±è½¬è‡ªå·±æŠ¥é”™ï¼Œä¸é€‚ç”¨devtoolsæˆ–çŸ¥é“æ˜¯å“ªä¸ªJARåŒ…å¯¼è‡´çš„é—®é¢˜ï¼Œå¯ä»¥è‡ªå®šä¹‰é…ç½®ã€‚
   
   5. è¯·ä¸è¦åœ¨è¿è¡Œç¯å¢ƒä½¿ç”¨devtoolsï¼Œå®ƒåªåº”å½“ç”¨äºå¼€å‘ç¯å¢ƒã€‚

**ä½¿ç”¨Spring Boot Devtoolsï¼š**

é¦–å…ˆå‡†å¤‡ä¸ªé¡¹ç›®ï¼Œæˆ‘æ˜¯ä½¿ç”¨äº†ä¹‹å‰åˆ›å»ºè¿‡çš„spring_initializræ¥åšæµ‹è¯•ï¼Œä½ ç›´æ¥åˆ›å»ºä¸ªæ–°çš„ä¹Ÿä¸€æ ·ã€‚

è¿™ä¸ªHelloControlleré‡Œä¼šå“åº”/helloè¯·æ±‚ï¼Œå¹¶è¿”å›Hello Worldçš„å­—æ ·ï¼š

```java
package xuegao.springBoot.hello.spring_initializr.controller;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController {
    @RequestMapping("/hello")
    public String hello(){
        return "Hello World!";
    }
}
```

é‚£ä¹ˆå¯åŠ¨é¡¹ç›®ï¼Œç„¶ååœ¨æµè§ˆå™¨è®¿é—®éªŒè¯ï¼š

![image-20200505005804936](SpringBootAdvanced.assets/image-20200505005804936.png)

æ‰“å¼€é¡¹ç›®targetä¸‹å¯¹åº”çš„`.class`æ–‡ä»¶ï¼Œèƒ½çœ‹åˆ°@RequestMappingé‡Œçš„æ­£æ˜¯/helloï¼š

![image-20200505010038962](SpringBootAdvanced.assets/image-20200505010038962.png)

å€˜è‹¥å°†HelloController.javaé‡Œçš„è¯·æ±‚æ”¹ä¸º/hiå‘¢ï¼š

```java
public class HelloController {
    @RequestMapping("/hi")
    public String hello(){
        return "Hello World!";
    }
}
```

å½“ç„¶å¯¹åº”çš„`.class`ä¸ä¼šç«‹å³å‘ç”Ÿæ”¹å˜ï¼Œéœ€è¦æ‰‹åŠ¨ç‚¹å³ä¸Šè§’çš„ğŸ”¨æ‰èƒ½æœ‰æ•ˆæœï¼š

![image-20200505010400288](SpringBootAdvanced.assets/image-20200505010400288.png)

![image-20200505010448202](SpringBootAdvanced.assets/image-20200505010448202.png)

é‚£ä¹ˆå·²ç¼–è¯‘æ–‡ä»¶å˜æ›´ä¸º/hiè¯·æ±‚äº†åèƒ½åœ¨æµè§ˆå™¨ç”¨/hièƒ½å¾—åˆ°å“åº”å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸èƒ½ï¼š

![image-20200505010611473](SpringBootAdvanced.assets/image-20200505010611473.png)

æ°æ°ç›¸åï¼Œè¿˜æ˜¯åŸæ¥çš„/helloè¯·æ±‚æ‰èƒ½ç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´Build Projectå¹¶ä¸èƒ½å¯¹ä»¥è¿è¡Œçš„é¡¹ç›®åšæ›´æ”¹ã€‚

è¿™æ—¶å€™å°±éœ€è¦å¼•å…¥ DevToolså•¦ï¼ˆ[ç‚¹æˆ‘æŸ¥çœ‹2.2.6ç‰ˆçš„å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-boot/docs/2.2.6.RELEASE/reference/html/using-spring-boot.html#using-boot-devtools)ï¼‰ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-devtools</artifactId>
    <optional>true</optional>
</dependency>
```

é‡å¯é¡¹ç›®ï¼Œè¿™æ—¶è¯¥é¡¹ç›®å°±å…·æœ‰çƒ­éƒ¨ç½²èƒ½åŠ›å•¦ï¼Œä¾‹å¦‚æˆ‘å†å°†@RequestMapping("/hi")æ”¹ä¸º@RequestMapping("/hello")ï¼Œç„¶åç‚¹å‡»Build Projectå³å¯ã€‚è¿™æ—¶èƒ½åœ¨Consoleçœ‹åˆ°LiveReloadçš„æç¤ºï¼š

![image-20200505013708570](SpringBootAdvanced.assets/image-20200505013708570.png)

å¦å¤–æœ¬å·¥å…·ä¹Ÿå¯¹æ¨¡æ¿å¼•æ“é¡µé¢æœ‰æ•ˆã€‚

# å…«ã€ç›‘ç®¡

## 8.1 ç›‘ç®¡ç«¯ç‚¹æµ‹è¯•

**ç›‘æ§ç®¡ç†ï¼š**

é€šè¿‡å¼•å…¥spring-boot-starter-actuatorï¼Œå¯ä»¥ä½¿ç”¨Spring Bootæä¾›çš„å‡†ç”Ÿäº§ç¯å¢ƒä¸‹çš„åº”ç”¨ç›‘æ§å’Œç®¡ç†åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡HTTPï¼ŒJMXï¼ŒSSHåè®®æ¥è¿›è¡Œæ“ä½œï¼Œè‡ªåŠ¨å¾—åˆ°å®¡è®¡ã€å¥åº·åŠæŒ‡æ ‡ä¿¡æ¯ç­‰ã€‚

æ­¥éª¤ï¼š

1. å¼•å…¥spring-boot-starter-actuatorã€‚
2. é€šè¿‡httpæ–¹å¼è®¿é—®ç›‘æ§ç«¯ç‚¹ã€‚
3. å¯è¿›è¡Œshutdownï¼ˆPOST æäº¤ï¼Œæ­¤ç«¯ç‚¹é»˜è®¤å…³é—­ï¼‰ã€‚

**åˆ›å»ºé¡¹ç›®ï¼š**

æ–°å»ºactuatorå·¥ä»¶ï¼š

![image-20200506010351962](SpringBootAdvanced.assets/image-20200506010351962.png)

æ·»åŠ åœºæ™¯ï¼Œé™¤äº†Actuatorå¤–ï¼ŒDevToolsç”¨äºçƒ­éƒ¨ç½²ï¼ŒSpring Webæ–¹ä¾¿æµ‹è¯•ï¼š

![image-20200506010652800](SpringBootAdvanced.assets/image-20200506010652800.png)

é¡¹ç›®åï¼š

![image-20200506011023716](SpringBootAdvanced.assets/image-20200506011023716.png)

**ç›‘ç®¡ç«¯ç‚¹æµ‹è¯•ï¼š**

ç›´æ¥å¯åŠ¨é¡¹ç›®ï¼Œè§‚å¯ŸConsoleçš„è¾“å‡ºï¼š

![image-20200506011628871](SpringBootAdvanced.assets/image-20200506011628871.png)å›¾ä¸­æˆ‘é«˜äº®çš„éƒ¨åˆ†è¯´æ˜ä¸€ä¸‹ï¼šactuator2.0ç‰ˆæœ¬ä¹‹åå¿…é¡»åŠ /actuatoræ‰å¯ä»¥è®¿é—®ï¼Œä¸”é»˜è®¤åªæš´éœ²healthå’Œinfoï¼Œè¿™å’ŒåŸæ•™ç¨‹ä¸­çš„1.0ç³»åˆ—ç‰ˆæœ¬æœ‰æ‰€ä¸åŒã€‚

è®¿é—®/actuator/healthå¾—åˆ°çš„å“åº”ï¼š

```json
{
  "status": "UP"
}
```

è®¿é—®/actuator/infoå¾—åˆ°çš„å“åº”å†…å®¹ç›®å‰è¿˜æ˜¯ä¸ºç©ºçš„ï¼š

```json
{}
```

é…ç½®ä¸ºå…¬å¼€ï¼ˆæš´éœ²ï¼‰æ‰€æœ‰ç›‘æ§ï¼Œä»¥åŠæ˜¾ç¤ºhealthæ–¹æ³•çš„å…·ä½“å†…å®¹ï¼š

```properties
#å…¬å¼€æ‰€æœ‰ç›‘æ§
management.endpoints.web.exposure.include=*
#æ˜¾ç¤ºhealthæ–¹æ³•çš„å…·ä½“å†…å®¹ï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼‰
management.endpoint.health.show-details=always
```

é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œç›´æ¥è®¿é—®actuatorä¼šè¿”å›å¤§é‡çš„ç½‘å€é“¾æ¥ï¼Œå¯ä»¥ç›´æ¥ç‚¹è¿›å»æŸ¥çœ‹ï¼š

![image-20200511235158885](SpringBootAdvanced.assets/image-20200511235158885.png)

å„ç«¯ç‚¹çš„ç”¨å¤„ï¼š

| **ç«¯ç‚¹å**   | **æè¿°**                    |
| ------------ | --------------------------- |
| *autoconfig* | æ‰€æœ‰è‡ªåŠ¨é…ç½®ä¿¡æ¯            |
| auditevents  | å®¡è®¡äº‹ä»¶                    |
| beans        | æ‰€æœ‰Beançš„ä¿¡æ¯              |
| configprops  | æ‰€æœ‰é…ç½®å±æ€§                |
| dump         | çº¿ç¨‹çŠ¶æ€ä¿¡æ¯                |
| env          | å½“å‰ç¯å¢ƒä¿¡æ¯                |
| loggers      | æ—¥å¿—ä¿¡æ¯                    |
| health       | åº”ç”¨å¥åº·çŠ¶å†µ                |
| heapdump     | ä¸‹è½½å†…å­˜å¿«ç…§                |
| info         | å½“å‰åº”ç”¨ä¿¡æ¯                |
| metrics      | åº”ç”¨çš„å„é¡¹æŒ‡æ ‡              |
| mappings     | åº”ç”¨@RequestMappingæ˜ å°„è·¯å¾„ |
| shutdown     | å…³é—­å½“å‰åº”ç”¨ï¼ˆé»˜è®¤å…³é—­ï¼‰    |
| trace        | è¿½è¸ªä¿¡æ¯ï¼ˆæœ€æ–°çš„httpè¯·æ±‚ï¼‰  |

æŸ¥çœ‹healthé¡µé¢ï¼Œstatusä¸ºUPè¡¨ç¤ºæœåŠ¡å·²ä¸Šçº¿ï¼š

![image-20200511235445955](SpringBootAdvanced.assets/image-20200511235445955.png)

beansæ˜¯ç”¨æ¥ç›‘æ§å®¹å™¨ä¸­çš„ç»„ä»¶æƒ…å†µï¼š

![image-20200511235646870](SpringBootAdvanced.assets/image-20200511235646870.png)

infoç”¨äºæŸ¥çœ‹å½“å‰åº”ç”¨ä¿¡æ¯ï¼Œå¯ä»¥åœ¨Spring Profileä¸­é…ç½®infoå¼€å¤´çš„é…ç½®ï¼ŒSpring Actuatorå°±ä¼šæ”¶é›†è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡infoç«¯ç‚¹è·å–è¿™äº›ä¿¡æ¯ï¼š

```properties
#å¡«å†™infoå¼€å¤´çš„é…ç½®ï¼ŒSpring Actuatorå°±ä¼šæ”¶é›†è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡infoç«¯ç‚¹è·å–è¿™äº›ä¿¡æ¯
info.app.id=123456789
info.app.version=1.0.0
```

![image-20200512000359071](SpringBootAdvanced.assets/image-20200512000359071.png)

åªè¦æ˜¯ç»§æ‰¿äºorg.springframework.boot.info.InfoPropertiesçš„é…ç½®éƒ½èƒ½å‡ºç°åœ¨è¿™é‡Œï¼Œä¾‹å¦‚org.springframework.boot.info.GitPropertieså°±ç»§æ‰¿äº†å®ƒã€‚Gitå¯ç”¨git.propertiesè¿›è¡Œé…ç½®

![image-20200512090702396](SpringBootAdvanced.assets/image-20200512090702396.png)

```properties
#git.propertieså¯ä»¥ç”¨æ¥é…ç½®Git
    #åˆ†æ”¯ä¸ºmaster
    git.branch=master
    #æäº¤IDä¸ºxuegao
    git.commit.id=xuegao
    #æäº¤æ—¶é—´ä¸º2020-5-12 8:59:50
    git.commit.time=2020-5-12 8:59:50
```

é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œè®¿é—®infoç«¯ç‚¹å°±èƒ½æŸ¥çœ‹åˆ°gitçš„ä¿¡æ¯ï¼š

![image-20200512090821222](SpringBootAdvanced.assets/image-20200512090821222.png)

è®¿é—®heapdumpä¼šä¸‹è½½å½“å‰é¡¹ç›®çš„å†…å­˜å¿«ç…§ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¿«é€Ÿå®šä½é—®é¢˜ï¼š

![image-20200512092043143](SpringBootAdvanced.assets/image-20200512092043143.png)

![image-20200512092155233](SpringBootAdvanced.assets/image-20200512092155233.png)

è®¿é—®mappingsèƒ½æŸ¥çœ‹é¡¹ç›®çš„æ˜ å°„è·¯å¾„ï¼š

![image-20200512092707101](SpringBootAdvanced.assets/image-20200512092707101.png)

è®¿é—®metricsç«¯ç‚¹èƒ½æŸ¥çœ‹å½“å‰é¡¹ç›®çš„ç›‘æ§æŒ‡æ ‡ï¼š

```json
{
  "names": [
    "jvm.threads.states",
    "jvm.gc.pause",
    "http.server.requests",
    "jvm.gc.memory.promoted",
    "jvm.memory.max",
    "jvm.memory.used",
    "jvm.gc.max.data.size",
    "jvm.memory.committed",
    "system.cpu.count",
    "logback.events",
    "jvm.buffer.memory.used",
    "tomcat.sessions.created",
    "jvm.threads.daemon",
    "system.cpu.usage",
    "jvm.gc.memory.allocated",
    "tomcat.sessions.expired",
    "jvm.threads.live",
    "jvm.threads.peak",
    "process.uptime",
    "tomcat.sessions.rejected",
    "process.cpu.usage",
    "jvm.classes.loaded",
    "jvm.classes.unloaded",
    "tomcat.sessions.active.current",
    "tomcat.sessions.alive.max",
    "jvm.gc.live.data.size",
    "jvm.buffer.count",
    "jvm.buffer.total.capacity",
    "tomcat.sessions.active.max",
    "process.start.time"
  ]
}
```

è®¿é—®envèƒ½æŸ¥çœ‹é¡¹ç›®çš„è¿è¡Œç¯å¢ƒä¿¡æ¯ï¼š

![image-20200512093713899](SpringBootAdvanced.assets/image-20200512093713899.png)

configpropsç«¯ç‚¹è¿”å›çš„æ˜¯æ¯ä¸ªé…ç½®å±æ€§çš„ä¿¡æ¯æŠ¥å‘Šã€‚ä»¥è¿™æ®µä¸ºä¾‹ï¼Œprefixæ˜¯é…ç½®å‰ç¼€ï¼Œpropertiesä¸­çš„æ˜¯å¯é…ç½®é¡¹ï¼š

```json
"healthEndpointProperties": {
    "prefix": "management.endpoint.health",
    "properties": {
        "showDetails": "ALWAYS",
        "status": {
            "order": [],
            "httpMapping": {}
        },
        "roles": [],
        "group": {}
    }
},
```

ä¹‹å‰å°±å·²ç»å°†healthç«¯ç‚¹çš„å†…å®¹è®¾ä¸ºæ€»æ˜¯æ˜¾ç¤ºç»†èŠ‚ï¼š

```properties
#æ˜¾ç¤ºhealthæ–¹æ³•çš„å…·ä½“å†…å®¹ï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼‰
management.endpoint.health.show-details=always
```

è‹¥è¦ä½¿ç”¨è¿œç¨‹å…³é—­ï¼Œå¯ä»¥åœ¨SpringBoot Profileä¸­å¯ç”¨è¿œç¨‹å…³é—­åŠŸèƒ½ï¼š

```properties
#å¯ç”¨è¿œç¨‹å…³é—­ï¼Œéœ€è¦ç”¨POSTæ–¹å¼æäº¤è¯·æ±‚
management.endpoint.shutdown.enabled=true
```

ä»¥POSTæ–¹å¼æäº¤è¯·æ±‚ï¼Œæ”¶åˆ°æ¶ˆæ¯â€œShutting down, bye...â€ï¼š

![image-20200512220738469](SpringBootAdvanced.assets/image-20200512220738469.png)

çœ‹é¡¹ç›®çš„æ§åˆ¶å°ä¹Ÿèƒ½çœ‹åˆ°è¿™æ ·çš„è¾“å‡ºï¼š

```shell
2020-05-12 22:06:01.162  INFO 8392 --- [      Thread-13] o.s.s.concurrent.ThreadPoolTaskExecutor  : Shutting down ExecutorService 'applicationTaskExecutor'
```

## 8.2 å®šåˆ¶ç«¯ç‚¹

ä¸ºä»€ä¹ˆè¦å®šåˆ¶ç«¯ç‚¹ï¼Ÿä¸ºäº†å®‰å…¨ï¼Œå¦‚æœéƒ½æ˜¯ä¸€æ ·çš„è®¿é—®ç«¯å£å’Œè·¯å¾„åï¼Œé‚£ä¹ˆæ•æ„Ÿä¿¡æ¯å°†éå¸¸å®¹æ˜“æš´éœ²ã€‚

**å®šåˆ¶æ–¹æ³•ï¼š**

å®šåˆ¶ç«¯ç‚¹ä¸€èˆ¬é€šè¿‡endpoints+ç«¯ç‚¹å+å±æ€§åæ¥è®¾ç½®ã€‚

ä¿®æ”¹ç«¯ç‚¹idï¼ˆendpoints.beans.id=mybeansï¼‰

å¼€å¯è¿œç¨‹åº”ç”¨å…³é—­åŠŸèƒ½ï¼ˆendpoints.shutdown.enabled=trueï¼‰

å…³é—­ç«¯ç‚¹ï¼ˆendpoints.beans.enabled=falseï¼‰

å¼€å¯æ‰€éœ€ç«¯ç‚¹ï¼š

- endpoints.enabled=false
- endpoints.beans.enabled=true

å®šåˆ¶ç«¯ç‚¹è®¿é—®æ ¹è·¯å¾„ï¼š

- management.context-path=/manage

å…³é—­httpç«¯ç‚¹ï¼š

- management.port=-1

**å®ä¾‹ï¼š**

åŸæ•™ç¨‹ä¸­æåˆ°äº†endpoints.beans.idçš„é…ç½®é¡¹ï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬ä¸­å·²ç»ä¸å†å¯è‡ªå®šä¹‰ï¼š

```properties
#endpointsæ ‡è¯†ç¬¦ä¸å†å¯è‡ªå®šä¹‰
endpoints.beans.id=myBean
```

ä½†æ˜¯æ˜ å°„è·¯å¾„è¿˜æ˜¯å¯ä»¥é…ç½®çš„ï¼š

```properties
#è‡ªå®šä¹‰beansçš„æ˜ å°„è·¯å¾„
management.endpoints.web.path-mapping.beans=bean
```

![image-20200512231003013](SpringBootAdvanced.assets/image-20200512231003013.png)

è‡ªå®šä¹‰äº†beansç«¯ç‚¹çš„æ˜ å°„è·¯å¾„åï¼Œbeanså°±ä¸èƒ½å†è®¿é—®äº†ï¼Œåªèƒ½é€šè¿‡è‡ªå·±é…ç½®çš„è·¯å¾„è¿›è¡Œè®¿é—®ï¼š

![image-20200512231109310](SpringBootAdvanced.assets/image-20200512231109310.png)

å¯ä»¥å¼€å¯æˆ–å…³é—­æŒ‡å®šç«¯ç‚¹ï¼š

```properties
#æ˜¯å¦å¯ç”¨beansç«¯ç‚¹
management.endpoint.beans.enabled=false
```

å¯ä»¥ç›´æ¥è®¾ç½®å…¨éƒ¨ç«¯ç‚¹çš„å¼€å¯æƒ…å†µï¼Œä¸”èƒ½å†æŒ‡å®šæŸäº›ç«¯ç‚¹çš„çŠ¶æ€ï¼š

```properties
#æ˜¯å¦å¯ç”¨æ‰€æœ‰ç«¯ç‚¹ï¼Œè‹¥å…ˆå…³é—­ï¼ˆfalseï¼‰æ‰€æœ‰ç«¯ç‚¹ï¼Œå†æŒ‡å®šå¯ç”¨æŸäº›ç«¯ç‚¹ï¼Œé‚£ä¹ˆå°±åªæœ‰è¿™äº›è¢«å¯ç”¨çš„ç«¯ç‚¹èƒ½è®¿é—®
management.endpoints.enabled-by-default=false
#æ˜¯å¦å¯ç”¨beansç«¯ç‚¹
management.endpoint.beans.enabled=true
```

è¿™æ—¶å°±åªæœ‰å¯¥å¯¥å‡ ä¸ªç«¯ç‚¹èƒ½è®¿é—®äº†ï¼ˆå‰é¢å¯ç”¨äº†è¿œç¨‹å…³é—­ç«¯ç‚¹ï¼‰ï¼š

![image-20200512232348378](SpringBootAdvanced.assets/image-20200512232348378.png)

å®šåˆ¶è®¿é—®ç«¯ç‚¹å’Œæ ¹è·¯å¾„ï¼š

```properties
#å®šåˆ¶è®¿é—®ç«¯å£ï¼Œå¯ä¸å†å’Œé¡¹ç›®å…±ç”¨ç«¯å£ã€‚è‹¥è®¾ä¸º-1ï¼Œç”±äºå…¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å°†ä¸èƒ½å†é€šè¿‡ä»»ä½•ç«¯å£è®¿é—®ä»»ä½•ç«¯ç‚¹
management.server.port=8181
#å®šåˆ¶ç«¯ç‚¹è®¿é—®çš„æ ¹è·¯å¾„ï¼Œé»˜è®¤ä¸ºactuatorï¼Œè¿™é‡Œå¥½åƒæ²¡ç”Ÿæ•ˆ
management.server.servlet.context-path=/management
```

è¿™æ—¶å°±éœ€è¦è®¿é—®http://localhost:8181/management/actuatoræ‰èƒ½å¾—åˆ°æ¶ˆæ¯äº†ï¼š

```json
{
    "_links": {
        "self": {
            "href": "http://localhost:8181/management/actuator",
            "templated": false
        },
        "beans": {
            "href": "http://localhost:8181/management/actuator/bean",
            "templated": false
        },
        "shutdown": {
            "href": "http://localhost:8181/management/actuator/shutdown",
            "templated": false
        }
    }
}
```

## 8.3 è‡ªå®šä¹‰HealthIndicator

åœ¨é¡¹ç›®çš„External Librariesç›®å½•ä¸­æ‰¾åˆ°healthï¼Œå…¶ä¸‹é¢æœ‰å¾ˆå¤šå¥åº·ç›‘æ§åŠŸèƒ½ï¼š

![image-20200513093417881](SpringBootAdvanced.assets/image-20200513093417881.png)

ä¸è¿‡åœ¨æ–°ç‰ˆæœ¬ä¸­å…³äºå…¶å®ƒå·¥å…·çš„å¥åº·éƒ½æ”¾åˆ°å¤–é¢äº†ï¼š

![image-20200513232620520](SpringBootAdvanced.assets/image-20200513232620520.png)

ä¾‹å¦‚ä¸ºé¡¹ç›®æ·»åŠ Rediså¯åŠ¨å™¨ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

åœ¨SpringBoot Proflieé…ç½®ä¸ªæ— æ•ˆçš„Redisè¿æ¥åœ°å€ï¼š

```properties
spring.redis.host=localhost
```

é‡å¯é¡¹ç›®ï¼Œè®¿é—®healthç«¯ç‚¹å°±èƒ½çœ‹åˆ°å‡ºç°äº†Redisç›¸å…³çš„å¥åº·çŠ¶æ€ï¼š

```json
{
  "status": "DOWN",
  "components": {
    "diskSpace": {
      "status": "UP",
      "details": {
        "total": 157475139584,
        "free": 98831974400,
        "threshold": 10485760
      }
    },
    "ping": {
      "status": "UP"
    },
    "redis": {
      "status": "DOWN",
      "details": {
        "error": "org.springframework.data.redis.RedisConnectionFailureException: Unable to connect to Redis; nested exception is io.lettuce.core.RedisConnectionException: Unable to connect to localhost:6379"
      }
    }
  }
}
```

é…ç½®ä¸ºæ­£ç¡®çš„è¿æ¥åœ°å€ï¼š

```properties
spring.redis.host=192.168.0.3
spring.redis.password=password
```

å†æ¬¡è®¿é—®healthç«¯ç‚¹ï¼š

```json
{
  "status": "UP",
  "components": {
    "diskSpace": {
      "status": "UP",
      "details": {
        "total": 157475139584,
        "free": 98831966208,
        "threshold": 10485760
      }
    },
    "ping": {
      "status": "UP"
    },
    "redis": {
      "status": "UP",
      "details": {
        "version": "6.0.1"
      }
    }
  }
}
```

**è‡ªå®šä¹‰å¥åº·çŠ¶æ€æ˜¾ç¤ºå™¨ï¼š**

ç¼–å†™æŒ‡ç¤ºå™¨ï¼Œéœ€å®ç°HealthIndicatoræ¥å£ï¼ˆæŒ‡ç¤ºå™¨çš„ç±»åçš„åç¼€å¿…é¡»ä¸ºHealthIndicatorï¼Œä¸”æŒ‡ç¤ºå™¨ç±»å¿…é¡»åŠ å…¥å®¹å™¨ï¼‰ï¼š

```java
package xuegao.learnSpringBoot.actuator.healthIndicator;

import org.springframework.boot.actuate.health.Health;
import org.springframework.boot.actuate.health.HealthIndicator;
import org.springframework.stereotype.Component;

@Component//åŠ å…¥å®¹å™¨
public class myAppHealthIndicator implements HealthIndicator {
    //SpringBoot 2.2.0å¼€å§‹å¯ç”¨çš„getHealthæ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®æ˜¯å¦æ˜¾ç¤ºç»†èŠ‚çš„å…¥å‚æ¥é…ç½®ä¸åŒçš„è¿”å›ä¿¡æ¯
    @Override
    public Health getHealth(boolean includeDetails) {
        return Health.up().withDetail("message","æœåŠ¡å·²æ­£å¸¸è¿è¡Œ").build();
    }

    //æ—§çš„å¥åº·æ–¹æ³•
    @Override
    public Health health() {

        return null;
    }
}
```

è®¿é—®æ•ˆæœï¼š

```json
{
  "status": "UP",
  "components": {
    "diskSpace": {
      "status": "UP",
      "details": {
        "total": 157475139584,
        "free": 98831450112,
        "threshold": 10485760
      }
    },
    "myApp": {
      "status": "UP",
      "details": {
        "message": "æœåŠ¡å·²æ­£å¸¸è¿è¡Œ"
      }
    },
    "ping": {
      "status": "UP"
    },
    "redis": {
      "status": "UP",
      "details": {
        "version": "6.0.1"
      }
    }
  }
}
```

# å‚è€ƒæ–‡çŒ®ï¼š

- ã€Šå²ä¸Šå·¨å‘eurekaæ³¨å†Œï¼Œå‡ºç°TransportExceptionå¼‚å¸¸ã€‹ã€‚ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œç¨‹åºå‘˜ç™½å°ç™½ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/qq_35221138/article/details/81016171ã€‚
- ã€Šwas unable to refresh its cache! status = Cannot execute request on any known serverã€‹ã€‚æ— ç‰ˆæƒå£°æ˜ã€‚åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/mbshqqb/article/details/79568450ã€‚
